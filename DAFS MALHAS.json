[
{
  "model": "desktop.document2",
  "pk": 162943,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "DAFS MALHAS",
    "description": "",
    "uuid": "a1edcfdb-36e1-4f4d-bc6d-d99e2481e8a0",
    "type": "directory",
    "connector": null,
    "data": "{}",
    "extra": "",
    "search": null,
    "last_modified": "2025-10-12T14:17:40.508",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a8280168-7cf2-40b1-bc5d-733014ae6ba9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 162944,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "MLH: 2 Criação das Tbls",
    "description": "",
    "uuid": "afa27dba-0ab8-6cc5-9fab-aeabad7698c8",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 162944, \"uuid\": \"7cfc5990-dc20-4626-aa18-90d522783dfc\", \"name\": \"MLH: 2 Cria\\u00e7\\u00e3o das Tbls\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"afa27dba-0ab8-6cc5-9fab-aeabad7698c8\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"cfe41d8b-46ee-ab35-22af-a98e2b13dbf7\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 1681, \"column\": 17}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"usr_sat_malha_trans\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- SISTEMA DE MONITORAMENTO E GEST\\u00c3O DE MALHAS FISCAIS - DAFs V2.0\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: TABELAS FUNDAMENTAIS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.1. CAT\\u00c1LOGO DE TIPOS DE INCONSIST\\u00caNCIAS\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_catalogo_tipos_inconsistencia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    t.cd_inconsistencia,\\r\\n    t.nm_inconsistencia,\\r\\n    t.cd_tipo_infracao,\\r\\n    \\r\\n    -- Status e Visibilidade\\r\\n    CAST(t.sn_ativa AS STRING) AS flag_tipo_ativo,\\r\\n    t.cd_visibilidade,\\r\\n    t.cd_forma_regularizacao,\\r\\n    \\r\\n    -- Valores de Corte\\r\\n    t.vl_individual_min AS valor_minimo_malha,\\r\\n    t.vl_mensal_min AS valor_mensal_minimo,\\r\\n    t.nu_per_ini AS periodo_inicio_vigencia,\\r\\n    \\r\\n    -- Impactos\\r\\n    t.sn_regularidade_ttd AS flag_impacta_regularidade,\\r\\n    t.sn_dashboard AS flag_aparece_dashboard,\\r\\n    CAST(t.sn_bloqueada AS STRING) AS flag_tipo_bloqueado,\\r\\n    t.de_bloqueada AS motivo_bloqueio,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o por Natureza da Inconsist\\u00eancia\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o%' OR t.nm_inconsistencia LIKE '%n\\u00e3o escriturada%' \\r\\n        THEN 'OMISSAO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Cr\\u00e9dito indevido%' OR t.nm_inconsistencia LIKE '%Cr\\u00e9dito Indevido%'\\r\\n        THEN 'CREDITO_INDEVIDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%menor que%' OR t.nm_inconsistencia LIKE '%D\\u00e9bito de ICMS declarado na EFD menor%'\\r\\n        THEN 'DIVERGENCIA_VALOR_MENOR'\\r\\n        WHEN t.nm_inconsistencia LIKE '%maior que%'\\r\\n        THEN 'DIVERGENCIA_VALOR_MAIOR'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Saldo%'\\r\\n        THEN 'DIVERGENCIA_SALDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%cancelad%' OR t.nm_inconsistencia LIKE '%inexistente%'\\r\\n        THEN 'DOCUMENTO_INVALIDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Estorno%'\\r\\n        THEN 'ESTORNO_IRREGULAR'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS natureza_inconsistencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o por Gravidade Presumida\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Cr\\u00e9dito indevido%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%n\\u00e3o escriturada%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%cancelad%' THEN 'MEDIA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%menor que%' THEN 'MEDIA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%maior que%' THEN 'BAIXA'\\r\\n        ELSE 'MEDIA'\\r\\n    END AS gravidade_presumida,\\r\\n    \\r\\n    -- Flag se tem valor monet\\u00e1rio associado\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o de entrega%' THEN 0\\r\\n        ELSE 1\\r\\n    END AS flag_tem_valor_fiscal,\\r\\n    \\r\\n    -- Metadados\\r\\n    t.dt_publicacao,\\r\\n    t.dt_inclusao,\\r\\n    t.dt_alteracao,\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha_trans.mlh_incons_tipo t;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.2. EMPRESAS NA MALHA FISCAL - BASE CONSOLIDADA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_empresas_base STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    ei.nu_cnpj,\\r\\n    ei.nu_cnpj_grupo,\\r\\n    ei.nu_cpf,\\r\\n    ei.nu_ie,\\r\\n    ei.id_equipe,\\r\\n    \\r\\n    -- Informa\\u00e7\\u00f5es Cadastrais\\r\\n    c.nm_razao_social,\\r\\n    c.nm_fantasia,\\r\\n    c.cd_sit_cadastral,\\r\\n    c.nm_sit_cadastral,\\r\\n    c.cd_reg_apuracao,\\r\\n    c.nm_reg_apuracao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Econ\\u00f4mica\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS cnae_divisao,\\r\\n    c.de_classe AS desc_cnae,\\r\\n    c.cd_secao AS secao_cnae,\\r\\n    c.de_secao AS desc_secao,\\r\\n    \\r\\n    -- Localiza\\u00e7\\u00e3o\\r\\n    c.cd_gerfe,\\r\\n    c.nm_gerfe,\\r\\n    c.cd_ges,\\r\\n    c.nm_ges,\\r\\n    c.cd_munic,\\r\\n    c.nm_munic,\\r\\n    c.cd_uf,\\r\\n    \\r\\n    -- Contador Respons\\u00e1vel\\r\\n    c.nu_cpf_cnpj_contador,\\r\\n    c.nm_contador,\\r\\n    c.nu_crc_contador,\\r\\n    c.dt_ini_relac_contador,\\r\\n    c.cd_munic_contador,\\r\\n    c.cd_uf_contador,\\r\\n    \\r\\n    -- Caracter\\u00edsticas da Empresa\\r\\n    c.cd_tipo_contribuinte,\\r\\n    c.nm_tipo_contribuinte,\\r\\n    c.cd_enq_empresa,\\r\\n    c.nm_enq_empresa,\\r\\n    c.cd_natureza_juridica,\\r\\n    c.nm_natureza_juridica,\\r\\n    c.sn_simples_nacional_rfb,\\r\\n    c.sn_dtec,\\r\\n    c.dt_credenciamento_dtec,\\r\\n    c.sn_suspensao_dfe,\\r\\n    c.dt_suspensao_dfe,\\r\\n    c.sn_matriz,\\r\\n    c.sn_apur_consolidada,\\r\\n    c.sn_estab_consolidado,\\r\\n    c.sn_estab_consolidador,\\r\\n    \\r\\n    -- V\\u00ednculos\\r\\n    c.qt_vinculos,\\r\\n    c.qt_vinculos_ativos,\\r\\n    c.qt_socios,\\r\\n    c.qt_socios_ativos,\\r\\n    \\r\\n    -- Agregados de Inconsist\\u00eancias\\r\\n    COUNT(DISTINCT ei.cd_inconsistencia) AS qtd_tipos_inconsistencia_historico,\\r\\n    SUM(ei.qt_incons_existentes) AS qtd_total_inconsistencias_historico,\\r\\n    SUM(ei.vl_incons_existentes) AS valor_total_inconsistencias_historico,\\r\\n    \\r\\n    -- Status Atual na Malha\\r\\n    MAX(CASE WHEN ei.dt_saiu_malha IS NULL THEN 1 ELSE 0 END) AS flag_atualmente_em_malha,\\r\\n    SUM(CASE WHEN ei.dt_saiu_malha IS NULL THEN ei.qt_incons_existentes ELSE 0 END) AS qtd_inconsistencias_ativas,\\r\\n    SUM(CASE WHEN ei.dt_saiu_malha IS NULL THEN ei.vl_incons_existentes ELSE 0 END) AS valor_inconsistencias_ativas,\\r\\n    \\r\\n    -- Datas\\r\\n    MIN(ei.dt_entrou_malha) AS dt_primeira_entrada_malha,\\r\\n    MAX(ei.dt_entrou_malha) AS dt_ultima_entrada_malha,\\r\\n    MAX(ei.dt_saiu_malha) AS dt_ultima_saida_malha,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha.mlh_empresa_incons ei\\r\\nINNER JOIN usr_sat_ods.vw_ods_contrib c ON ei.nu_cnpj = c.nu_cnpj\\r\\nGROUP BY \\r\\n    ei.nu_cnpj, ei.nu_cnpj_grupo, ei.nu_cpf, ei.nu_ie, ei.id_equipe,\\r\\n    c.nm_razao_social, c.nm_fantasia, c.cd_sit_cadastral, c.nm_sit_cadastral,\\r\\n    c.cd_reg_apuracao, c.nm_reg_apuracao,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5), SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2),\\r\\n    c.de_classe, c.cd_secao, c.de_secao,\\r\\n    c.cd_gerfe, c.nm_gerfe, c.cd_ges, c.nm_ges, c.cd_munic, c.nm_munic, c.cd_uf,\\r\\n    c.nu_cpf_cnpj_contador, c.nm_contador, c.nu_crc_contador, c.dt_ini_relac_contador,\\r\\n    c.cd_munic_contador, c.cd_uf_contador,\\r\\n    c.cd_tipo_contribuinte, c.nm_tipo_contribuinte, c.cd_enq_empresa, c.nm_enq_empresa,\\r\\n    c.cd_natureza_juridica, c.nm_natureza_juridica, c.sn_simples_nacional_rfb,\\r\\n    c.sn_dtec, c.dt_credenciamento_dtec, c.sn_suspensao_dfe, c.dt_suspensao_dfe,\\r\\n    c.sn_matriz, c.sn_apur_consolidada, c.sn_estab_consolidado, c.sn_estab_consolidador,\\r\\n    c.qt_vinculos, c.qt_vinculos_ativos, c.qt_socios, c.qt_socios_ativos;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.3. INCONSIST\\u00caNCIAS DETALHADAS - HIST\\u00d3RICO COMPLETO\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_inconsistencias_detalhadas STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    d.nu_cnpj,\\r\\n    d.nu_ie,\\r\\n    d.nu_per_ref,\\r\\n    d.nu_per_ref_identificado,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o da Inconsist\\u00eancia\\r\\n    d.cd_inconsistencia,\\r\\n    t.nm_inconsistencia,\\r\\n    t.natureza_inconsistencia,\\r\\n    t.gravidade_presumida,\\r\\n    t.flag_tem_valor_fiscal,\\r\\n    t.cd_tipo_infracao,\\r\\n    d.tx_chave_inconsistencia,\\r\\n    d.vl_inconsistencia,\\r\\n    \\r\\n    -- Ciclo de Vida\\r\\n    d.cd_situacao,\\r\\n    d.dt_identificada,\\r\\n    d.dt_entrou_malha,\\r\\n    d.dt_saiu_malha,\\r\\n    d.dt_resolvida_malha,\\r\\n    d.dt_em_fiscalizacao,\\r\\n    \\r\\n    -- Canal de Resolu\\u00e7\\u00e3o (PRINCIPAL M\\u00c9TRICA) - CORRIGIDO\\r\\n    CASE \\r\\n        -- 1. Resolvido autonomamente via DDE (melhor cen\\u00e1rio)\\r\\n        WHEN d.id_resolvido_dde IS NOT NULL THEN 'AUTONOMO_DDE'\\r\\n        \\r\\n        -- 2. Resolvido autonomamente via malha (retifica\\u00e7\\u00e3o)\\r\\n        WHEN d.dt_resolvida_malha IS NOT NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL \\r\\n             AND d.id_resolvido_dde IS NULL \\r\\n        THEN 'AUTONOMO_MALHA'\\r\\n        \\r\\n        -- 3. Exclu\\u00eddo por auditor (antes de ir para fiscaliza\\u00e7\\u00e3o)\\r\\n        WHEN d.dt_saiu_malha IS NOT NULL \\r\\n             AND d.dt_resolvida_malha IS NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL \\r\\n             AND d.id_resolvido_dde IS NULL\\r\\n             AND d.dt_em_fiscalizacao IS NULL\\r\\n        THEN 'EXCLUSAO_AUDITOR'\\r\\n        \\r\\n        -- 4. Em fiscaliza\\u00e7\\u00e3o (PAF aberto, mas sem autua\\u00e7\\u00e3o ainda)\\r\\n        WHEN d.dt_em_fiscalizacao IS NOT NULL \\r\\n             AND d.nu_infracao IS NULL\\r\\n             AND d.dt_saiu_malha IS NULL\\r\\n        THEN 'EM_FISCALIZACAO'\\r\\n        \\r\\n        -- 5. Fiscaliza\\u00e7\\u00e3o conclu\\u00edda (passou por PAF, pode ter sido resolvida ou autuada)\\r\\n        WHEN d.cd_motivo_resolvido_fiscal IS NOT NULL \\r\\n             OR d.nu_infracao IS NOT NULL\\r\\n        THEN 'FISCALIZACAO_CONCLUIDA'\\r\\n        \\r\\n        -- 6. Ativa (ainda no prazo de regulariza\\u00e7\\u00e3o - N\\u00c3O \\u00c9 PROBLEMA)\\r\\n        WHEN d.dt_entrou_malha IS NOT NULL \\r\\n             AND d.dt_saiu_malha IS NULL \\r\\n             AND d.dt_em_fiscalizacao IS NULL\\r\\n        THEN 'ATIVA'\\r\\n        \\r\\n        -- 7. Apenas identificada (ainda n\\u00e3o entrou na malha)\\r\\n        ELSE 'IDENTIFICADA'\\r\\n    END AS canal_resolucao,\\r\\n    \\r\\n    -- Subcanal detalhado para fiscaliza\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN d.nu_infracao IS NOT NULL THEN 'FISCALIZACAO_COM_AUTUACAO'\\r\\n        WHEN d.cd_motivo_resolvido_fiscal IS NOT NULL AND d.nu_infracao IS NULL THEN 'FISCALIZACAO_SEM_AUTUACAO'\\r\\n        WHEN d.dt_em_fiscalizacao IS NOT NULL AND d.nu_infracao IS NULL THEN 'FISCALIZACAO_EM_ANDAMENTO'\\r\\n        ELSE NULL\\r\\n    END AS subcanal_fiscalizacao,\\r\\n    \\r\\n    -- Detalhes da Resolu\\u00e7\\u00e3o\\r\\n    d.cd_motivo_resolvido_fiscal,\\r\\n    d.id_resolvido_dde,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    d.id_pacote,\\r\\n    d.nu_os,\\r\\n    d.nu_infracao,\\r\\n    d.nu_notificacao,\\r\\n    d.sn_enviar_fisca,\\r\\n    \\r\\n    -- Processamento\\r\\n    d.id_exec_malha,\\r\\n    d.cd_tipo_execucao,\\r\\n    d.dt_processamento,\\r\\n    \\r\\n    -- Detalhes EFD vs NFe\\r\\n    d.id_efd,\\r\\n    d.nu_chave_efd,\\r\\n    d.vl_total_efd,\\r\\n    d.vl_icms_efd,\\r\\n    d.nu_chave_nfe,\\r\\n    d.vl_total_nfe,\\r\\n    d.vl_icms_nfe,\\r\\n    d.dt_cancelamento_nfe,\\r\\n    \\r\\n    -- Tempos (em dias)\\r\\n    DATEDIFF(COALESCE(d.dt_saiu_malha, CURRENT_DATE()), d.dt_entrou_malha) AS dias_na_malha,\\r\\n    DATEDIFF(d.dt_resolvida_malha, d.dt_identificada) AS dias_ate_resolucao,\\r\\n    DATEDIFF(d.dt_em_fiscalizacao, d.dt_entrou_malha) AS dias_ate_fiscalizacao,\\r\\n    DATEDIFF(COALESCE(d.dt_saiu_malha, CURRENT_DATE()), d.dt_identificada) AS dias_ciclo_total,\\r\\n    \\r\\n    -- Flags de An\\u00e1lise\\r\\n    CASE \\r\\n        WHEN d.id_resolvido_dde IS NOT NULL OR \\r\\n             (d.dt_resolvida_malha IS NOT NULL AND d.cd_motivo_resolvido_fiscal IS NULL) \\r\\n        THEN 1 ELSE 0 \\r\\n    END AS flag_resolucao_autonoma,\\r\\n    \\r\\n    CASE \\r\\n        WHEN d.dt_saiu_malha IS NOT NULL AND d.dt_resolvida_malha IS NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL AND d.id_resolvido_dde IS NULL \\r\\n        THEN 1 ELSE 0 \\r\\n    END AS flag_exclusao_auditor,\\r\\n    \\r\\n    CASE WHEN d.nu_infracao IS NOT NULL THEN 1 ELSE 0 END AS flag_gerou_infracao,\\r\\n    \\r\\n    -- Tipo de Inconsist\\u00eancia Categorizado\\r\\n    CASE \\r\\n        WHEN d.nu_chave_nfe IS NOT NULL AND d.nu_chave_efd IS NULL THEN 'OMISSAO_NFE_NA_EFD'\\r\\n        WHEN d.nu_chave_efd IS NOT NULL AND d.nu_chave_nfe IS NULL THEN 'NOTA_FALSA_EFD'\\r\\n        WHEN d.nu_chave_nfe IS NOT NULL AND d.nu_chave_efd IS NOT NULL \\r\\n             AND ABS(d.vl_total_nfe - d.vl_total_efd) > 100 THEN 'DIVERGENCIA_VALOR'\\r\\n        WHEN d.dt_cancelamento_nfe IS NOT NULL THEN 'CANCELAMENTO_NAO_ESTORNADO'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS tipo_detalhado,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha.mlh_efd_nfe_incons d\\r\\nLEFT JOIN niat.mlh_catalogo_tipos_inconsistencia t ON d.cd_inconsistencia = t.cd_inconsistencia;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: AN\\u00c1LISE DE PERFORMANCE POR DIMENS\\u00d5ES\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.1. BENCHMARK POR TIPO DE INCONSIST\\u00caNCIA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_benchmark_tipo_inconsistencia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    cat.flag_tem_valor_fiscal,\\r\\n    \\r\\n    -- Contagens\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    COUNT(*) AS qtd_ocorrencias_total,\\r\\n    COUNT(DISTINCT id.nu_per_ref) AS qtd_periodos_geracao,\\r\\n    \\r\\n    -- Valores (quando aplic\\u00e1vel)\\r\\n    SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total,\\r\\n    AVG(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END) AS valor_medio,\\r\\n    STDDEV(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END) AS valor_desvio_padrao,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Canal de Resolu\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n    COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n    COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\\r\\n    \\r\\n    -- Taxas Esperadas (BENCHMARK)\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autonomia_esperada_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_exclusao_esperada_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Desvio Padr\\u00e3o das Taxas (para detectar anomalias)\\r\\n    STDDEV(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1.0 ELSE 0.0 END) AS desvio_taxa_exclusao,\\r\\n    \\r\\n    -- Tempo M\\u00e9dio de Resolu\\u00e7\\u00e3o\\r\\n    AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n    AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n    STDDEV(id.dias_na_malha) AS desvio_dias_malha,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Facilidade de Resolu\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.7 \\r\\n        THEN 'FACIL_RESOLUCAO'\\r\\n        WHEN COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.4 \\r\\n        THEN 'MEDIA_RESOLUCAO'\\r\\n        ELSE 'DIFICIL_RESOLUCAO'\\r\\n    END AS facilidade_resolucao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Legitimidade de Exclus\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.5 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) < 0.05\\r\\n        THEN 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA'\\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.3 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) < 0.1\\r\\n        THEN 'EXCLUSAO_MEDIA_ANALISAR'\\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.3 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.2\\r\\n        THEN 'EXCLUSAO_ALTA_SUSPEITA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS legitimidade_exclusao,\\r\\n    \\r\\n    -- Score de Efetividade do Tipo (0-100)\\r\\n    ROUND(\\r\\n        -- 40% baseado em autua\\u00e7\\u00f5es (quanto maior, mais efetivo)\\r\\n        (COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 40.0 / NULLIF(COUNT(*), 0)) +\\r\\n        -- 30% baseado em resolu\\u00e7\\u00e3o (autonoma OU fiscal)\\r\\n        ((COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) + \\r\\n          COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END)) * 30.0 / NULLIF(COUNT(*), 0)) +\\r\\n        -- 30% baseado em baixa exclus\\u00e3o injustificada\\r\\n        ((1 - (COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0))) * 30)\\r\\n    , 2) AS score_efetividade_tipo,\\r\\n    \\r\\n    -- Per\\u00edodos de Atividade\\r\\n    MIN(id.nu_per_ref) AS periodo_primeira_geracao,\\r\\n    MAX(id.nu_per_ref) AS periodo_ultima_geracao,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nINNER JOIN niat.mlh_inconsistencias_detalhadas id ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\nGROUP BY \\r\\n    cat.cd_inconsistencia, cat.nm_inconsistencia, cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida, cat.flag_tem_valor_fiscal\\r\\nHAVING COUNT(*) >= 10;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.2. PERFORMANCE DOS CONTADORES (FOCO EM AUTONOMIA)\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_performance_contadores STORED AS PARQUET AS\\r\\nWITH empresas_contador AS (\\r\\n    SELECT DISTINCT\\r\\n        eb.nu_cpf_cnpj_contador,\\r\\n        eb.nm_contador,\\r\\n        eb.nu_crc_contador,\\r\\n        eb.cd_munic_contador,\\r\\n        eb.cd_uf_contador,\\r\\n        eb.nu_cnpj\\r\\n    FROM niat.mlh_empresas_base eb\\r\\n    WHERE eb.nu_cpf_cnpj_contador IS NOT NULL\\r\\n),\\r\\ninconsistencias_contador AS (\\r\\n    SELECT\\r\\n        ec.nu_cpf_cnpj_contador,\\r\\n        ec.nm_contador,\\r\\n        ec.nu_crc_contador,\\r\\n        ec.cd_munic_contador,\\r\\n        ec.cd_uf_contador,\\r\\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_com_incons,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\\r\\n        \\r\\n        -- Por Canal de Resolu\\u00e7\\u00e3o (M\\u00c9TRICA CHAVE)\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma_total,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\\r\\n        \\r\\n        -- Por Natureza de Inconsist\\u00eancia\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'OMISSAO' THEN 1 END) AS qtd_omissao,\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'CREDITO_INDEVIDO' THEN 1 END) AS qtd_credito_indevido,\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'DIVERGENCIA_VALOR_MENOR' THEN 1 END) AS qtd_divergencia,\\r\\n        \\r\\n        -- Tipos Distintos\\r\\n        COUNT(DISTINCT id.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n        \\r\\n        -- Tempo\\r\\n        AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n        AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n        AVG(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN id.dias_ciclo_total END) AS media_dias_resolucao_fiscal\\r\\n        \\r\\n    FROM empresas_contador ec\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ec.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ec.nu_cpf_cnpj_contador, ec.nm_contador, ec.nu_crc_contador, \\r\\n             ec.cd_munic_contador, ec.cd_uf_contador\\r\\n)\\r\\nSELECT\\r\\n    ic.nu_cpf_cnpj_contador,\\r\\n    ic.nm_contador,\\r\\n    ic.nu_crc_contador,\\r\\n    ic.cd_munic_contador,\\r\\n    ic.cd_uf_contador,\\r\\n    \\r\\n    -- Carteira de Clientes\\r\\n    COUNT(DISTINCT ec.nu_cnpj) AS qtd_clientes_total,\\r\\n    ic.qtd_empresas_com_incons,\\r\\n    ROUND(ic.qtd_empresas_com_incons * 100.0 / NULLIF(COUNT(DISTINCT ec.nu_cnpj), 0), 2) AS taxa_clientes_com_incons_pct,\\r\\n    \\r\\n    -- Inconsist\\u00eancias\\r\\n    ic.qtd_total_inconsistencias,\\r\\n    ic.valor_total_inconsistencias,\\r\\n    ROUND(ic.valor_total_inconsistencias / NULLIF(ic.qtd_empresas_com_incons, 0), 2) AS valor_medio_por_empresa,\\r\\n    \\r\\n    -- Resolu\\u00e7\\u00e3o por Canal (FOCO PRINCIPAL)\\r\\n    ic.qtd_resolvidas_dde,\\r\\n    ic.qtd_resolvidas_malha_auto,\\r\\n    ic.qtd_resolucao_autonoma_total,\\r\\n    ic.qtd_resolvidas_fiscalizacao,\\r\\n    ic.qtd_excluidas_auditor,\\r\\n    ic.qtd_ativas,\\r\\n    ic.qtd_autuacoes,\\r\\n    \\r\\n    -- Taxas de Autonomia (M\\u00c9TRICA CHAVE)\\r\\n    ROUND(ic.qtd_resolucao_autonoma_total * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_autonomia_pct,\\r\\n    ROUND(ic.qtd_resolvidas_dde * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_resolucao_dde_pct,\\r\\n    ROUND(ic.qtd_ativas * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_pendencia_pct,\\r\\n    ROUND(ic.qtd_autuacoes * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_autuacao_pct,\\r\\n    ROUND(ic.qtd_excluidas_auditor * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Padr\\u00f5es de Inconsist\\u00eancias\\r\\n    ic.qtd_tipos_inconsistencia,\\r\\n    ic.qtd_omissao,\\r\\n    ic.qtd_credito_indevido,\\r\\n    ic.qtd_divergencia,\\r\\n    \\r\\n    -- Performance Temporal\\r\\n    ic.media_dias_malha,\\r\\n    ic.media_dias_resolucao_autonoma,\\r\\n    ic.media_dias_resolucao_fiscal,\\r\\n    \\r\\n    -- Score de Performance do Contador (0-100)\\r\\n    ROUND(\\r\\n        -- 50% baseado em autonomia (quanto mais resolve sozinho, melhor)\\r\\n        (ic.qtd_resolucao_autonoma_total * 50.0 / NULLIF(ic.qtd_total_inconsistencias, 0)) +\\r\\n        -- 30% baseado em baixa pend\\u00eancia (quanto menos pendente, melhor)\\r\\n        ((1 - (ic.qtd_ativas * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0))) * 30) +\\r\\n        -- 20% baseado em baixa autua\\u00e7\\u00e3o (quanto menos autua\\u00e7\\u00e3o, melhor)\\r\\n        ((1 - (ic.qtd_autuacoes * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0))) * 20)\\r\\n    , 2) AS score_performance,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Performance\\r\\n    CASE \\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'EXCELENTE_AUTONOMIA'\\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.5 \\r\\n        THEN 'BOA_AUTONOMIA'\\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.3 \\r\\n        THEN 'AUTONOMIA_REGULAR'\\r\\n        WHEN ic.qtd_autuacoes * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.3 \\r\\n        THEN 'ALTO_RISCO_AUTUACAO'\\r\\n        WHEN ic.qtd_ativas * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS classificacao_performance,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM inconsistencias_contador ic\\r\\nLEFT JOIN empresas_contador ec ON ic.nu_cpf_cnpj_contador = ec.nu_cpf_cnpj_contador\\r\\nGROUP BY \\r\\n    ic.nu_cpf_cnpj_contador, ic.nm_contador, ic.nu_crc_contador,\\r\\n    ic.cd_munic_contador, ic.cd_uf_contador,\\r\\n    ic.qtd_empresas_com_incons, ic.qtd_total_inconsistencias, ic.valor_total_inconsistencias,\\r\\n    ic.qtd_resolvidas_dde, ic.qtd_resolvidas_malha_auto, ic.qtd_resolucao_autonoma_total,\\r\\n    ic.qtd_resolvidas_fiscalizacao, ic.qtd_excluidas_auditor, ic.qtd_ativas, ic.qtd_autuacoes,\\r\\n    ic.qtd_tipos_inconsistencia, ic.qtd_omissao, ic.qtd_credito_indevido, ic.qtd_divergencia,\\r\\n    ic.media_dias_malha, ic.media_dias_resolucao_autonoma, ic.media_dias_resolucao_fiscal;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: TABELA 2.3 - PERFORMANCE DE DAFs (CORRIGIDA)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_performance_dafs;\\r\\n\\r\\nCREATE TABLE niat.mlh_performance_dafs STORED AS PARQUET AS\\r\\nWITH empresas_por_daf AS (\\r\\n    SELECT DISTINCT\\r\\n        eb.id_equipe,\\r\\n        eb.nu_cnpj\\r\\n    FROM niat.mlh_empresas_base eb\\r\\n    WHERE eb.id_equipe IS NOT NULL\\r\\n),\\r\\ninconsistencias_daf AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_acompanhadas,\\r\\n        COUNT(DISTINCT eb.nu_cpf_cnpj_contador) AS qtd_contadores_acompanhados,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\\r\\n        \\r\\n        -- Por Canal de Resolu\\u00e7\\u00e3o (CORRIGIDO - foco no que \\u00e9 PROBLEMA)\\r\\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO_CONCLUIDA' THEN 1 END) AS qtd_fiscalizacao_total,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'EM_FISCALIZACAO' THEN 1 END) AS qtd_em_fiscalizacao,\\r\\n        COUNT(CASE WHEN id.subcanal_fiscalizacao = 'FISCALIZACAO_COM_AUTUACAO' THEN 1 END) AS qtd_autuacoes,\\r\\n        COUNT(CASE WHEN id.subcanal_fiscalizacao = 'FISCALIZACAO_SEM_AUTUACAO' THEN 1 END) AS qtd_fiscalizacao_resolvida,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'IDENTIFICADA' THEN 1 END) AS qtd_identificadas,\\r\\n\\r\\n        -- Tipos\\r\\n        COUNT(DISTINCT id.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n        \\r\\n        -- Tempo\\r\\n        AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n        AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma\\r\\n        \\r\\n    FROM empresas_por_daf ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    LEFT JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n)\\r\\nSELECT\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    qtd_total_inconsistencias,\\r\\n    valor_total_inconsistencias,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Status (para entendimento do funil)\\r\\n    qtd_identificadas,\\r\\n    qtd_ativas,\\r\\n    qtd_resolucao_autonoma,\\r\\n    qtd_em_fiscalizacao,\\r\\n    qtd_fiscalizacao_total,\\r\\n    qtd_autuacoes,\\r\\n    qtd_excluidas_auditor,\\r\\n    \\r\\n    -- Taxas B\\u00e1sicas\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_autonomia_pct,\\r\\n    ROUND(qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_exclusao_pct,\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_autuacao_pct,\\r\\n    ROUND(qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_ativas_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- INDICADORES CORRIGIDOS - INTERPRETA\\u00c7\\u00c3O ADEQUADA DO FLUXO\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- 1. INDICADOR DE AUTONOMIA (quanto maior, melhor)\\r\\n    -- Empresas que resolvem sozinhas = EXCELENTE\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_autonomia_pct,\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.70 THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.50 THEN 'BOM'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.35 THEN 'REGULAR'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.20 THEN 'BAIXO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_autonomia_nivel,\\r\\n    \\r\\n    -- 2. INDICADOR DE ATIVAS (NEUTRO - n\\u00e3o \\u00e9 problema, \\u00e9 prazo normal)\\r\\n    -- Aqui s\\u00f3 monitoramos se est\\u00e1 muito alta (pode indicar lentid\\u00e3o)\\r\\n    ROUND(qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_ativas_pct,\\r\\n    CASE \\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 'NORMAL'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ATENCAO_VOLUME'\\r\\n        ELSE 'ALTO_VOLUME'\\r\\n    END AS ind_ativas_nivel,\\r\\n    \\r\\n    -- 3. INDICADOR DE FISCALIZA\\u00c7\\u00c3O (quanto MAIOR, PIOR - \\u00c9 O PROBLEMA!)\\r\\n    -- Inconsist\\u00eancias que precisaram de PAF = N\\u00c3O regularizaram no prazo\\r\\n    ROUND((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_fiscalizacao_pct,\\r\\n    CASE \\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'EXCELENTE'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'BOM'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.35 THEN 'REGULAR'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_fiscalizacao_nivel,\\r\\n    \\r\\n    -- 4. INDICADOR DE AUTUA\\u00c7\\u00c3O (quanto menor, melhor - \\u00e9 o mais grave)\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_autuacao_pct,\\r\\n    CASE \\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.05 THEN 'EXCELENTE'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'BOM'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'REGULAR'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_autuacao_nivel,\\r\\n    \\r\\n    -- 5. INDICADOR DE EXCLUS\\u00c3O (quanto menor, melhor - pode indicar problema)\\r\\n    ROUND(qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_exclusao_pct,\\r\\n    CASE \\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'EXCELENTE'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'BOM'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.35 THEN 'REGULAR'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_exclusao_nivel,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- M\\u00c9TRICAS ADICIONAIS IMPORTANTES\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Taxa de convers\\u00e3o: das que foram para fiscaliza\\u00e7\\u00e3o, quantas viraram autua\\u00e7\\u00e3o\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_fiscalizacao_total + qtd_em_fiscalizacao, 0), 2) AS taxa_conversao_fiscalizacao_autuacao,\\r\\n    \\r\\n    -- Taxa de efetividade: resolveram + autuaram (n\\u00e3o foram exclu\\u00eddas indevidamente)\\r\\n    ROUND((qtd_resolucao_autonoma + qtd_autuacoes) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_efetividade_geral,\\r\\n    \\r\\n    -- Taxa de necessidade de fiscaliza\\u00e7\\u00e3o (complemento da autonomia)\\r\\n    ROUND((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_necessidade_fiscalizacao,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- SCORES NUM\\u00c9RICOS (0-100) CORRIGIDOS\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Score de Autonomia (0-100): quanto maior, melhor\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS score_autonomia,\\r\\n    \\r\\n    -- Score de Fiscaliza\\u00e7\\u00e3o (0-100): invertido - quanto MENOS for para fiscaliza\\u00e7\\u00e3o, melhor\\r\\n    ROUND((1 - ((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0))) * 100, 2) AS score_fiscalizacao,\\r\\n    \\r\\n    -- Score de Exclus\\u00e3o (0-100): quanto menor exclus\\u00e3o, melhor\\r\\n    ROUND((1 - (qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0))) * 100, 2) AS score_exclusao,\\r\\n    \\r\\n    -- Score de Autua\\u00e7\\u00e3o (0-100): balanceado - queremos um meio termo\\r\\n    ROUND(\\r\\n        CASE \\r\\n            -- Ideal entre 5-15%: score m\\u00e1ximo (100)\\r\\n            WHEN CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) BETWEEN 0.05 AND 0.15 THEN 100.0\\r\\n            -- Acima de 15%: penaliza progressivamente\\r\\n            WHEN CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) > 0.15 \\r\\n            THEN GREATEST(0.0, 100.0 - ((CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) - 0.15) * 250.0))\\r\\n            -- Abaixo de 5%: penaliza levemente (pode indicar exclus\\u00e3o excessiva)\\r\\n            ELSE (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) * 2000.0)\\r\\n        END\\r\\n    , 2) AS score_autuacao,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- SCORE GERAL PONDERADO CORRIGIDO (0-100)\\r\\n    -- ========================================================================\\r\\n    ROUND(\\r\\n        -- 40% Autonomia (peso maior - \\u00e9 o ideal)\\r\\n        (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n        \\r\\n        -- 30% Baixa necessidade de Fiscaliza\\u00e7\\u00e3o (invertido - quanto MENOS fiscaliza\\u00e7\\u00e3o, melhor)\\r\\n        ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                  NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n        \\r\\n        -- 20% Baixa Autua\\u00e7\\u00e3o (invertido - quanto menos autua\\u00e7\\u00e3o, melhor)\\r\\n        ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n        \\r\\n        -- 10% Baixa Exclus\\u00e3o (invertido - quanto menos exclus\\u00e3o suspeita, melhor)\\r\\n        ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n    , 2) AS score_geral_ponderado,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- CLASSIFICA\\u00c7\\u00c3O GERAL CORRIGIDA\\r\\n    -- ========================================================================\\r\\n    CASE \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 80.0 THEN 'EXCELENTE'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 65.0 THEN 'BOM'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 50.0 THEN 'REGULAR'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 35.0 THEN 'ATENCAO'\\r\\n        \\r\\n        ELSE 'CRITICO'\\r\\n    END AS classificacao_geral,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- FLAGS DE ALERTA CORRIGIDAS\\r\\n    -- ========================================================================\\r\\n    CASE WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 1 ELSE 0 END AS flag_alerta_autonomia_baixa,\\r\\n    CASE WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.40 THEN 1 ELSE 0 END AS flag_alerta_fiscalizacao_alta,\\r\\n    CASE WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.25 THEN 1 ELSE 0 END AS flag_alerta_autuacao_alta,\\r\\n    CASE WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.40 THEN 1 ELSE 0 END AS flag_alerta_exclusao_alta,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM inconsistencias_daf\\r\\nWHERE qtd_total_inconsistencias >= 100;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: AN\\u00c1LISE DE EXCLUS\\u00d5ES E LEGITIMIDADE\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.1. AN\\u00c1LISE DE EXCLUS\\u00d5ES POR AUDITOR/DAF\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_analise_exclusoes_auditores STORED AS PARQUET AS\\r\\nWITH exclusoes_por_tipo AS (\\r\\n    SELECT\\r\\n        eb.id_equipe AS id_equipe_auditor,\\r\\n        id.cd_inconsistencia,\\r\\n        id.nm_inconsistencia,\\r\\n        ben.legitimidade_exclusao AS legitimidade_tipo,\\r\\n        ben.taxa_exclusao_esperada_pct,\\r\\n        \\r\\n        COUNT(*) AS qtd_inconsistencias_tipo,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_tipo,\\r\\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes_tipo\\r\\n    FROM niat.mlh_inconsistencias_detalhadas id\\r\\n    INNER JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\\r\\n    LEFT JOIN niat.mlh_benchmark_tipo_inconsistencia ben ON id.cd_inconsistencia = ben.cd_inconsistencia\\r\\n    WHERE eb.id_equipe IS NOT NULL\\r\\n    GROUP BY eb.id_equipe, id.cd_inconsistencia, id.nm_inconsistencia, \\r\\n             ben.legitimidade_exclusao, ben.taxa_exclusao_esperada_pct\\r\\n)\\r\\nSELECT\\r\\n    id_equipe_auditor,\\r\\n    \\r\\n    -- Totais\\r\\n    SUM(qtd_inconsistencias_tipo) AS qtd_total_inconsistencias,\\r\\n    SUM(qtd_excluidas_tipo) AS qtd_total_excluidas,\\r\\n    SUM(qtd_autuacoes_tipo) AS qtd_total_autuacoes,\\r\\n    \\r\\n    -- Taxa Geral de Exclus\\u00e3o\\r\\n    ROUND(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0), 2) AS taxa_exclusao_geral_pct,\\r\\n    \\r\\n    -- Exclus\\u00f5es por Legitimidade\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_legitimas,\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_suspeitas,\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_MEDIA_ANALISAR' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_analisar,\\r\\n    \\r\\n    -- Taxas Ajustadas\\r\\n    ROUND(SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 100.0 / \\r\\n          NULLIF(SUM(qtd_excluidas_tipo), 0), 2) AS taxa_exclusao_suspeita_pct,\\r\\n    \\r\\n    -- Desvio da Taxa Esperada (m\\u00e9dia ponderada)\\r\\n    ROUND(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n          AVG(taxa_exclusao_esperada_pct), 2) AS desvio_taxa_esperada,\\r\\n    \\r\\n    -- Score de Legitimidade das Exclus\\u00f5es (0-100)\\r\\n    ROUND(\\r\\n        -- 50% baseado em baixa exclus\\u00e3o suspeita\\r\\n        ((1 - (SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n               NULLIF(SUM(qtd_excluidas_tipo), 0))) * 50) +\\r\\n        -- 30% baseado em autua\\u00e7\\u00f5es (se exclui pouco e autua muito, \\u00e9 bom)\\r\\n        (SUM(qtd_autuacoes_tipo) * 30.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0)) +\\r\\n        -- 20% baseado em estar pr\\u00f3ximo da taxa esperada\\r\\n        (CASE \\r\\n            WHEN ABS(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n                     AVG(taxa_exclusao_esperada_pct)) < 10 THEN 20\\r\\n            WHEN ABS(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n                     AVG(taxa_exclusao_esperada_pct)) < 20 THEN 10\\r\\n            ELSE 0\\r\\n         END)\\r\\n    , 2) AS score_legitimidade,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.5 \\r\\n        THEN 'ALTA_SUSPEITA'\\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.3 \\r\\n        THEN 'MEDIA_SUSPEITA'\\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.7 \\r\\n        THEN 'EXCLUSOES_LEGITIMAS'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS classificacao_exclusoes,\\r\\n    \\r\\n    -- Tipos de Inconsist\\u00eancia Distintos\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM exclusoes_por_tipo\\r\\nGROUP BY id_equipe_auditor\\r\\nHAVING SUM(qtd_inconsistencias_tipo) >= 50;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 4: AN\\u00c1LISE TEMPORAL E TEND\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.1. EVOLU\\u00c7\\u00c3O MENSAL DAS MALHAS FISCAIS\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_evolucao_mensal STORED AS PARQUET AS\\r\\nSELECT\\r\\n    nu_per_ref AS periodo,\\r\\n    \\r\\n    -- Contagens\\r\\n    COUNT(DISTINCT nu_cnpj) AS qtd_empresas_periodo,\\r\\n    COUNT(*) AS qtd_inconsistencias_identificadas,\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- Valores\\r\\n    SUM(CASE WHEN flag_tem_valor_fiscal = 1 THEN vl_inconsistencia ELSE 0 END) AS valor_total_identificado,\\r\\n    AVG(CASE WHEN flag_tem_valor_fiscal = 1 THEN vl_inconsistencia END) AS valor_medio_inconsistencia,\\r\\n    \\r\\n    -- Por Canal de Resolu\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n    COUNT(CASE WHEN flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n    COUNT(CASE WHEN flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN nu_os IS NOT NULL THEN 1 END) AS qtd_gerou_os,\\r\\n    COUNT(CASE WHEN flag_gerou_infracao = 1 THEN 1 END) AS qtd_gerou_infracao,\\r\\n    \\r\\n    -- Taxas Principais\\r\\n    ROUND(COUNT(CASE WHEN flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autonomia_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_exclusao_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autuacao_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    AVG(dias_na_malha) AS media_dias_malha,\\r\\n    AVG(CASE WHEN flag_resolucao_autonoma = 1 THEN dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Por Natureza\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'OMISSAO' THEN 1 END) AS qtd_omissao,\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'CREDITO_INDEVIDO' THEN 1 END) AS qtd_credito_indevido,\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'DIVERGENCIA_VALOR_MENOR' THEN 1 END) AS qtd_divergencia,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_inconsistencias_detalhadas\\r\\nWHERE nu_per_ref BETWEEN 202101 AND 202509\\r\\nGROUP BY nu_per_ref\\r\\nORDER BY nu_per_ref;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 5: RANKINGS E DASHBOARDS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 5.1. RANKING DE CONTADORES POR AUTONOMIA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_ranking_contadores_autonomia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY taxa_autonomia_pct DESC, qtd_clientes_total DESC) AS ranking_autonomia,\\r\\n    nu_cpf_cnpj_contador,\\r\\n    nm_contador,\\r\\n    nu_crc_contador,\\r\\n    cd_munic_contador,\\r\\n    cd_uf_contador,\\r\\n    \\r\\n    -- M\\u00e9tricas Chave\\r\\n    qtd_clientes_total,\\r\\n    qtd_empresas_com_incons,\\r\\n    qtd_total_inconsistencias,\\r\\n    valor_total_inconsistencias,\\r\\n    \\r\\n    -- Autonomia (M\\u00c9TRICA PRINCIPAL)\\r\\n    taxa_autonomia_pct,\\r\\n    qtd_resolucao_autonoma_total,\\r\\n    qtd_resolvidas_dde,\\r\\n    \\r\\n    -- Outras Taxas\\r\\n    taxa_pendencia_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    score_performance,\\r\\n    classificacao_performance,\\r\\n    \\r\\n    -- Quartil de Autonomia\\r\\n    NTILE(4) OVER (ORDER BY taxa_autonomia_pct) AS quartil_autonomia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Geral\\r\\n    CASE \\r\\n        WHEN taxa_autonomia_pct >= 70 AND taxa_autuacao_pct < 10 THEN 'TOP_PERFORMER'\\r\\n        WHEN taxa_autonomia_pct >= 50 AND taxa_autuacao_pct < 20 THEN 'BOM_PERFORMER'\\r\\n        WHEN taxa_autonomia_pct >= 30 THEN 'REGULAR'\\r\\n        WHEN taxa_autuacao_pct > 30 THEN 'CRITICO_AUTUACOES'\\r\\n        WHEN taxa_pendencia_pct > 70 THEN 'CRITICO_PENDENCIAS'\\r\\n        ELSE 'NECESSITA_ATENCAO'\\r\\n    END AS classificacao_geral,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_performance_contadores\\r\\nWHERE qtd_empresas_com_incons >= 3\\r\\nORDER BY taxa_autonomia_pct DESC;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 5.2. RANKING DE TIPOS DE INCONSIST\\u00caNCIA POR EFETIVIDADE\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_ranking_tipos_efetividade STORED AS PARQUET AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY score_efetividade_tipo DESC) AS ranking_efetividade,\\r\\n    cd_inconsistencia,\\r\\n    nm_inconsistencia,\\r\\n    natureza_inconsistencia,\\r\\n    gravidade_presumida,\\r\\n    \\r\\n    -- Volumes\\r\\n    qtd_empresas_afetadas,\\r\\n    qtd_ocorrencias_total,\\r\\n    valor_total,\\r\\n    \\r\\n    -- Resolu\\u00e7\\u00e3o\\r\\n    taxa_autonomia_esperada_pct,\\r\\n    taxa_exclusao_esperada_pct,\\r\\n    taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00f5es\\r\\n    facilidade_resolucao,\\r\\n    legitimidade_exclusao,\\r\\n    score_efetividade_tipo,\\r\\n    \\r\\n    -- Tempo\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Geral\\r\\n    CASE \\r\\n        WHEN score_efetividade_tipo >= 70 THEN 'ALTAMENTE_EFETIVO'\\r\\n        WHEN score_efetividade_tipo >= 50 THEN 'EFETIVO'\\r\\n        WHEN score_efetividade_tipo >= 30 THEN 'MODERADAMENTE_EFETIVO'\\r\\n        ELSE 'BAIXA_EFETIVIDADE'\\r\\n    END AS classificacao_efetividade,\\r\\n    \\r\\n    -- Flag de Aten\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN legitimidade_exclusao = 'EXCLUSAO_ALTA_SUSPEITA' THEN 1\\r\\n        WHEN taxa_exclusao_esperada_pct > 70 AND taxa_autuacao_esperada_pct < 5 THEN 1\\r\\n        WHEN facilidade_resolucao = 'DIFICIL_RESOLUCAO' AND taxa_autonomia_esperada_pct < 20 THEN 1\\r\\n        ELSE 0\\r\\n    END AS flag_necessita_revisao,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_benchmark_tipo_inconsistencia\\r\\nORDER BY score_efetividade_tipo DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: TABELA 5.3 - RANKING DE DAFs (CORRIGIDA)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_ranking_dafs;\\r\\n\\r\\nCREATE TABLE niat.mlh_ranking_dafs STORED AS PARQUET AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY score_geral_ponderado DESC) AS ranking_geral,\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    qtd_total_inconsistencias,\\r\\n    ROUND(valor_total_inconsistencias / 1000000, 2) AS valor_incons_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_exclusao_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    taxa_ativas_pct,\\r\\n    taxa_necessidade_fiscalizacao,\\r\\n    \\r\\n    -- Performance\\r\\n    score_geral_ponderado,\\r\\n    classificacao_geral,  -- V\\u00cdRGULA CORRIGIDA!\\r\\n    \\r\\n    -- Quartil\\r\\n    NTILE(4) OVER (ORDER BY score_geral_ponderado) AS quartil_performance,\\r\\n    \\r\\n    -- Tempo\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_performance_dafs\\r\\nORDER BY score_geral_ponderado DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 6: VIEWS PARA DASHBOARDS E AN\\u00c1LISES\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.1. DASHBOARD EXECUTIVO V2.0\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_dashboard_executivo_v2 AS\\r\\nSELECT\\r\\n    -- Resumo Geral\\r\\n    (SELECT COUNT(DISTINCT nu_cnpj) FROM niat.mlh_empresas_base \\r\\n     WHERE flag_atualmente_em_malha = 1) AS empresas_em_malha_ativa,\\r\\n    \\r\\n    (SELECT COUNT(*) FROM niat.mlh_inconsistencias_detalhadas \\r\\n     WHERE canal_resolucao = 'ATIVA') AS inconsistencias_ativas,\\r\\n    \\r\\n    (SELECT SUM(CASE WHEN flag_tem_valor_fiscal = 1 THEN vl_inconsistencia ELSE 0 END) \\r\\n     FROM niat.mlh_inconsistencias_detalhadas \\r\\n     WHERE canal_resolucao = 'ATIVA') AS valor_ativo_malhas,\\r\\n    \\r\\n    -- Taxas de Autonomia (M\\u00c9TRICA CHAVE)\\r\\n    (SELECT ROUND(AVG(taxa_autonomia_pct), 2) \\r\\n     FROM niat.mlh_evolucao_mensal \\r\\n     WHERE periodo >= 202401) AS taxa_autonomia_media_2024,\\r\\n    \\r\\n    (SELECT ROUND(AVG(taxa_exclusao_pct), 2) \\r\\n     FROM niat.mlh_evolucao_mensal \\r\\n     WHERE periodo >= 202401) AS taxa_exclusao_media_2024,\\r\\n    \\r\\n    (SELECT ROUND(AVG(taxa_autuacao_pct), 2) \\r\\n     FROM niat.mlh_evolucao_mensal \\r\\n     WHERE periodo >= 202401) AS taxa_autuacao_media_2024,\\r\\n    \\r\\n    -- Performance de Contadores\\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_contadores_autonomia \\r\\n     WHERE classificacao_geral = 'TOP_PERFORMER') AS contadores_top_performer,\\r\\n    \\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_contadores_autonomia \\r\\n     WHERE classificacao_geral IN ('CRITICO_AUTUACOES', 'CRITICO_PENDENCIAS')) AS contadores_criticos,\\r\\n    \\r\\n    -- Efetividade de Tipos\\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_tipos_efetividade \\r\\n     WHERE flag_necessita_revisao = 1) AS tipos_necessitam_revisao,\\r\\n    \\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_tipos_efetividade \\r\\n     WHERE classificacao_efetividade = 'ALTAMENTE_EFETIVO') AS tipos_altamente_efetivos,\\r\\n    \\r\\n    -- Exclus\\u00f5es\\r\\n    (SELECT COUNT(*) FROM niat.mlh_analise_exclusoes_auditores \\r\\n     WHERE classificacao_exclusoes IN ('ALTA_SUSPEITA', 'MEDIA_SUSPEITA')) AS equipes_exclusoes_suspeitas,\\r\\n    \\r\\n    -- DAFs\\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_dafs \\r\\n     WHERE classificacao_geral = 'EXCELENTE') AS dafs_excelentes,\\r\\n    \\r\\n    -- Timestamp\\r\\n    CURRENT_TIMESTAMP() AS dt_atualizacao;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.2. VIEW DE CONTADORES - FOCO EM AUTONOMIA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_contadores_autonomia AS\\r\\nSELECT\\r\\n    rc.ranking_autonomia,\\r\\n    rc.nu_cpf_cnpj_contador,\\r\\n    rc.nm_contador,\\r\\n    rc.nu_crc_contador,\\r\\n    rc.cd_munic_contador,\\r\\n    rc.cd_uf_contador,\\r\\n    rc.qtd_clientes_total,\\r\\n    rc.qtd_empresas_com_incons,\\r\\n    ROUND(rc.valor_total_inconsistencias / 1000000, 2) AS valor_incons_milhoes,\\r\\n    \\r\\n    -- M\\u00e9tricas de Autonomia\\r\\n    rc.taxa_autonomia_pct,\\r\\n    rc.qtd_resolucao_autonoma_total,\\r\\n    rc.qtd_resolvidas_dde,\\r\\n    pc.qtd_resolvidas_malha_auto,\\r\\n    \\r\\n    -- Outras M\\u00e9tricas\\r\\n    rc.taxa_pendencia_pct,\\r\\n    rc.taxa_autuacao_pct,\\r\\n    rc.taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    rc.score_performance,\\r\\n    rc.classificacao_performance,\\r\\n    rc.classificacao_geral,\\r\\n    rc.quartil_autonomia,\\r\\n    \\r\\n    -- Detalhes\\r\\n    pc.media_dias_resolucao_autonoma,\\r\\n    pc.qtd_tipos_inconsistencia,\\r\\n    pc.qtd_omissao,\\r\\n    pc.qtd_credito_indevido\\r\\n\\r\\nFROM niat.mlh_ranking_contadores_autonomia rc\\r\\nINNER JOIN niat.mlh_performance_contadores pc \\r\\n    ON rc.nu_cpf_cnpj_contador = pc.nu_cpf_cnpj_contador;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.3. VIEW DE TIPOS DE INCONSIST\\u00caNCIA - BENCHMARK\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_tipos_benchmark AS\\r\\nSELECT\\r\\n    rt.ranking_efetividade,\\r\\n    rt.cd_inconsistencia,\\r\\n    rt.nm_inconsistencia,\\r\\n    rt.natureza_inconsistencia,\\r\\n    rt.gravidade_presumida,\\r\\n    rt.qtd_empresas_afetadas,\\r\\n    rt.qtd_ocorrencias_total,\\r\\n    ROUND(rt.valor_total / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- Taxas Benchmark\\r\\n    rt.taxa_autonomia_esperada_pct,\\r\\n    rt.taxa_exclusao_esperada_pct,\\r\\n    rt.taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00f5es\\r\\n    rt.facilidade_resolucao,\\r\\n    rt.legitimidade_exclusao,\\r\\n    rt.classificacao_efetividade,\\r\\n    rt.score_efetividade_tipo,\\r\\n    rt.flag_necessita_revisao,\\r\\n    \\r\\n    -- Tempo\\r\\n    rt.media_dias_malha,\\r\\n    rt.media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Cat\\u00e1logo\\r\\n    cat.flag_tem_valor_fiscal\\r\\n\\r\\nFROM niat.mlh_ranking_tipos_efetividade rt\\r\\nINNER JOIN niat.mlh_catalogo_tipos_inconsistencia cat \\r\\n    ON rt.cd_inconsistencia = cat.cd_inconsistencia;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: VIEW 6.4 - DAFs PERFORMANCE (CORRIGIDA)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_dafs_performance;\\r\\n\\r\\nCREATE VIEW niat.vw_mlh_dafs_performance AS\\r\\nSELECT\\r\\n    rd.ranking_geral,\\r\\n    rd.id_equipe,\\r\\n    rd.qtd_empresas_acompanhadas,\\r\\n    rd.qtd_contadores_acompanhados,\\r\\n    rd.qtd_total_inconsistencias,\\r\\n    rd.valor_incons_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    rd.taxa_autonomia_pct,\\r\\n    rd.taxa_exclusao_pct,\\r\\n    rd.taxa_autuacao_pct,\\r\\n    rd.taxa_ativas_pct,\\r\\n    rd.taxa_necessidade_fiscalizacao,\\r\\n    \\r\\n    -- Performance\\r\\n    rd.score_geral_ponderado,\\r\\n    rd.classificacao_geral,\\r\\n    rd.quartil_performance,\\r\\n    \\r\\n    -- Exclus\\u00f5es\\r\\n    COALESCE(ae.classificacao_exclusoes, 'SEM_ANALISE') AS classificacao_exclusoes,\\r\\n    COALESCE(ae.score_legitimidade, 0) AS score_legitimidade_exclusoes,\\r\\n    COALESCE(ae.qtd_exclusoes_suspeitas, 0) AS qtd_exclusoes_suspeitas,\\r\\n    \\r\\n    -- Tempo\\r\\n    rd.media_dias_malha,\\r\\n    rd.media_dias_resolucao_autonoma\\r\\n\\r\\nFROM niat.mlh_ranking_dafs rd\\r\\nLEFT JOIN niat.mlh_analise_exclusoes_auditores ae \\r\\n    ON rd.id_equipe = ae.id_equipe_auditor;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.5. VIEW DE S\\u00c9RIE TEMPORAL - EVOLU\\u00c7\\u00c3O\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_serie_temporal AS\\r\\nSELECT\\r\\n    periodo,\\r\\n    qtd_empresas_periodo,\\r\\n    qtd_inconsistencias_identificadas,\\r\\n    ROUND(valor_total_identificado / 1000000, 2) AS valor_identificado_milhoes,\\r\\n    \\r\\n    -- Por Canal\\r\\n    qtd_resolvidas_dde,\\r\\n    qtd_resolvidas_malha_auto,\\r\\n    qtd_resolucao_autonoma,\\r\\n    qtd_resolvidas_fiscalizacao,\\r\\n    qtd_excluidas_auditor,\\r\\n    qtd_ativas,\\r\\n    qtd_gerou_infracao,\\r\\n    \\r\\n    -- Taxas\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_exclusao_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Por Natureza\\r\\n    qtd_omissao,\\r\\n    qtd_credito_indevido,\\r\\n    qtd_divergencia\\r\\n\\r\\nFROM niat.mlh_evolucao_mensal\\r\\nORDER BY periodo;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.6. VIEW DE TIPOS DE INCONSIST\\u00caNCIA - AN\\u00c1LISE DETALHADA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_tipos_detalhado AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY ben.score_efetividade_tipo DESC) AS ranking_tipo,\\r\\n    ben.cd_inconsistencia,\\r\\n    ben.nm_inconsistencia,\\r\\n    ben.natureza_inconsistencia,\\r\\n    ben.gravidade_presumida,\\r\\n    ben.qtd_empresas_afetadas,\\r\\n    ben.qtd_ocorrencias_total,\\r\\n    ROUND(ben.valor_total / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    ben.taxa_autonomia_esperada_pct,\\r\\n    ben.taxa_exclusao_esperada_pct,\\r\\n    ben.taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    ben.score_efetividade_tipo,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN ben.score_efetividade_tipo >= 70 THEN 'ALTAMENTE_EFETIVO'\\r\\n        WHEN ben.score_efetividade_tipo >= 50 THEN 'EFETIVO'\\r\\n        WHEN ben.score_efetividade_tipo >= 30 THEN 'MODERADAMENTE_EFETIVO'\\r\\n        ELSE 'BAIXA_EFETIVIDADE'\\r\\n    END AS classificacao_efetividade,\\r\\n    \\r\\n    -- Tempo\\r\\n    ben.media_dias_malha,\\r\\n    ben.media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Status\\r\\n    CASE \\r\\n        WHEN DATEDIFF(CURRENT_DATE(), FROM_UNIXTIME(UNIX_TIMESTAMP(CONCAT(CAST(ben.periodo_ultima_geracao AS STRING), '01'), 'yyyyMMdd'), 'yyyy-MM-dd')) > 90 THEN 'INATIVO'\\r\\n        WHEN DATEDIFF(CURRENT_DATE(), FROM_UNIXTIME(UNIX_TIMESTAMP(CONCAT(CAST(ben.periodo_ultima_geracao AS STRING), '01'), 'yyyyMMdd'), 'yyyy-MM-dd')) > 30 THEN 'POUCO_ATIVO'\\r\\n        ELSE 'ATIVO'\\r\\n    END AS status_atividade\\r\\n\\r\\nFROM niat.mlh_benchmark_tipo_inconsistencia ben;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 7: AN\\u00c1LISES ESPEC\\u00cdFICAS PARA PYTHON/ML\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 7.1. DATASET PARA AN\\u00c1LISE DE PADR\\u00d5ES DE EXCLUS\\u00c3O\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_dataset_exclusoes_ml STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identificadores\\r\\n    id.nu_cnpj,\\r\\n    id.cd_inconsistencia,\\r\\n    id.nu_per_ref,\\r\\n    \\r\\n    -- Features do Tipo de Inconsist\\u00eancia\\r\\n    ben.taxa_exclusao_esperada_pct,\\r\\n    ben.taxa_autuacao_esperada_pct,\\r\\n    ben.taxa_autonomia_esperada_pct,\\r\\n    ben.facilidade_resolucao,\\r\\n    ben.legitimidade_exclusao,\\r\\n    ben.score_efetividade_tipo,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    \\r\\n    -- Features da Empresa\\r\\n    eb.cnae_divisao,\\r\\n    eb.secao_cnae,\\r\\n    eb.cd_reg_apuracao,\\r\\n    eb.cd_enq_empresa,\\r\\n    eb.sn_simples_nacional_rfb,\\r\\n    eb.qtd_tipos_inconsistencia_historico,\\r\\n    \\r\\n    -- Features do Contador\\r\\n    pc.taxa_autonomia_pct AS taxa_autonomia_contador,\\r\\n    pc.taxa_autuacao_pct AS taxa_autuacao_contador,\\r\\n    pc.score_performance AS score_contador,\\r\\n    pc.classificacao_performance AS classificacao_contador,\\r\\n    \\r\\n    -- Features da Inconsist\\u00eancia Espec\\u00edfica\\r\\n    id.vl_inconsistencia,\\r\\n    id.dias_na_malha,\\r\\n    id.dias_ate_resolucao,\\r\\n    \\r\\n    -- Target (o que queremos prever)\\r\\n    id.flag_exclusao_auditor AS target_exclusao,\\r\\n    id.flag_resolucao_autonoma AS target_autonomia,\\r\\n    id.flag_gerou_infracao AS target_infracao,\\r\\n    id.canal_resolucao AS target_canal_resolucao,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_inconsistencias_detalhadas id\\r\\nLEFT JOIN niat.mlh_benchmark_tipo_inconsistencia ben \\r\\n    ON id.cd_inconsistencia = ben.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_catalogo_tipos_inconsistencia cat \\r\\n    ON id.cd_inconsistencia = cat.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_empresas_base eb \\r\\n    ON id.nu_cnpj = eb.nu_cnpj\\r\\nLEFT JOIN niat.mlh_performance_contadores pc \\r\\n    ON eb.nu_cpf_cnpj_contador = pc.nu_cpf_cnpj_contador\\r\\nWHERE id.dt_entrou_malha >= '2023-01-01';\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 7.2. AGREGA\\u00c7\\u00c3O PARA AN\\u00c1LISE DE CLUSTER DE CONTADORES\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_dataset_clusters_contadores STORED AS PARQUET AS\\r\\nSELECT\\r\\n    pc.nu_cpf_cnpj_contador,\\r\\n    pc.nm_contador,\\r\\n    \\r\\n    -- Features de Volume\\r\\n    pc.qtd_clientes_total,\\r\\n    pc.qtd_empresas_com_incons,\\r\\n    pc.qtd_total_inconsistencias,\\r\\n    LN(CAST(pc.valor_total_inconsistencias AS DOUBLE) + 1.0) AS log_valor_total,\\r\\n    \\r\\n    -- Features de Autonomia\\r\\n    pc.taxa_autonomia_pct,\\r\\n    pc.taxa_resolucao_dde_pct,\\r\\n    pc.taxa_pendencia_pct,\\r\\n    pc.taxa_autuacao_pct,\\r\\n    pc.taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Features de Diversidade\\r\\n    pc.qtd_tipos_inconsistencia,\\r\\n    pc.qtd_omissao,\\r\\n    pc.qtd_credito_indevido,\\r\\n    pc.qtd_divergencia,\\r\\n    \\r\\n    -- Features de Tempo\\r\\n    pc.media_dias_malha,\\r\\n    pc.media_dias_resolucao_autonoma,\\r\\n    pc.media_dias_resolucao_fiscal,\\r\\n    \\r\\n    -- Features de Performance\\r\\n    pc.score_performance,\\r\\n    \\r\\n    -- Features Geogr\\u00e1ficas\\r\\n    pc.cd_munic_contador,\\r\\n    pc.cd_uf_contador,\\r\\n    \\r\\n    -- Features de Risco\\r\\n    CASE \\r\\n        WHEN pc.taxa_autuacao_pct > 30 THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS flag_alto_risco_autuacao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN pc.taxa_pendencia_pct > 70 THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS flag_alta_pendencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    pc.classificacao_performance,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_performance_contadores pc\\r\\nWHERE pc.qtd_total_inconsistencias >= 10;\\r\\n\\r\\n-- ============================================================================\\r\\n-- CRIAR TABELA PR\\u00c9-PROCESSADA PARA ML - VERS\\u00c3O FINAL\\r\\n-- ============================================================================\\r\\n\\r\\nCREATE TABLE niat.mlh_dataset_ml_exclusoes STORED AS PARQUET AS\\r\\nSELECT \\r\\n    -- Features do Tipo\\r\\n    COALESCE(ben.taxa_exclusao_esperada_pct, 0) AS taxa_exclusao_esperada_pct,\\r\\n    COALESCE(ben.taxa_autuacao_esperada_pct, 0) AS taxa_autuacao_esperada_pct,\\r\\n    COALESCE(ben.taxa_autonomia_esperada_pct, 0) AS taxa_autonomia_esperada_pct,\\r\\n    COALESCE(ben.score_efetividade_tipo, 50) AS score_efetividade_tipo,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ben.facilidade_resolucao = 'FACIL_RESOLUCAO' THEN 1\\r\\n        WHEN ben.facilidade_resolucao = 'MEDIA_RESOLUCAO' THEN 2\\r\\n        ELSE 3 \\r\\n    END AS facilidade_num,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ben.legitimidade_exclusao = 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA' THEN 0\\r\\n        WHEN ben.legitimidade_exclusao = 'NORMAL' THEN 1\\r\\n        WHEN ben.legitimidade_exclusao = 'EXCLUSAO_MEDIA_ANALISAR' THEN 2\\r\\n        ELSE 3 \\r\\n    END AS legitimidade_num,\\r\\n    \\r\\n    CASE \\r\\n        WHEN cat.natureza_inconsistencia = 'OMISSAO' THEN 1\\r\\n        WHEN cat.natureza_inconsistencia = 'CREDITO_INDEVIDO' THEN 2\\r\\n        WHEN cat.natureza_inconsistencia = 'DIVERGENCIA_VALOR_MENOR' THEN 3\\r\\n        ELSE 0 \\r\\n    END AS natureza_num,\\r\\n    \\r\\n    -- Features da Empresa (CORRIGIDO COM C\\u00d3DIGOS NUM\\u00c9RICOS)\\r\\n    CASE WHEN eb.cd_reg_apuracao = 2 THEN 1 ELSE 0 END AS regime_normal,\\r\\n    CASE WHEN eb.cd_reg_apuracao IN (8, 9) THEN 1 ELSE 0 END AS simples_nacional,\\r\\n    COALESCE(eb.qtd_tipos_inconsistencia_historico, 0) AS qtd_tipos_inconsistencia_historico,\\r\\n    \\r\\n    -- C\\u00f3digo do regime (pode ser \\u00fatil no modelo)\\r\\n    eb.cd_reg_apuracao AS cod_regime_apuracao,\\r\\n    \\r\\n    -- Features do Contador\\r\\n    COALESCE(pc.taxa_autonomia_pct, 50) AS contador_taxa_autonomia,\\r\\n    COALESCE(pc.taxa_autuacao_pct, 10) AS contador_taxa_autuacao,\\r\\n    COALESCE(pc.score_performance, 50) AS contador_score,\\r\\n    \\r\\n    -- Features da Inconsist\\u00eancia\\r\\n    LN(COALESCE(id.vl_inconsistencia, 1) + 1) AS log_valor,\\r\\n    COALESCE(id.dias_na_malha, 0) AS dias_malha,\\r\\n    \\r\\n    -- Target\\r\\n    COALESCE(id.flag_exclusao_auditor, 0) AS target_exclusao,\\r\\n    COALESCE(id.flag_gerou_infracao, 0) AS target_infracao\\r\\n    \\r\\nFROM niat.mlh_inconsistencias_detalhadas id\\r\\nLEFT JOIN niat.mlh_benchmark_tipo_inconsistencia ben \\r\\n    ON id.cd_inconsistencia = ben.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_catalogo_tipos_inconsistencia cat \\r\\n    ON id.cd_inconsistencia = cat.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_empresas_base eb \\r\\n    ON id.nu_cnpj = eb.nu_cnpj\\r\\nLEFT JOIN niat.mlh_performance_contadores pc \\r\\n    ON eb.nu_cpf_cnpj_contador = pc.nu_cpf_cnpj_contador\\r\\nWHERE id.dt_entrou_malha >= '2024-01-01'\\r\\n  AND id.dt_saiu_malha IS NOT NULL;\\r\\n\\r\\n-- ============================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES E ESTAT\\u00cdSTICAS FINAIS\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'SISTEMA DE MALHAS FISCAIS V2.0 - RESUMO EXECUTIVO' AS titulo;\\r\\n\\r\\n-- Contagem de Registros nas Tabelas Principais\\r\\nSELECT 'CONTAGEM DE REGISTROS' AS secao;\\r\\nSELECT \\r\\n    'mlh_empresas_base' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_unicas,\\r\\n    SUM(flag_atualmente_em_malha) AS empresas_em_malha_ativa\\r\\nFROM niat.mlh_empresas_base\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_inconsistencias_detalhadas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_unicas,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'ATIVA' THEN 1 END) AS inconsistencias_ativas\\r\\nFROM niat.mlh_inconsistencias_detalhadas\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_catalogo_tipos_inconsistencia' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS tipos_unicos,\\r\\n    SUM(CASE WHEN flag_tipo_ativo = '1' THEN 1 ELSE 0 END) AS tipos_ativos\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_performance_contadores' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cpf_cnpj_contador) AS contadores_unicos,\\r\\n    NULL AS terceira_metrica\\r\\nFROM niat.mlh_performance_contadores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_performance_dafs' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT id_equipe) AS equipes_unicas,\\r\\n    NULL AS terceira_metrica\\r\\nFROM niat.mlh_performance_dafs\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_benchmark_tipo_inconsistencia' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS tipos_unicos,\\r\\n    NULL AS terceira_metrica\\r\\nFROM niat.mlh_benchmark_tipo_inconsistencia;\\r\\n\\r\\n-- Top 10 Contadores por Autonomia\\r\\nSELECT 'TOP 10 CONTADORES POR TAXA DE AUTONOMIA' AS analise;\\r\\nSELECT \\r\\n    ranking_autonomia,\\r\\n    nm_contador,\\r\\n    nu_crc_contador,\\r\\n    qtd_empresas_com_incons,\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    classificacao_geral\\r\\nFROM niat.mlh_ranking_contadores_autonomia\\r\\nWHERE ranking_autonomia <= 10\\r\\nORDER BY ranking_autonomia;\\r\\n\\r\\n-- Top 10 Tipos de Inconsist\\u00eancia por Efetividade\\r\\nSELECT 'TOP 10 TIPOS DE INCONSIST\\u00caNCIA POR EFETIVIDADE' AS analise;\\r\\nSELECT \\r\\n    ranking_efetividade,\\r\\n    cd_inconsistencia,\\r\\n    nm_inconsistencia,\\r\\n    qtd_ocorrencias_total,\\r\\n    taxa_autonomia_esperada_pct,\\r\\n    taxa_autuacao_esperada_pct,\\r\\n    score_efetividade_tipo,\\r\\n    classificacao_efetividade\\r\\nFROM niat.mlh_ranking_tipos_efetividade\\r\\nWHERE ranking_efetividade <= 10\\r\\nORDER BY ranking_efetividade;\\r\\n\\r\\n-- Performance das DAFs\\r\\nSELECT 'TOP 10 DAFs POR PERFORMANCE' AS analise;\\r\\nSELECT \\r\\n    ranking_geral,\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    score_performance_daf,\\r\\n    classificacao_performance\\r\\nFROM niat.mlh_ranking_dafs\\r\\nWHERE ranking_geral <= 10\\r\\nORDER BY ranking_geral;\\r\\n\\r\\n-- Tipos que Necessitam Revis\\u00e3o\\r\\nSELECT 'TIPOS DE INCONSIST\\u00caNCIA QUE NECESSITAM REVIS\\u00c3O' AS analise;\\r\\nSELECT \\r\\n    cd_inconsistencia,\\r\\n    nm_inconsistencia,\\r\\n    natureza_inconsistencia,\\r\\n    qtd_ocorrencias_total,\\r\\n    taxa_exclusao_esperada_pct,\\r\\n    taxa_autuacao_esperada_pct,\\r\\n    legitimidade_exclusao,\\r\\n    classificacao_efetividade\\r\\nFROM niat.mlh_ranking_tipos_efetividade\\r\\nWHERE flag_necessita_revisao = 1\\r\\nORDER BY qtd_ocorrencias_total DESC;\\r\\n\\r\\n-- Equipes com Exclus\\u00f5es Suspeitas\\r\\nSELECT 'EQUIPES COM PADR\\u00c3O SUSPEITO DE EXCLUS\\u00c3O' AS analise;\\r\\nSELECT \\r\\n    id_equipe_auditor,\\r\\n    qtd_total_inconsistencias,\\r\\n    qtd_total_excluidas,\\r\\n    taxa_exclusao_geral_pct,\\r\\n    qtd_exclusoes_suspeitas,\\r\\n    taxa_exclusao_suspeita_pct,\\r\\n    score_legitimidade,\\r\\n    classificacao_exclusoes\\r\\nFROM niat.mlh_analise_exclusoes_auditores\\r\\nWHERE classificacao_exclusoes IN ('ALTA_SUSPEITA', 'MEDIA_SUSPEITA')\\r\\nORDER BY taxa_exclusao_suspeita_pct DESC;\\r\\n\\r\\n-- Evolu\\u00e7\\u00e3o nos \\u00daltimos 12 Meses\\r\\nSELECT 'EVOLU\\u00c7\\u00c3O \\u00daLTIMOS 12 MESES' AS analise;\\r\\nSELECT \\r\\n    periodo,\\r\\n    qtd_empresas_periodo,\\r\\n    qtd_inconsistencias_identificadas,\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_exclusao_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    media_dias_malha\\r\\nFROM niat.mlh_evolucao_mensal\\r\\nWHERE periodo >= 202401\\r\\nORDER BY periodo;\", \"statementsList\": [\"-- ============================================================================\\r\\n-- SISTEMA DE MONITORAMENTO E GEST\\u00c3O DE MALHAS FISCAIS - DAFs V2.0\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: TABELAS FUNDAMENTAIS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.1. CAT\\u00c1LOGO DE TIPOS DE INCONSIST\\u00caNCIAS\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_catalogo_tipos_inconsistencia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    t.cd_inconsistencia,\\r\\n    t.nm_inconsistencia,\\r\\n    t.cd_tipo_infracao,\\r\\n    \\r\\n    -- Status e Visibilidade\\r\\n    CAST(t.sn_ativa AS STRING) AS flag_tipo_ativo,\\r\\n    t.cd_visibilidade,\\r\\n    t.cd_forma_regularizacao,\\r\\n    \\r\\n    -- Valores de Corte\\r\\n    t.vl_individual_min AS valor_minimo_malha,\\r\\n    t.vl_mensal_min AS valor_mensal_minimo,\\r\\n    t.nu_per_ini AS periodo_inicio_vigencia,\\r\\n    \\r\\n    -- Impactos\\r\\n    t.sn_regularidade_ttd AS flag_impacta_regularidade,\\r\\n    t.sn_dashboard AS flag_aparece_dashboard,\\r\\n    CAST(t.sn_bloqueada AS STRING) AS flag_tipo_bloqueado,\\r\\n    t.de_bloqueada AS motivo_bloqueio,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o por Natureza da Inconsist\\u00eancia\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o%' OR t.nm_inconsistencia LIKE '%n\\u00e3o escriturada%' \\r\\n        THEN 'OMISSAO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Cr\\u00e9dito indevido%' OR t.nm_inconsistencia LIKE '%Cr\\u00e9dito Indevido%'\\r\\n        THEN 'CREDITO_INDEVIDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%menor que%' OR t.nm_inconsistencia LIKE '%D\\u00e9bito de ICMS declarado na EFD menor%'\\r\\n        THEN 'DIVERGENCIA_VALOR_MENOR'\\r\\n        WHEN t.nm_inconsistencia LIKE '%maior que%'\\r\\n        THEN 'DIVERGENCIA_VALOR_MAIOR'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Saldo%'\\r\\n        THEN 'DIVERGENCIA_SALDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%cancelad%' OR t.nm_inconsistencia LIKE '%inexistente%'\\r\\n        THEN 'DOCUMENTO_INVALIDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Estorno%'\\r\\n        THEN 'ESTORNO_IRREGULAR'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS natureza_inconsistencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o por Gravidade Presumida\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Cr\\u00e9dito indevido%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%n\\u00e3o escriturada%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%cancelad%' THEN 'MEDIA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%menor que%' THEN 'MEDIA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%maior que%' THEN 'BAIXA'\\r\\n        ELSE 'MEDIA'\\r\\n    END AS gravidade_presumida,\\r\\n    \\r\\n    -- Flag se tem valor monet\\u00e1rio associado\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o de entrega%' THEN 0\\r\\n        ELSE 1\\r\\n    END AS flag_tem_valor_fiscal,\\r\\n    \\r\\n    -- Metadados\\r\\n    t.dt_publicacao,\\r\\n    t.dt_inclusao,\\r\\n    t.dt_alteracao,\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha_trans.mlh_incons_tipo t;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.2. EMPRESAS NA MALHA FISCAL - BASE CONSOLIDADA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_empresas_base STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    ei.nu_cnpj,\\r\\n    ei.nu_cnpj_grupo,\\r\\n    ei.nu_cpf,\\r\\n    ei.nu_ie,\\r\\n    ei.id_equipe,\\r\\n    \\r\\n    -- Informa\\u00e7\\u00f5es Cadastrais\\r\\n    c.nm_razao_social,\\r\\n    c.nm_fantasia,\\r\\n    c.cd_sit_cadastral,\\r\\n    c.nm_sit_cadastral,\\r\\n    c.cd_reg_apuracao,\\r\\n    c.nm_reg_apuracao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Econ\\u00f4mica\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS cnae_divisao,\\r\\n    c.de_classe AS desc_cnae,\\r\\n    c.cd_secao AS secao_cnae,\\r\\n    c.de_secao AS desc_secao,\\r\\n    \\r\\n    -- Localiza\\u00e7\\u00e3o\\r\\n    c.cd_gerfe,\\r\\n    c.nm_gerfe,\\r\\n    c.cd_ges,\\r\\n    c.nm_ges,\\r\\n    c.cd_munic,\\r\\n    c.nm_munic,\\r\\n    c.cd_uf,\\r\\n    \\r\\n    -- Contador Respons\\u00e1vel\\r\\n    c.nu_cpf_cnpj_contador,\\r\\n    c.nm_contador,\\r\\n    c.nu_crc_contador,\\r\\n    c.dt_ini_relac_contador,\\r\\n    c.cd_munic_contador,\\r\\n    c.cd_uf_contador,\\r\\n    \\r\\n    -- Caracter\\u00edsticas da Empresa\\r\\n    c.cd_tipo_contribuinte,\\r\\n    c.nm_tipo_contribuinte,\\r\\n    c.cd_enq_empresa,\\r\\n    c.nm_enq_empresa,\\r\\n    c.cd_natureza_juridica,\\r\\n    c.nm_natureza_juridica,\\r\\n    c.sn_simples_nacional_rfb,\\r\\n    c.sn_dtec,\\r\\n    c.dt_credenciamento_dtec,\\r\\n    c.sn_suspensao_dfe,\\r\\n    c.dt_suspensao_dfe,\\r\\n    c.sn_matriz,\\r\\n    c.sn_apur_consolidada,\\r\\n    c.sn_estab_consolidado,\\r\\n    c.sn_estab_consolidador,\\r\\n    \\r\\n    -- V\\u00ednculos\\r\\n    c.qt_vinculos,\\r\\n    c.qt_vinculos_ativos,\\r\\n    c.qt_socios,\\r\\n    c.qt_socios_ativos,\\r\\n    \\r\\n    -- Agregados de Inconsist\\u00eancias\\r\\n    COUNT(DISTINCT ei.cd_inconsistencia) AS qtd_tipos_inconsistencia_historico,\\r\\n    SUM(ei.qt_incons_existentes) AS qtd_total_inconsistencias_historico,\\r\\n    SUM(ei.vl_incons_existentes) AS valor_total_inconsistencias_historico,\\r\\n    \\r\\n    -- Status Atual na Malha\\r\\n    MAX(CASE WHEN ei.dt_saiu_malha IS NULL THEN 1 ELSE 0 END) AS flag_atualmente_em_malha,\\r\\n    SUM(CASE WHEN ei.dt_saiu_malha IS NULL THEN ei.qt_incons_existentes ELSE 0 END) AS qtd_inconsistencias_ativas,\\r\\n    SUM(CASE WHEN ei.dt_saiu_malha IS NULL THEN ei.vl_incons_existentes ELSE 0 END) AS valor_inconsistencias_ativas,\\r\\n    \\r\\n    -- Datas\\r\\n    MIN(ei.dt_entrou_malha) AS dt_primeira_entrada_malha,\\r\\n    MAX(ei.dt_entrou_malha) AS dt_ultima_entrada_malha,\\r\\n    MAX(ei.dt_saiu_malha) AS dt_ultima_saida_malha,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha.mlh_empresa_incons ei\\r\\nINNER JOIN usr_sat_ods.vw_ods_contrib c ON ei.nu_cnpj = c.nu_cnpj\\r\\nGROUP BY \\r\\n    ei.nu_cnpj, ei.nu_cnpj_grupo, ei.nu_cpf, ei.nu_ie, ei.id_equipe,\\r\\n    c.nm_razao_social, c.nm_fantasia, c.cd_sit_cadastral, c.nm_sit_cadastral,\\r\\n    c.cd_reg_apuracao, c.nm_reg_apuracao,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5), SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2),\\r\\n    c.de_classe, c.cd_secao, c.de_secao,\\r\\n    c.cd_gerfe, c.nm_gerfe, c.cd_ges, c.nm_ges, c.cd_munic, c.nm_munic, c.cd_uf,\\r\\n    c.nu_cpf_cnpj_contador, c.nm_contador, c.nu_crc_contador, c.dt_ini_relac_contador,\\r\\n    c.cd_munic_contador, c.cd_uf_contador,\\r\\n    c.cd_tipo_contribuinte, c.nm_tipo_contribuinte, c.cd_enq_empresa, c.nm_enq_empresa,\\r\\n    c.cd_natureza_juridica, c.nm_natureza_juridica, c.sn_simples_nacional_rfb,\\r\\n    c.sn_dtec, c.dt_credenciamento_dtec, c.sn_suspensao_dfe, c.dt_suspensao_dfe,\\r\\n    c.sn_matriz, c.sn_apur_consolidada, c.sn_estab_consolidado, c.sn_estab_consolidador,\\r\\n    c.qt_vinculos, c.qt_vinculos_ativos, c.qt_socios, c.qt_socios_ativos;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.3. INCONSIST\\u00caNCIAS DETALHADAS - HIST\\u00d3RICO COMPLETO\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_inconsistencias_detalhadas STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    d.nu_cnpj,\\r\\n    d.nu_ie,\\r\\n    d.nu_per_ref,\\r\\n    d.nu_per_ref_identificado,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o da Inconsist\\u00eancia\\r\\n    d.cd_inconsistencia,\\r\\n    t.nm_inconsistencia,\\r\\n    t.natureza_inconsistencia,\\r\\n    t.gravidade_presumida,\\r\\n    t.flag_tem_valor_fiscal,\\r\\n    t.cd_tipo_infracao,\\r\\n    d.tx_chave_inconsistencia,\\r\\n    d.vl_inconsistencia,\\r\\n    \\r\\n    -- Ciclo de Vida\\r\\n    d.cd_situacao,\\r\\n    d.dt_identificada,\\r\\n    d.dt_entrou_malha,\\r\\n    d.dt_saiu_malha,\\r\\n    d.dt_resolvida_malha,\\r\\n    d.dt_em_fiscalizacao,\\r\\n    \\r\\n    -- Canal de Resolu\\u00e7\\u00e3o (PRINCIPAL M\\u00c9TRICA) - CORRIGIDO\\r\\n    CASE \\r\\n        -- 1. Resolvido autonomamente via DDE (melhor cen\\u00e1rio)\\r\\n        WHEN d.id_resolvido_dde IS NOT NULL THEN 'AUTONOMO_DDE'\\r\\n        \\r\\n        -- 2. Resolvido autonomamente via malha (retifica\\u00e7\\u00e3o)\\r\\n        WHEN d.dt_resolvida_malha IS NOT NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL \\r\\n             AND d.id_resolvido_dde IS NULL \\r\\n        THEN 'AUTONOMO_MALHA'\\r\\n        \\r\\n        -- 3. Exclu\\u00eddo por auditor (antes de ir para fiscaliza\\u00e7\\u00e3o)\\r\\n        WHEN d.dt_saiu_malha IS NOT NULL \\r\\n             AND d.dt_resolvida_malha IS NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL \\r\\n             AND d.id_resolvido_dde IS NULL\\r\\n             AND d.dt_em_fiscalizacao IS NULL\\r\\n        THEN 'EXCLUSAO_AUDITOR'\\r\\n        \\r\\n        -- 4. Em fiscaliza\\u00e7\\u00e3o (PAF aberto, mas sem autua\\u00e7\\u00e3o ainda)\\r\\n        WHEN d.dt_em_fiscalizacao IS NOT NULL \\r\\n             AND d.nu_infracao IS NULL\\r\\n             AND d.dt_saiu_malha IS NULL\\r\\n        THEN 'EM_FISCALIZACAO'\\r\\n        \\r\\n        -- 5. Fiscaliza\\u00e7\\u00e3o conclu\\u00edda (passou por PAF, pode ter sido resolvida ou autuada)\\r\\n        WHEN d.cd_motivo_resolvido_fiscal IS NOT NULL \\r\\n             OR d.nu_infracao IS NOT NULL\\r\\n        THEN 'FISCALIZACAO_CONCLUIDA'\\r\\n        \\r\\n        -- 6. Ativa (ainda no prazo de regulariza\\u00e7\\u00e3o - N\\u00c3O \\u00c9 PROBLEMA)\\r\\n        WHEN d.dt_entrou_malha IS NOT NULL \\r\\n             AND d.dt_saiu_malha IS NULL \\r\\n             AND d.dt_em_fiscalizacao IS NULL\\r\\n        THEN 'ATIVA'\\r\\n        \\r\\n        -- 7. Apenas identificada (ainda n\\u00e3o entrou na malha)\\r\\n        ELSE 'IDENTIFICADA'\\r\\n    END AS canal_resolucao,\\r\\n    \\r\\n    -- Subcanal detalhado para fiscaliza\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN d.nu_infracao IS NOT NULL THEN 'FISCALIZACAO_COM_AUTUACAO'\\r\\n        WHEN d.cd_motivo_resolvido_fiscal IS NOT NULL AND d.nu_infracao IS NULL THEN 'FISCALIZACAO_SEM_AUTUACAO'\\r\\n        WHEN d.dt_em_fiscalizacao IS NOT NULL AND d.nu_infracao IS NULL THEN 'FISCALIZACAO_EM_ANDAMENTO'\\r\\n        ELSE NULL\\r\\n    END AS subcanal_fiscalizacao,\\r\\n    \\r\\n    -- Detalhes da Resolu\\u00e7\\u00e3o\\r\\n    d.cd_motivo_resolvido_fiscal,\\r\\n    d.id_resolvido_dde,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    d.id_pacote,\\r\\n    d.nu_os,\\r\\n    d.nu_infracao,\\r\\n    d.nu_notificacao,\\r\\n    d.sn_enviar_fisca,\\r\\n    \\r\\n    -- Processamento\\r\\n    d.id_exec_malha,\\r\\n    d.cd_tipo_execucao,\\r\\n    d.dt_processamento,\\r\\n    \\r\\n    -- Detalhes EFD vs NFe\\r\\n    d.id_efd,\\r\\n    d.nu_chave_efd,\\r\\n    d.vl_total_efd,\\r\\n    d.vl_icms_efd,\\r\\n    d.nu_chave_nfe,\\r\\n    d.vl_total_nfe,\\r\\n    d.vl_icms_nfe,\\r\\n    d.dt_cancelamento_nfe,\\r\\n    \\r\\n    -- Tempos (em dias)\\r\\n    DATEDIFF(COALESCE(d.dt_saiu_malha, CURRENT_DATE()), d.dt_entrou_malha) AS dias_na_malha,\\r\\n    DATEDIFF(d.dt_resolvida_malha, d.dt_identificada) AS dias_ate_resolucao,\\r\\n    DATEDIFF(d.dt_em_fiscalizacao, d.dt_entrou_malha) AS dias_ate_fiscalizacao,\\r\\n    DATEDIFF(COALESCE(d.dt_saiu_malha, CURRENT_DATE()), d.dt_identificada) AS dias_ciclo_total,\\r\\n    \\r\\n    -- Flags de An\\u00e1lise\\r\\n    CASE \\r\\n        WHEN d.id_resolvido_dde IS NOT NULL OR \\r\\n             (d.dt_resolvida_malha IS NOT NULL AND d.cd_motivo_resolvido_fiscal IS NULL) \\r\\n        THEN 1 ELSE 0 \\r\\n    END AS flag_resolucao_autonoma,\\r\\n    \\r\\n    CASE \\r\\n        WHEN d.dt_saiu_malha IS NOT NULL AND d.dt_resolvida_malha IS NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL AND d.id_resolvido_dde IS NULL \\r\\n        THEN 1 ELSE 0 \\r\\n    END AS flag_exclusao_auditor,\\r\\n    \\r\\n    CASE WHEN d.nu_infracao IS NOT NULL THEN 1 ELSE 0 END AS flag_gerou_infracao,\\r\\n    \\r\\n    -- Tipo de Inconsist\\u00eancia Categorizado\\r\\n    CASE \\r\\n        WHEN d.nu_chave_nfe IS NOT NULL AND d.nu_chave_efd IS NULL THEN 'OMISSAO_NFE_NA_EFD'\\r\\n        WHEN d.nu_chave_efd IS NOT NULL AND d.nu_chave_nfe IS NULL THEN 'NOTA_FALSA_EFD'\\r\\n        WHEN d.nu_chave_nfe IS NOT NULL AND d.nu_chave_efd IS NOT NULL \\r\\n             AND ABS(d.vl_total_nfe - d.vl_total_efd) > 100 THEN 'DIVERGENCIA_VALOR'\\r\\n        WHEN d.dt_cancelamento_nfe IS NOT NULL THEN 'CANCELAMENTO_NAO_ESTORNADO'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS tipo_detalhado,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha.mlh_efd_nfe_incons d\\r\\nLEFT JOIN niat.mlh_catalogo_tipos_inconsistencia t ON d.cd_inconsistencia = t.cd_inconsistencia;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: AN\\u00c1LISE DE PERFORMANCE POR DIMENS\\u00d5ES\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.1. BENCHMARK POR TIPO DE INCONSIST\\u00caNCIA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_benchmark_tipo_inconsistencia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    cat.flag_tem_valor_fiscal,\\r\\n    \\r\\n    -- Contagens\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    COUNT(*) AS qtd_ocorrencias_total,\\r\\n    COUNT(DISTINCT id.nu_per_ref) AS qtd_periodos_geracao,\\r\\n    \\r\\n    -- Valores (quando aplic\\u00e1vel)\\r\\n    SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total,\\r\\n    AVG(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END) AS valor_medio,\\r\\n    STDDEV(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END) AS valor_desvio_padrao,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Canal de Resolu\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n    COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n    COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\\r\\n    \\r\\n    -- Taxas Esperadas (BENCHMARK)\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autonomia_esperada_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_exclusao_esperada_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Desvio Padr\\u00e3o das Taxas (para detectar anomalias)\\r\\n    STDDEV(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1.0 ELSE 0.0 END) AS desvio_taxa_exclusao,\\r\\n    \\r\\n    -- Tempo M\\u00e9dio de Resolu\\u00e7\\u00e3o\\r\\n    AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n    AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n    STDDEV(id.dias_na_malha) AS desvio_dias_malha,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Facilidade de Resolu\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.7 \\r\\n        THEN 'FACIL_RESOLUCAO'\\r\\n        WHEN COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.4 \\r\\n        THEN 'MEDIA_RESOLUCAO'\\r\\n        ELSE 'DIFICIL_RESOLUCAO'\\r\\n    END AS facilidade_resolucao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Legitimidade de Exclus\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.5 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) < 0.05\\r\\n        THEN 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA'\\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.3 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) < 0.1\\r\\n        THEN 'EXCLUSAO_MEDIA_ANALISAR'\\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.3 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.2\\r\\n        THEN 'EXCLUSAO_ALTA_SUSPEITA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS legitimidade_exclusao,\\r\\n    \\r\\n    -- Score de Efetividade do Tipo (0-100)\\r\\n    ROUND(\\r\\n        -- 40% baseado em autua\\u00e7\\u00f5es (quanto maior, mais efetivo)\\r\\n        (COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 40.0 / NULLIF(COUNT(*), 0)) +\\r\\n        -- 30% baseado em resolu\\u00e7\\u00e3o (autonoma OU fiscal)\\r\\n        ((COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) + \\r\\n          COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END)) * 30.0 / NULLIF(COUNT(*), 0)) +\\r\\n        -- 30% baseado em baixa exclus\\u00e3o injustificada\\r\\n        ((1 - (COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0))) * 30)\\r\\n    , 2) AS score_efetividade_tipo,\\r\\n    \\r\\n    -- Per\\u00edodos de Atividade\\r\\n    MIN(id.nu_per_ref) AS periodo_primeira_geracao,\\r\\n    MAX(id.nu_per_ref) AS periodo_ultima_geracao,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nINNER JOIN niat.mlh_inconsistencias_detalhadas id ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\nGROUP BY \\r\\n    cat.cd_inconsistencia, cat.nm_inconsistencia, cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida, cat.flag_tem_valor_fiscal\\r\\nHAVING COUNT(*) >= 10;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.2. PERFORMANCE DOS CONTADORES (FOCO EM AUTONOMIA)\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_performance_contadores STORED AS PARQUET AS\\r\\nWITH empresas_contador AS (\\r\\n    SELECT DISTINCT\\r\\n        eb.nu_cpf_cnpj_contador,\\r\\n        eb.nm_contador,\\r\\n        eb.nu_crc_contador,\\r\\n        eb.cd_munic_contador,\\r\\n        eb.cd_uf_contador,\\r\\n        eb.nu_cnpj\\r\\n    FROM niat.mlh_empresas_base eb\\r\\n    WHERE eb.nu_cpf_cnpj_contador IS NOT NULL\\r\\n),\\r\\ninconsistencias_contador AS (\\r\\n    SELECT\\r\\n        ec.nu_cpf_cnpj_contador,\\r\\n        ec.nm_contador,\\r\\n        ec.nu_crc_contador,\\r\\n        ec.cd_munic_contador,\\r\\n        ec.cd_uf_contador,\\r\\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_com_incons,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\\r\\n        \\r\\n        -- Por Canal de Resolu\\u00e7\\u00e3o (M\\u00c9TRICA CHAVE)\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma_total,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\\r\\n        \\r\\n        -- Por Natureza de Inconsist\\u00eancia\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'OMISSAO' THEN 1 END) AS qtd_omissao,\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'CREDITO_INDEVIDO' THEN 1 END) AS qtd_credito_indevido,\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'DIVERGENCIA_VALOR_MENOR' THEN 1 END) AS qtd_divergencia,\\r\\n        \\r\\n        -- Tipos Distintos\\r\\n        COUNT(DISTINCT id.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n        \\r\\n        -- Tempo\\r\\n        AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n        AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n        AVG(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN id.dias_ciclo_total END) AS media_dias_resolucao_fiscal\\r\\n        \\r\\n    FROM empresas_contador ec\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ec.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ec.nu_cpf_cnpj_contador, ec.nm_contador, ec.nu_crc_contador, \\r\\n             ec.cd_munic_contador, ec.cd_uf_contador\\r\\n)\\r\\nSELECT\\r\\n    ic.nu_cpf_cnpj_contador,\\r\\n    ic.nm_contador,\\r\\n    ic.nu_crc_contador,\\r\\n    ic.cd_munic_contador,\\r\\n    ic.cd_uf_contador,\\r\\n    \\r\\n    -- Carteira de Clientes\\r\\n    COUNT(DISTINCT ec.nu_cnpj) AS qtd_clientes_total,\\r\\n    ic.qtd_empresas_com_incons,\\r\\n    ROUND(ic.qtd_empresas_com_incons * 100.0 / NULLIF(COUNT(DISTINCT ec.nu_cnpj), 0), 2) AS taxa_clientes_com_incons_pct,\\r\\n    \\r\\n    -- Inconsist\\u00eancias\\r\\n    ic.qtd_total_inconsistencias,\\r\\n    ic.valor_total_inconsistencias,\\r\\n    ROUND(ic.valor_total_inconsistencias / NULLIF(ic.qtd_empresas_com_incons, 0), 2) AS valor_medio_por_empresa,\\r\\n    \\r\\n    -- Resolu\\u00e7\\u00e3o por Canal (FOCO PRINCIPAL)\\r\\n    ic.qtd_resolvidas_dde,\\r\\n    ic.qtd_resolvidas_malha_auto,\\r\\n    ic.qtd_resolucao_autonoma_total,\\r\\n    ic.qtd_resolvidas_fiscalizacao,\\r\\n    ic.qtd_excluidas_auditor,\\r\\n    ic.qtd_ativas,\\r\\n    ic.qtd_autuacoes,\\r\\n    \\r\\n    -- Taxas de Autonomia (M\\u00c9TRICA CHAVE)\\r\\n    ROUND(ic.qtd_resolucao_autonoma_total * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_autonomia_pct,\\r\\n    ROUND(ic.qtd_resolvidas_dde * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_resolucao_dde_pct,\\r\\n    ROUND(ic.qtd_ativas * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_pendencia_pct,\\r\\n    ROUND(ic.qtd_autuacoes * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_autuacao_pct,\\r\\n    ROUND(ic.qtd_excluidas_auditor * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Padr\\u00f5es de Inconsist\\u00eancias\\r\\n    ic.qtd_tipos_inconsistencia,\\r\\n    ic.qtd_omissao,\\r\\n    ic.qtd_credito_indevido,\\r\\n    ic.qtd_divergencia,\\r\\n    \\r\\n    -- Performance Temporal\\r\\n    ic.media_dias_malha,\\r\\n    ic.media_dias_resolucao_autonoma,\\r\\n    ic.media_dias_resolucao_fiscal,\\r\\n    \\r\\n    -- Score de Performance do Contador (0-100)\\r\\n    ROUND(\\r\\n        -- 50% baseado em autonomia (quanto mais resolve sozinho, melhor)\\r\\n        (ic.qtd_resolucao_autonoma_total * 50.0 / NULLIF(ic.qtd_total_inconsistencias, 0)) +\\r\\n        -- 30% baseado em baixa pend\\u00eancia (quanto menos pendente, melhor)\\r\\n        ((1 - (ic.qtd_ativas * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0))) * 30) +\\r\\n        -- 20% baseado em baixa autua\\u00e7\\u00e3o (quanto menos autua\\u00e7\\u00e3o, melhor)\\r\\n        ((1 - (ic.qtd_autuacoes * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0))) * 20)\\r\\n    , 2) AS score_performance,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Performance\\r\\n    CASE \\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'EXCELENTE_AUTONOMIA'\\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.5 \\r\\n        THEN 'BOA_AUTONOMIA'\\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.3 \\r\\n        THEN 'AUTONOMIA_REGULAR'\\r\\n        WHEN ic.qtd_autuacoes * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.3 \\r\\n        THEN 'ALTO_RISCO_AUTUACAO'\\r\\n        WHEN ic.qtd_ativas * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS classificacao_performance,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM inconsistencias_contador ic\\r\\nLEFT JOIN empresas_contador ec ON ic.nu_cpf_cnpj_contador = ec.nu_cpf_cnpj_contador\\r\\nGROUP BY \\r\\n    ic.nu_cpf_cnpj_contador, ic.nm_contador, ic.nu_crc_contador,\\r\\n    ic.cd_munic_contador, ic.cd_uf_contador,\\r\\n    ic.qtd_empresas_com_incons, ic.qtd_total_inconsistencias, ic.valor_total_inconsistencias,\\r\\n    ic.qtd_resolvidas_dde, ic.qtd_resolvidas_malha_auto, ic.qtd_resolucao_autonoma_total,\\r\\n    ic.qtd_resolvidas_fiscalizacao, ic.qtd_excluidas_auditor, ic.qtd_ativas, ic.qtd_autuacoes,\\r\\n    ic.qtd_tipos_inconsistencia, ic.qtd_omissao, ic.qtd_credito_indevido, ic.qtd_divergencia,\\r\\n    ic.media_dias_malha, ic.media_dias_resolucao_autonoma, ic.media_dias_resolucao_fiscal;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: TABELA 2.3 - PERFORMANCE DE DAFs (CORRIGIDA)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_performance_dafs;\", \"\\r\\n\\r\\nCREATE TABLE niat.mlh_performance_dafs STORED AS PARQUET AS\\r\\nWITH empresas_por_daf AS (\\r\\n    SELECT DISTINCT\\r\\n        eb.id_equipe,\\r\\n        eb.nu_cnpj\\r\\n    FROM niat.mlh_empresas_base eb\\r\\n    WHERE eb.id_equipe IS NOT NULL\\r\\n),\\r\\ninconsistencias_daf AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_acompanhadas,\\r\\n        COUNT(DISTINCT eb.nu_cpf_cnpj_contador) AS qtd_contadores_acompanhados,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\\r\\n        \\r\\n        -- Por Canal de Resolu\\u00e7\\u00e3o (CORRIGIDO - foco no que \\u00e9 PROBLEMA)\\r\\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO_CONCLUIDA' THEN 1 END) AS qtd_fiscalizacao_total,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'EM_FISCALIZACAO' THEN 1 END) AS qtd_em_fiscalizacao,\\r\\n        COUNT(CASE WHEN id.subcanal_fiscalizacao = 'FISCALIZACAO_COM_AUTUACAO' THEN 1 END) AS qtd_autuacoes,\\r\\n        COUNT(CASE WHEN id.subcanal_fiscalizacao = 'FISCALIZACAO_SEM_AUTUACAO' THEN 1 END) AS qtd_fiscalizacao_resolvida,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'IDENTIFICADA' THEN 1 END) AS qtd_identificadas,\\r\\n\\r\\n        -- Tipos\\r\\n        COUNT(DISTINCT id.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n        \\r\\n        -- Tempo\\r\\n        AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n        AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma\\r\\n        \\r\\n    FROM empresas_por_daf ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    LEFT JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n)\\r\\nSELECT\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    qtd_total_inconsistencias,\\r\\n    valor_total_inconsistencias,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Status (para entendimento do funil)\\r\\n    qtd_identificadas,\\r\\n    qtd_ativas,\\r\\n    qtd_resolucao_autonoma,\\r\\n    qtd_em_fiscalizacao,\\r\\n    qtd_fiscalizacao_total,\\r\\n    qtd_autuacoes,\\r\\n    qtd_excluidas_auditor,\\r\\n    \\r\\n    -- Taxas B\\u00e1sicas\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_autonomia_pct,\\r\\n    ROUND(qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_exclusao_pct,\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_autuacao_pct,\\r\\n    ROUND(qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_ativas_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- INDICADORES CORRIGIDOS - INTERPRETA\\u00c7\\u00c3O ADEQUADA DO FLUXO\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- 1. INDICADOR DE AUTONOMIA (quanto maior, melhor)\\r\\n    -- Empresas que resolvem sozinhas = EXCELENTE\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_autonomia_pct,\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.70 THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.50 THEN 'BOM'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.35 THEN 'REGULAR'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.20 THEN 'BAIXO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_autonomia_nivel,\\r\\n    \\r\\n    -- 2. INDICADOR DE ATIVAS (NEUTRO - n\\u00e3o \\u00e9 problema, \\u00e9 prazo normal)\\r\\n    -- Aqui s\\u00f3 monitoramos se est\\u00e1 muito alta (pode indicar lentid\\u00e3o)\\r\\n    ROUND(qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_ativas_pct,\\r\\n    CASE \\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 'NORMAL'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ATENCAO_VOLUME'\\r\\n        ELSE 'ALTO_VOLUME'\\r\\n    END AS ind_ativas_nivel,\\r\\n    \\r\\n    -- 3. INDICADOR DE FISCALIZA\\u00c7\\u00c3O (quanto MAIOR, PIOR - \\u00c9 O PROBLEMA!)\\r\\n    -- Inconsist\\u00eancias que precisaram de PAF = N\\u00c3O regularizaram no prazo\\r\\n    ROUND((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_fiscalizacao_pct,\\r\\n    CASE \\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'EXCELENTE'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'BOM'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.35 THEN 'REGULAR'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_fiscalizacao_nivel,\\r\\n    \\r\\n    -- 4. INDICADOR DE AUTUA\\u00c7\\u00c3O (quanto menor, melhor - \\u00e9 o mais grave)\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_autuacao_pct,\\r\\n    CASE \\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.05 THEN 'EXCELENTE'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'BOM'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'REGULAR'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_autuacao_nivel,\\r\\n    \\r\\n    -- 5. INDICADOR DE EXCLUS\\u00c3O (quanto menor, melhor - pode indicar problema)\\r\\n    ROUND(qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_exclusao_pct,\\r\\n    CASE \\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'EXCELENTE'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'BOM'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.35 THEN 'REGULAR'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_exclusao_nivel,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- M\\u00c9TRICAS ADICIONAIS IMPORTANTES\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Taxa de convers\\u00e3o: das que foram para fiscaliza\\u00e7\\u00e3o, quantas viraram autua\\u00e7\\u00e3o\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_fiscalizacao_total + qtd_em_fiscalizacao, 0), 2) AS taxa_conversao_fiscalizacao_autuacao,\\r\\n    \\r\\n    -- Taxa de efetividade: resolveram + autuaram (n\\u00e3o foram exclu\\u00eddas indevidamente)\\r\\n    ROUND((qtd_resolucao_autonoma + qtd_autuacoes) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_efetividade_geral,\\r\\n    \\r\\n    -- Taxa de necessidade de fiscaliza\\u00e7\\u00e3o (complemento da autonomia)\\r\\n    ROUND((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_necessidade_fiscalizacao,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- SCORES NUM\\u00c9RICOS (0-100) CORRIGIDOS\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Score de Autonomia (0-100): quanto maior, melhor\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS score_autonomia,\\r\\n    \\r\\n    -- Score de Fiscaliza\\u00e7\\u00e3o (0-100): invertido - quanto MENOS for para fiscaliza\\u00e7\\u00e3o, melhor\\r\\n    ROUND((1 - ((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0))) * 100, 2) AS score_fiscalizacao,\\r\\n    \\r\\n    -- Score de Exclus\\u00e3o (0-100): quanto menor exclus\\u00e3o, melhor\\r\\n    ROUND((1 - (qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0))) * 100, 2) AS score_exclusao,\\r\\n    \\r\\n    -- Score de Autua\\u00e7\\u00e3o (0-100): balanceado - queremos um meio termo\\r\\n    ROUND(\\r\\n        CASE \\r\\n            -- Ideal entre 5-15%: score m\\u00e1ximo (100)\\r\\n            WHEN CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) BETWEEN 0.05 AND 0.15 THEN 100.0\\r\\n            -- Acima de 15%: penaliza progressivamente\\r\\n            WHEN CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) > 0.15 \\r\\n            THEN GREATEST(0.0, 100.0 - ((CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) - 0.15) * 250.0))\\r\\n            -- Abaixo de 5%: penaliza levemente (pode indicar exclus\\u00e3o excessiva)\\r\\n            ELSE (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) * 2000.0)\\r\\n        END\\r\\n    , 2) AS score_autuacao,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- SCORE GERAL PONDERADO CORRIGIDO (0-100)\\r\\n    -- ========================================================================\\r\\n    ROUND(\\r\\n        -- 40% Autonomia (peso maior - \\u00e9 o ideal)\\r\\n        (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n        \\r\\n        -- 30% Baixa necessidade de Fiscaliza\\u00e7\\u00e3o (invertido - quanto MENOS fiscaliza\\u00e7\\u00e3o, melhor)\\r\\n        ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                  NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n        \\r\\n        -- 20% Baixa Autua\\u00e7\\u00e3o (invertido - quanto menos autua\\u00e7\\u00e3o, melhor)\\r\\n        ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n        \\r\\n        -- 10% Baixa Exclus\\u00e3o (invertido - quanto menos exclus\\u00e3o suspeita, melhor)\\r\\n        ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n    , 2) AS score_geral_ponderado,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- CLASSIFICA\\u00c7\\u00c3O GERAL CORRIGIDA\\r\\n    -- ========================================================================\\r\\n    CASE \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 80.0 THEN 'EXCELENTE'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 65.0 THEN 'BOM'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 50.0 THEN 'REGULAR'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 35.0 THEN 'ATENCAO'\\r\\n        \\r\\n        ELSE 'CRITICO'\\r\\n    END AS classificacao_geral,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- FLAGS DE ALERTA CORRIGIDAS\\r\\n    -- ========================================================================\\r\\n    CASE WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 1 ELSE 0 END AS flag_alerta_autonomia_baixa,\\r\\n    CASE WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.40 THEN 1 ELSE 0 END AS flag_alerta_fiscalizacao_alta,\\r\\n    CASE WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.25 THEN 1 ELSE 0 END AS flag_alerta_autuacao_alta,\\r\\n    CASE WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.40 THEN 1 ELSE 0 END AS flag_alerta_exclusao_alta,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM inconsistencias_daf\\r\\nWHERE qtd_total_inconsistencias >= 100;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: AN\\u00c1LISE DE EXCLUS\\u00d5ES E LEGITIMIDADE\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.1. AN\\u00c1LISE DE EXCLUS\\u00d5ES POR AUDITOR/DAF\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_analise_exclusoes_auditores STORED AS PARQUET AS\\r\\nWITH exclusoes_por_tipo AS (\\r\\n    SELECT\\r\\n        eb.id_equipe AS id_equipe_auditor,\\r\\n        id.cd_inconsistencia,\\r\\n        id.nm_inconsistencia,\\r\\n        ben.legitimidade_exclusao AS legitimidade_tipo,\\r\\n        ben.taxa_exclusao_esperada_pct,\\r\\n        \\r\\n        COUNT(*) AS qtd_inconsistencias_tipo,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_tipo,\\r\\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes_tipo\\r\\n    FROM niat.mlh_inconsistencias_detalhadas id\\r\\n    INNER JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\\r\\n    LEFT JOIN niat.mlh_benchmark_tipo_inconsistencia ben ON id.cd_inconsistencia = ben.cd_inconsistencia\\r\\n    WHERE eb.id_equipe IS NOT NULL\\r\\n    GROUP BY eb.id_equipe, id.cd_inconsistencia, id.nm_inconsistencia, \\r\\n             ben.legitimidade_exclusao, ben.taxa_exclusao_esperada_pct\\r\\n)\\r\\nSELECT\\r\\n    id_equipe_auditor,\\r\\n    \\r\\n    -- Totais\\r\\n    SUM(qtd_inconsistencias_tipo) AS qtd_total_inconsistencias,\\r\\n    SUM(qtd_excluidas_tipo) AS qtd_total_excluidas,\\r\\n    SUM(qtd_autuacoes_tipo) AS qtd_total_autuacoes,\\r\\n    \\r\\n    -- Taxa Geral de Exclus\\u00e3o\\r\\n    ROUND(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0), 2) AS taxa_exclusao_geral_pct,\\r\\n    \\r\\n    -- Exclus\\u00f5es por Legitimidade\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_legitimas,\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_suspeitas,\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_MEDIA_ANALISAR' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_analisar,\\r\\n    \\r\\n    -- Taxas Ajustadas\\r\\n    ROUND(SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 100.0 / \\r\\n          NULLIF(SUM(qtd_excluidas_tipo), 0), 2) AS taxa_exclusao_suspeita_pct,\\r\\n    \\r\\n    -- Desvio da Taxa Esperada (m\\u00e9dia ponderada)\\r\\n    ROUND(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n          AVG(taxa_exclusao_esperada_pct), 2) AS desvio_taxa_esperada,\\r\\n    \\r\\n    -- Score de Legitimidade das Exclus\\u00f5es (0-100)\\r\\n    ROUND(\\r\\n        -- 50% baseado em baixa exclus\\u00e3o suspeita\\r\\n        ((1 - (SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n               NULLIF(SUM(qtd_excluidas_tipo), 0))) * 50) +\\r\\n        -- 30% baseado em autua\\u00e7\\u00f5es (se exclui pouco e autua muito, \\u00e9 bom)\\r\\n        (SUM(qtd_autuacoes_tipo) * 30.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0)) +\\r\\n        -- 20% baseado em estar pr\\u00f3ximo da taxa esperada\\r\\n        (CASE \\r\\n            WHEN ABS(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n                     AVG(taxa_exclusao_esperada_pct)) < 10 THEN 20\\r\\n            WHEN ABS(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n                     AVG(taxa_exclusao_esperada_pct)) < 20 THEN 10\\r\\n            ELSE 0\\r\\n         END)\\r\\n    , 2) AS score_legitimidade,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.5 \\r\\n        THEN 'ALTA_SUSPEITA'\\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.3 \\r\\n        THEN 'MEDIA_SUSPEITA'\\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.7 \\r\\n        THEN 'EXCLUSOES_LEGITIMAS'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS classificacao_exclusoes,\\r\\n    \\r\\n    -- Tipos de Inconsist\\u00eancia Distintos\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM exclusoes_por_tipo\\r\\nGROUP BY id_equipe_auditor\\r\\nHAVING SUM(qtd_inconsistencias_tipo) >= 50;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 4: AN\\u00c1LISE TEMPORAL E TEND\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.1. EVOLU\\u00c7\\u00c3O MENSAL DAS MALHAS FISCAIS\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_evolucao_mensal STORED AS PARQUET AS\\r\\nSELECT\\r\\n    nu_per_ref AS periodo,\\r\\n    \\r\\n    -- Contagens\\r\\n    COUNT(DISTINCT nu_cnpj) AS qtd_empresas_periodo,\\r\\n    COUNT(*) AS qtd_inconsistencias_identificadas,\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- Valores\\r\\n    SUM(CASE WHEN flag_tem_valor_fiscal = 1 THEN vl_inconsistencia ELSE 0 END) AS valor_total_identificado,\\r\\n    AVG(CASE WHEN flag_tem_valor_fiscal = 1 THEN vl_inconsistencia END) AS valor_medio_inconsistencia,\\r\\n    \\r\\n    -- Por Canal de Resolu\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n    COUNT(CASE WHEN flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n    COUNT(CASE WHEN flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN nu_os IS NOT NULL THEN 1 END) AS qtd_gerou_os,\\r\\n    COUNT(CASE WHEN flag_gerou_infracao = 1 THEN 1 END) AS qtd_gerou_infracao,\\r\\n    \\r\\n    -- Taxas Principais\\r\\n    ROUND(COUNT(CASE WHEN flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autonomia_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_exclusao_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autuacao_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    AVG(dias_na_malha) AS media_dias_malha,\\r\\n    AVG(CASE WHEN flag_resolucao_autonoma = 1 THEN dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Por Natureza\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'OMISSAO' THEN 1 END) AS qtd_omissao,\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'CREDITO_INDEVIDO' THEN 1 END) AS qtd_credito_indevido,\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'DIVERGENCIA_VALOR_MENOR' THEN 1 END) AS qtd_divergencia,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_inconsistencias_detalhadas\\r\\nWHERE nu_per_ref BETWEEN 202101 AND 202509\\r\\nGROUP BY nu_per_ref\\r\\nORDER BY nu_per_ref;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 5: RANKINGS E DASHBOARDS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 5.1. RANKING DE CONTADORES POR AUTONOMIA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_ranking_contadores_autonomia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY taxa_autonomia_pct DESC, qtd_clientes_total DESC) AS ranking_autonomia,\\r\\n    nu_cpf_cnpj_contador,\\r\\n    nm_contador,\\r\\n    nu_crc_contador,\\r\\n    cd_munic_contador,\\r\\n    cd_uf_contador,\\r\\n    \\r\\n    -- M\\u00e9tricas Chave\\r\\n    qtd_clientes_total,\\r\\n    qtd_empresas_com_incons,\\r\\n    qtd_total_inconsistencias,\\r\\n    valor_total_inconsistencias,\\r\\n    \\r\\n    -- Autonomia (M\\u00c9TRICA PRINCIPAL)\\r\\n    taxa_autonomia_pct,\\r\\n    qtd_resolucao_autonoma_total,\\r\\n    qtd_resolvidas_dde,\\r\\n    \\r\\n    -- Outras Taxas\\r\\n    taxa_pendencia_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    score_performance,\\r\\n    classificacao_performance,\\r\\n    \\r\\n    -- Quartil de Autonomia\\r\\n    NTILE(4) OVER (ORDER BY taxa_autonomia_pct) AS quartil_autonomia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Geral\\r\\n    CASE \\r\\n        WHEN taxa_autonomia_pct >= 70 AND taxa_autuacao_pct < 10 THEN 'TOP_PERFORMER'\\r\\n        WHEN taxa_autonomia_pct >= 50 AND taxa_autuacao_pct < 20 THEN 'BOM_PERFORMER'\\r\\n        WHEN taxa_autonomia_pct >= 30 THEN 'REGULAR'\\r\\n        WHEN taxa_autuacao_pct > 30 THEN 'CRITICO_AUTUACOES'\\r\\n        WHEN taxa_pendencia_pct > 70 THEN 'CRITICO_PENDENCIAS'\\r\\n        ELSE 'NECESSITA_ATENCAO'\\r\\n    END AS classificacao_geral,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_performance_contadores\\r\\nWHERE qtd_empresas_com_incons >= 3\\r\\nORDER BY taxa_autonomia_pct DESC;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ============================================================================\\r\\n-- SISTEMA DE MONITORAMENTO E GEST\\u00c3O DE MALHAS FISCAIS - DAFs V2.0\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: TABELAS FUNDAMENTAIS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.1. CAT\\u00c1LOGO DE TIPOS DE INCONSIST\\u00caNCIAS\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_catalogo_tipos_inconsistencia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    t.cd_inconsistencia,\\r\\n    t.nm_inconsistencia,\\r\\n    t.cd_tipo_infracao,\\r\\n    \\r\\n    -- Status e Visibilidade\\r\\n    CAST(t.sn_ativa AS STRING) AS flag_tipo_ativo,\\r\\n    t.cd_visibilidade,\\r\\n    t.cd_forma_regularizacao,\\r\\n    \\r\\n    -- Valores de Corte\\r\\n    t.vl_individual_min AS valor_minimo_malha,\\r\\n    t.vl_mensal_min AS valor_mensal_minimo,\\r\\n    t.nu_per_ini AS periodo_inicio_vigencia,\\r\\n    \\r\\n    -- Impactos\\r\\n    t.sn_regularidade_ttd AS flag_impacta_regularidade,\\r\\n    t.sn_dashboard AS flag_aparece_dashboard,\\r\\n    CAST(t.sn_bloqueada AS STRING) AS flag_tipo_bloqueado,\\r\\n    t.de_bloqueada AS motivo_bloqueio,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o por Natureza da Inconsist\\u00eancia\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o%' OR t.nm_inconsistencia LIKE '%n\\u00e3o escriturada%' \\r\\n        THEN 'OMISSAO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Cr\\u00e9dito indevido%' OR t.nm_inconsistencia LIKE '%Cr\\u00e9dito Indevido%'\\r\\n        THEN 'CREDITO_INDEVIDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%menor que%' OR t.nm_inconsistencia LIKE '%D\\u00e9bito de ICMS declarado na EFD menor%'\\r\\n        THEN 'DIVERGENCIA_VALOR_MENOR'\\r\\n        WHEN t.nm_inconsistencia LIKE '%maior que%'\\r\\n        THEN 'DIVERGENCIA_VALOR_MAIOR'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Saldo%'\\r\\n        THEN 'DIVERGENCIA_SALDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%cancelad%' OR t.nm_inconsistencia LIKE '%inexistente%'\\r\\n        THEN 'DOCUMENTO_INVALIDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Estorno%'\\r\\n        THEN 'ESTORNO_IRREGULAR'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS natureza_inconsistencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o por Gravidade Presumida\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Cr\\u00e9dito indevido%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%n\\u00e3o escriturada%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%cancelad%' THEN 'MEDIA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%menor que%' THEN 'MEDIA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%maior que%' THEN 'BAIXA'\\r\\n        ELSE 'MEDIA'\\r\\n    END AS gravidade_presumida,\\r\\n    \\r\\n    -- Flag se tem valor monet\\u00e1rio associado\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o de entrega%' THEN 0\\r\\n        ELSE 1\\r\\n    END AS flag_tem_valor_fiscal,\\r\\n    \\r\\n    -- Metadados\\r\\n    t.dt_publicacao,\\r\\n    t.dt_inclusao,\\r\\n    t.dt_alteracao,\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha_trans.mlh_incons_tipo t;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.2. EMPRESAS NA MALHA FISCAL - BASE CONSOLIDADA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_empresas_base STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    ei.nu_cnpj,\\r\\n    ei.nu_cnpj_grupo,\\r\\n    ei.nu_cpf,\\r\\n    ei.nu_ie,\\r\\n    ei.id_equipe,\\r\\n    \\r\\n    -- Informa\\u00e7\\u00f5es Cadastrais\\r\\n    c.nm_razao_social,\\r\\n    c.nm_fantasia,\\r\\n    c.cd_sit_cadastral,\\r\\n    c.nm_sit_cadastral,\\r\\n    c.cd_reg_apuracao,\\r\\n    c.nm_reg_apuracao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Econ\\u00f4mica\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS cnae_divisao,\\r\\n    c.de_classe AS desc_cnae,\\r\\n    c.cd_secao AS secao_cnae,\\r\\n    c.de_secao AS desc_secao,\\r\\n    \\r\\n    -- Localiza\\u00e7\\u00e3o\\r\\n    c.cd_gerfe,\\r\\n    c.nm_gerfe,\\r\\n    c.cd_ges,\\r\\n    c.nm_ges,\\r\\n    c.cd_munic,\\r\\n    c.nm_munic,\\r\\n    c.cd_uf,\\r\\n    \\r\\n    -- Contador Respons\\u00e1vel\\r\\n    c.nu_cpf_cnpj_contador,\\r\\n    c.nm_contador,\\r\\n    c.nu_crc_contador,\\r\\n    c.dt_ini_relac_contador,\\r\\n    c.cd_munic_contador,\\r\\n    c.cd_uf_contador,\\r\\n    \\r\\n    -- Caracter\\u00edsticas da Empresa\\r\\n    c.cd_tipo_contribuinte,\\r\\n    c.nm_tipo_contribuinte,\\r\\n    c.cd_enq_empresa,\\r\\n    c.nm_enq_empresa,\\r\\n    c.cd_natureza_juridica,\\r\\n    c.nm_natureza_juridica,\\r\\n    c.sn_simples_nacional_rfb,\\r\\n    c.sn_dtec,\\r\\n    c.dt_credenciamento_dtec,\\r\\n    c.sn_suspensao_dfe,\\r\\n    c.dt_suspensao_dfe,\\r\\n    c.sn_matriz,\\r\\n    c.sn_apur_consolidada,\\r\\n    c.sn_estab_consolidado,\\r\\n    c.sn_estab_consolidador,\\r\\n    \\r\\n    -- V\\u00ednculos\\r\\n    c.qt_vinculos,\\r\\n    c.qt_vinculos_ativos,\\r\\n    c.qt_socios,\\r\\n    c.qt_socios_ativos,\\r\\n    \\r\\n    -- Agregados de Inconsist\\u00eancias\\r\\n    COUNT(DISTINCT ei.cd_inconsistencia) AS qtd_tipos_inconsistencia_historico,\\r\\n    SUM(ei.qt_incons_existentes) AS qtd_total_inconsistencias_historico,\\r\\n    SUM(ei.vl_incons_existentes) AS valor_total_inconsistencias_historico,\\r\\n    \\r\\n    -- Status Atual na Malha\\r\\n    MAX(CASE WHEN ei.dt_saiu_malha IS NULL THEN 1 ELSE 0 END) AS flag_atualmente_em_malha,\\r\\n    SUM(CASE WHEN ei.dt_saiu_malha IS NULL THEN ei.qt_incons_existentes ELSE 0 END) AS qtd_inconsistencias_ativas,\\r\\n    SUM(CASE WHEN ei.dt_saiu_malha IS NULL THEN ei.vl_incons_existentes ELSE 0 END) AS valor_inconsistencias_ativas,\\r\\n    \\r\\n    -- Datas\\r\\n    MIN(ei.dt_entrou_malha) AS dt_primeira_entrada_malha,\\r\\n    MAX(ei.dt_entrou_malha) AS dt_ultima_entrada_malha,\\r\\n    MAX(ei.dt_saiu_malha) AS dt_ultima_saida_malha,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha.mlh_empresa_incons ei\\r\\nINNER JOIN usr_sat_ods.vw_ods_contrib c ON ei.nu_cnpj = c.nu_cnpj\\r\\nGROUP BY \\r\\n    ei.nu_cnpj, ei.nu_cnpj_grupo, ei.nu_cpf, ei.nu_ie, ei.id_equipe,\\r\\n    c.nm_razao_social, c.nm_fantasia, c.cd_sit_cadastral, c.nm_sit_cadastral,\\r\\n    c.cd_reg_apuracao, c.nm_reg_apuracao,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5), SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2),\\r\\n    c.de_classe, c.cd_secao, c.de_secao,\\r\\n    c.cd_gerfe, c.nm_gerfe, c.cd_ges, c.nm_ges, c.cd_munic, c.nm_munic, c.cd_uf,\\r\\n    c.nu_cpf_cnpj_contador, c.nm_contador, c.nu_crc_contador, c.dt_ini_relac_contador,\\r\\n    c.cd_munic_contador, c.cd_uf_contador,\\r\\n    c.cd_tipo_contribuinte, c.nm_tipo_contribuinte, c.cd_enq_empresa, c.nm_enq_empresa,\\r\\n    c.cd_natureza_juridica, c.nm_natureza_juridica, c.sn_simples_nacional_rfb,\\r\\n    c.sn_dtec, c.dt_credenciamento_dtec, c.sn_suspensao_dfe, c.dt_suspensao_dfe,\\r\\n    c.sn_matriz, c.sn_apur_consolidada, c.sn_estab_consolidado, c.sn_estab_consolidador,\\r\\n    c.qt_vinculos, c.qt_vinculos_ativos, c.qt_socios, c.qt_socios_ativos;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.3. INCONSIST\\u00caNCIAS DETALHADAS - HIST\\u00d3RICO COMPLETO\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_inconsistencias_detalhadas STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    d.nu_cnpj,\\r\\n    d.nu_ie,\\r\\n    d.nu_per_ref,\\r\\n    d.nu_per_ref_identificado,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o da Inconsist\\u00eancia\\r\\n    d.cd_inconsistencia,\\r\\n    t.nm_inconsistencia,\\r\\n    t.natureza_inconsistencia,\\r\\n    t.gravidade_presumida,\\r\\n    t.flag_tem_valor_fiscal,\\r\\n    t.cd_tipo_infracao,\\r\\n    d.tx_chave_inconsistencia,\\r\\n    d.vl_inconsistencia,\\r\\n    \\r\\n    -- Ciclo de Vida\\r\\n    d.cd_situacao,\\r\\n    d.dt_identificada,\\r\\n    d.dt_entrou_malha,\\r\\n    d.dt_saiu_malha,\\r\\n    d.dt_resolvida_malha,\\r\\n    d.dt_em_fiscalizacao,\\r\\n    \\r\\n    -- Canal de Resolu\\u00e7\\u00e3o (PRINCIPAL M\\u00c9TRICA) - CORRIGIDO\\r\\n    CASE \\r\\n        -- 1. Resolvido autonomamente via DDE (melhor cen\\u00e1rio)\\r\\n        WHEN d.id_resolvido_dde IS NOT NULL THEN 'AUTONOMO_DDE'\\r\\n        \\r\\n        -- 2. Resolvido autonomamente via malha (retifica\\u00e7\\u00e3o)\\r\\n        WHEN d.dt_resolvida_malha IS NOT NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL \\r\\n             AND d.id_resolvido_dde IS NULL \\r\\n        THEN 'AUTONOMO_MALHA'\\r\\n        \\r\\n        -- 3. Exclu\\u00eddo por auditor (antes de ir para fiscaliza\\u00e7\\u00e3o)\\r\\n        WHEN d.dt_saiu_malha IS NOT NULL \\r\\n             AND d.dt_resolvida_malha IS NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL \\r\\n             AND d.id_resolvido_dde IS NULL\\r\\n             AND d.dt_em_fiscalizacao IS NULL\\r\\n        THEN 'EXCLUSAO_AUDITOR'\\r\\n        \\r\\n        -- 4. Em fiscaliza\\u00e7\\u00e3o (PAF aberto, mas sem autua\\u00e7\\u00e3o ainda)\\r\\n        WHEN d.dt_em_fiscalizacao IS NOT NULL \\r\\n             AND d.nu_infracao IS NULL\\r\\n             AND d.dt_saiu_malha IS NULL\\r\\n        THEN 'EM_FISCALIZACAO'\\r\\n        \\r\\n        -- 5. Fiscaliza\\u00e7\\u00e3o conclu\\u00edda (passou por PAF, pode ter sido resolvida ou autuada)\\r\\n        WHEN d.cd_motivo_resolvido_fiscal IS NOT NULL \\r\\n             OR d.nu_infracao IS NOT NULL\\r\\n        THEN 'FISCALIZACAO_CONCLUIDA'\\r\\n        \\r\\n        -- 6. Ativa (ainda no prazo de regulariza\\u00e7\\u00e3o - N\\u00c3O \\u00c9 PROBLEMA)\\r\\n        WHEN d.dt_entrou_malha IS NOT NULL \\r\\n             AND d.dt_saiu_malha IS NULL \\r\\n             AND d.dt_em_fiscalizacao IS NULL\\r\\n        THEN 'ATIVA'\\r\\n        \\r\\n        -- 7. Apenas identificada (ainda n\\u00e3o entrou na malha)\\r\\n        ELSE 'IDENTIFICADA'\\r\\n    END AS canal_resolucao,\\r\\n    \\r\\n    -- Subcanal detalhado para fiscaliza\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN d.nu_infracao IS NOT NULL THEN 'FISCALIZACAO_COM_AUTUACAO'\\r\\n        WHEN d.cd_motivo_resolvido_fiscal IS NOT NULL AND d.nu_infracao IS NULL THEN 'FISCALIZACAO_SEM_AUTUACAO'\\r\\n        WHEN d.dt_em_fiscalizacao IS NOT NULL AND d.nu_infracao IS NULL THEN 'FISCALIZACAO_EM_ANDAMENTO'\\r\\n        ELSE NULL\\r\\n    END AS subcanal_fiscalizacao,\\r\\n    \\r\\n    -- Detalhes da Resolu\\u00e7\\u00e3o\\r\\n    d.cd_motivo_resolvido_fiscal,\\r\\n    d.id_resolvido_dde,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    d.id_pacote,\\r\\n    d.nu_os,\\r\\n    d.nu_infracao,\\r\\n    d.nu_notificacao,\\r\\n    d.sn_enviar_fisca,\\r\\n    \\r\\n    -- Processamento\\r\\n    d.id_exec_malha,\\r\\n    d.cd_tipo_execucao,\\r\\n    d.dt_processamento,\\r\\n    \\r\\n    -- Detalhes EFD vs NFe\\r\\n    d.id_efd,\\r\\n    d.nu_chave_efd,\\r\\n    d.vl_total_efd,\\r\\n    d.vl_icms_efd,\\r\\n    d.nu_chave_nfe,\\r\\n    d.vl_total_nfe,\\r\\n    d.vl_icms_nfe,\\r\\n    d.dt_cancelamento_nfe,\\r\\n    \\r\\n    -- Tempos (em dias)\\r\\n    DATEDIFF(COALESCE(d.dt_saiu_malha, CURRENT_DATE()), d.dt_entrou_malha) AS dias_na_malha,\\r\\n    DATEDIFF(d.dt_resolvida_malha, d.dt_identificada) AS dias_ate_resolucao,\\r\\n    DATEDIFF(d.dt_em_fiscalizacao, d.dt_entrou_malha) AS dias_ate_fiscalizacao,\\r\\n    DATEDIFF(COALESCE(d.dt_saiu_malha, CURRENT_DATE()), d.dt_identificada) AS dias_ciclo_total,\\r\\n    \\r\\n    -- Flags de An\\u00e1lise\\r\\n    CASE \\r\\n        WHEN d.id_resolvido_dde IS NOT NULL OR \\r\\n             (d.dt_resolvida_malha IS NOT NULL AND d.cd_motivo_resolvido_fiscal IS NULL) \\r\\n        THEN 1 ELSE 0 \\r\\n    END AS flag_resolucao_autonoma,\\r\\n    \\r\\n    CASE \\r\\n        WHEN d.dt_saiu_malha IS NOT NULL AND d.dt_resolvida_malha IS NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL AND d.id_resolvido_dde IS NULL \\r\\n        THEN 1 ELSE 0 \\r\\n    END AS flag_exclusao_auditor,\\r\\n    \\r\\n    CASE WHEN d.nu_infracao IS NOT NULL THEN 1 ELSE 0 END AS flag_gerou_infracao,\\r\\n    \\r\\n    -- Tipo de Inconsist\\u00eancia Categorizado\\r\\n    CASE \\r\\n        WHEN d.nu_chave_nfe IS NOT NULL AND d.nu_chave_efd IS NULL THEN 'OMISSAO_NFE_NA_EFD'\\r\\n        WHEN d.nu_chave_efd IS NOT NULL AND d.nu_chave_nfe IS NULL THEN 'NOTA_FALSA_EFD'\\r\\n        WHEN d.nu_chave_nfe IS NOT NULL AND d.nu_chave_efd IS NOT NULL \\r\\n             AND ABS(d.vl_total_nfe - d.vl_total_efd) > 100 THEN 'DIVERGENCIA_VALOR'\\r\\n        WHEN d.dt_cancelamento_nfe IS NOT NULL THEN 'CANCELAMENTO_NAO_ESTORNADO'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS tipo_detalhado,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha.mlh_efd_nfe_incons d\\r\\nLEFT JOIN niat.mlh_catalogo_tipos_inconsistencia t ON d.cd_inconsistencia = t.cd_inconsistencia;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: AN\\u00c1LISE DE PERFORMANCE POR DIMENS\\u00d5ES\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.1. BENCHMARK POR TIPO DE INCONSIST\\u00caNCIA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_benchmark_tipo_inconsistencia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    cat.flag_tem_valor_fiscal,\\r\\n    \\r\\n    -- Contagens\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    COUNT(*) AS qtd_ocorrencias_total,\\r\\n    COUNT(DISTINCT id.nu_per_ref) AS qtd_periodos_geracao,\\r\\n    \\r\\n    -- Valores (quando aplic\\u00e1vel)\\r\\n    SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total,\\r\\n    AVG(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END) AS valor_medio,\\r\\n    STDDEV(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END) AS valor_desvio_padrao,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Canal de Resolu\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n    COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n    COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\\r\\n    \\r\\n    -- Taxas Esperadas (BENCHMARK)\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autonomia_esperada_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_exclusao_esperada_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Desvio Padr\\u00e3o das Taxas (para detectar anomalias)\\r\\n    STDDEV(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1.0 ELSE 0.0 END) AS desvio_taxa_exclusao,\\r\\n    \\r\\n    -- Tempo M\\u00e9dio de Resolu\\u00e7\\u00e3o\\r\\n    AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n    AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n    STDDEV(id.dias_na_malha) AS desvio_dias_malha,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Facilidade de Resolu\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.7 \\r\\n        THEN 'FACIL_RESOLUCAO'\\r\\n        WHEN COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.4 \\r\\n        THEN 'MEDIA_RESOLUCAO'\\r\\n        ELSE 'DIFICIL_RESOLUCAO'\\r\\n    END AS facilidade_resolucao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Legitimidade de Exclus\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.5 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) < 0.05\\r\\n        THEN 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA'\\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.3 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) < 0.1\\r\\n        THEN 'EXCLUSAO_MEDIA_ANALISAR'\\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.3 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.2\\r\\n        THEN 'EXCLUSAO_ALTA_SUSPEITA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS legitimidade_exclusao,\\r\\n    \\r\\n    -- Score de Efetividade do Tipo (0-100)\\r\\n    ROUND(\\r\\n        -- 40% baseado em autua\\u00e7\\u00f5es (quanto maior, mais efetivo)\\r\\n        (COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 40.0 / NULLIF(COUNT(*), 0)) +\\r\\n        -- 30% baseado em resolu\\u00e7\\u00e3o (autonoma OU fiscal)\\r\\n        ((COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) + \\r\\n          COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END)) * 30.0 / NULLIF(COUNT(*), 0)) +\\r\\n        -- 30% baseado em baixa exclus\\u00e3o injustificada\\r\\n        ((1 - (COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0))) * 30)\\r\\n    , 2) AS score_efetividade_tipo,\\r\\n    \\r\\n    -- Per\\u00edodos de Atividade\\r\\n    MIN(id.nu_per_ref) AS periodo_primeira_geracao,\\r\\n    MAX(id.nu_per_ref) AS periodo_ultima_geracao,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nINNER JOIN niat.mlh_inconsistencias_detalhadas id ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\nGROUP BY \\r\\n    cat.cd_inconsistencia, cat.nm_inconsistencia, cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida, cat.flag_tem_valor_fiscal\\r\\nHAVING COUNT(*) >= 10;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.2. PERFORMANCE DOS CONTADORES (FOCO EM AUTONOMIA)\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_performance_contadores STORED AS PARQUET AS\\r\\nWITH empresas_contador AS (\\r\\n    SELECT DISTINCT\\r\\n        eb.nu_cpf_cnpj_contador,\\r\\n        eb.nm_contador,\\r\\n        eb.nu_crc_contador,\\r\\n        eb.cd_munic_contador,\\r\\n        eb.cd_uf_contador,\\r\\n        eb.nu_cnpj\\r\\n    FROM niat.mlh_empresas_base eb\\r\\n    WHERE eb.nu_cpf_cnpj_contador IS NOT NULL\\r\\n),\\r\\ninconsistencias_contador AS (\\r\\n    SELECT\\r\\n        ec.nu_cpf_cnpj_contador,\\r\\n        ec.nm_contador,\\r\\n        ec.nu_crc_contador,\\r\\n        ec.cd_munic_contador,\\r\\n        ec.cd_uf_contador,\\r\\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_com_incons,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\\r\\n        \\r\\n        -- Por Canal de Resolu\\u00e7\\u00e3o (M\\u00c9TRICA CHAVE)\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma_total,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\\r\\n        \\r\\n        -- Por Natureza de Inconsist\\u00eancia\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'OMISSAO' THEN 1 END) AS qtd_omissao,\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'CREDITO_INDEVIDO' THEN 1 END) AS qtd_credito_indevido,\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'DIVERGENCIA_VALOR_MENOR' THEN 1 END) AS qtd_divergencia,\\r\\n        \\r\\n        -- Tipos Distintos\\r\\n        COUNT(DISTINCT id.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n        \\r\\n        -- Tempo\\r\\n        AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n        AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n        AVG(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN id.dias_ciclo_total END) AS media_dias_resolucao_fiscal\\r\\n        \\r\\n    FROM empresas_contador ec\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ec.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ec.nu_cpf_cnpj_contador, ec.nm_contador, ec.nu_crc_contador, \\r\\n             ec.cd_munic_contador, ec.cd_uf_contador\\r\\n)\\r\\nSELECT\\r\\n    ic.nu_cpf_cnpj_contador,\\r\\n    ic.nm_contador,\\r\\n    ic.nu_crc_contador,\\r\\n    ic.cd_munic_contador,\\r\\n    ic.cd_uf_contador,\\r\\n    \\r\\n    -- Carteira de Clientes\\r\\n    COUNT(DISTINCT ec.nu_cnpj) AS qtd_clientes_total,\\r\\n    ic.qtd_empresas_com_incons,\\r\\n    ROUND(ic.qtd_empresas_com_incons * 100.0 / NULLIF(COUNT(DISTINCT ec.nu_cnpj), 0), 2) AS taxa_clientes_com_incons_pct,\\r\\n    \\r\\n    -- Inconsist\\u00eancias\\r\\n    ic.qtd_total_inconsistencias,\\r\\n    ic.valor_total_inconsistencias,\\r\\n    ROUND(ic.valor_total_inconsistencias / NULLIF(ic.qtd_empresas_com_incons, 0), 2) AS valor_medio_por_empresa,\\r\\n    \\r\\n    -- Resolu\\u00e7\\u00e3o por Canal (FOCO PRINCIPAL)\\r\\n    ic.qtd_resolvidas_dde,\\r\\n    ic.qtd_resolvidas_malha_auto,\\r\\n    ic.qtd_resolucao_autonoma_total,\\r\\n    ic.qtd_resolvidas_fiscalizacao,\\r\\n    ic.qtd_excluidas_auditor,\\r\\n    ic.qtd_ativas,\\r\\n    ic.qtd_autuacoes,\\r\\n    \\r\\n    -- Taxas de Autonomia (M\\u00c9TRICA CHAVE)\\r\\n    ROUND(ic.qtd_resolucao_autonoma_total * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_autonomia_pct,\\r\\n    ROUND(ic.qtd_resolvidas_dde * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_resolucao_dde_pct,\\r\\n    ROUND(ic.qtd_ativas * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_pendencia_pct,\\r\\n    ROUND(ic.qtd_autuacoes * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_autuacao_pct,\\r\\n    ROUND(ic.qtd_excluidas_auditor * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Padr\\u00f5es de Inconsist\\u00eancias\\r\\n    ic.qtd_tipos_inconsistencia,\\r\\n    ic.qtd_omissao,\\r\\n    ic.qtd_credito_indevido,\\r\\n    ic.qtd_divergencia,\\r\\n    \\r\\n    -- Performance Temporal\\r\\n    ic.media_dias_malha,\\r\\n    ic.media_dias_resolucao_autonoma,\\r\\n    ic.media_dias_resolucao_fiscal,\\r\\n    \\r\\n    -- Score de Performance do Contador (0-100)\\r\\n    ROUND(\\r\\n        -- 50% baseado em autonomia (quanto mais resolve sozinho, melhor)\\r\\n        (ic.qtd_resolucao_autonoma_total * 50.0 / NULLIF(ic.qtd_total_inconsistencias, 0)) +\\r\\n        -- 30% baseado em baixa pend\\u00eancia (quanto menos pendente, melhor)\\r\\n        ((1 - (ic.qtd_ativas * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0))) * 30) +\\r\\n        -- 20% baseado em baixa autua\\u00e7\\u00e3o (quanto menos autua\\u00e7\\u00e3o, melhor)\\r\\n        ((1 - (ic.qtd_autuacoes * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0))) * 20)\\r\\n    , 2) AS score_performance,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Performance\\r\\n    CASE \\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'EXCELENTE_AUTONOMIA'\\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.5 \\r\\n        THEN 'BOA_AUTONOMIA'\\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.3 \\r\\n        THEN 'AUTONOMIA_REGULAR'\\r\\n        WHEN ic.qtd_autuacoes * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.3 \\r\\n        THEN 'ALTO_RISCO_AUTUACAO'\\r\\n        WHEN ic.qtd_ativas * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS classificacao_performance,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM inconsistencias_contador ic\\r\\nLEFT JOIN empresas_contador ec ON ic.nu_cpf_cnpj_contador = ec.nu_cpf_cnpj_contador\\r\\nGROUP BY \\r\\n    ic.nu_cpf_cnpj_contador, ic.nm_contador, ic.nu_crc_contador,\\r\\n    ic.cd_munic_contador, ic.cd_uf_contador,\\r\\n    ic.qtd_empresas_com_incons, ic.qtd_total_inconsistencias, ic.valor_total_inconsistencias,\\r\\n    ic.qtd_resolvidas_dde, ic.qtd_resolvidas_malha_auto, ic.qtd_resolucao_autonoma_total,\\r\\n    ic.qtd_resolvidas_fiscalizacao, ic.qtd_excluidas_auditor, ic.qtd_ativas, ic.qtd_autuacoes,\\r\\n    ic.qtd_tipos_inconsistencia, ic.qtd_omissao, ic.qtd_credito_indevido, ic.qtd_divergencia,\\r\\n    ic.media_dias_malha, ic.media_dias_resolucao_autonoma, ic.media_dias_resolucao_fiscal;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: TABELA 2.3 - PERFORMANCE DE DAFs (CORRIGIDA)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_performance_dafs;\\r\\n\\r\\nCREATE TABLE niat.mlh_performance_dafs STORED AS PARQUET AS\\r\\nWITH empresas_por_daf AS (\\r\\n    SELECT DISTINCT\\r\\n        eb.id_equipe,\\r\\n        eb.nu_cnpj\\r\\n    FROM niat.mlh_empresas_base eb\\r\\n    WHERE eb.id_equipe IS NOT NULL\\r\\n),\\r\\ninconsistencias_daf AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_acompanhadas,\\r\\n        COUNT(DISTINCT eb.nu_cpf_cnpj_contador) AS qtd_contadores_acompanhados,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\\r\\n        \\r\\n        -- Por Canal de Resolu\\u00e7\\u00e3o (CORRIGIDO - foco no que \\u00e9 PROBLEMA)\\r\\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO_CONCLUIDA' THEN 1 END) AS qtd_fiscalizacao_total,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'EM_FISCALIZACAO' THEN 1 END) AS qtd_em_fiscalizacao,\\r\\n        COUNT(CASE WHEN id.subcanal_fiscalizacao = 'FISCALIZACAO_COM_AUTUACAO' THEN 1 END) AS qtd_autuacoes,\\r\\n        COUNT(CASE WHEN id.subcanal_fiscalizacao = 'FISCALIZACAO_SEM_AUTUACAO' THEN 1 END) AS qtd_fiscalizacao_resolvida,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'IDENTIFICADA' THEN 1 END) AS qtd_identificadas,\\r\\n\\r\\n        -- Tipos\\r\\n        COUNT(DISTINCT id.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n        \\r\\n        -- Tempo\\r\\n        AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n        AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma\\r\\n        \\r\\n    FROM empresas_por_daf ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    LEFT JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n)\\r\\nSELECT\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    qtd_total_inconsistencias,\\r\\n    valor_total_inconsistencias,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Status (para entendimento do funil)\\r\\n    qtd_identificadas,\\r\\n    qtd_ativas,\\r\\n    qtd_resolucao_autonoma,\\r\\n    qtd_em_fiscalizacao,\\r\\n    qtd_fiscalizacao_total,\\r\\n    qtd_autuacoes,\\r\\n    qtd_excluidas_auditor,\\r\\n    \\r\\n    -- Taxas B\\u00e1sicas\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_autonomia_pct,\\r\\n    ROUND(qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_exclusao_pct,\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_autuacao_pct,\\r\\n    ROUND(qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_ativas_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- INDICADORES CORRIGIDOS - INTERPRETA\\u00c7\\u00c3O ADEQUADA DO FLUXO\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- 1. INDICADOR DE AUTONOMIA (quanto maior, melhor)\\r\\n    -- Empresas que resolvem sozinhas = EXCELENTE\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_autonomia_pct,\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.70 THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.50 THEN 'BOM'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.35 THEN 'REGULAR'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.20 THEN 'BAIXO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_autonomia_nivel,\\r\\n    \\r\\n    -- 2. INDICADOR DE ATIVAS (NEUTRO - n\\u00e3o \\u00e9 problema, \\u00e9 prazo normal)\\r\\n    -- Aqui s\\u00f3 monitoramos se est\\u00e1 muito alta (pode indicar lentid\\u00e3o)\\r\\n    ROUND(qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_ativas_pct,\\r\\n    CASE \\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 'NORMAL'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ATENCAO_VOLUME'\\r\\n        ELSE 'ALTO_VOLUME'\\r\\n    END AS ind_ativas_nivel,\\r\\n    \\r\\n    -- 3. INDICADOR DE FISCALIZA\\u00c7\\u00c3O (quanto MAIOR, PIOR - \\u00c9 O PROBLEMA!)\\r\\n    -- Inconsist\\u00eancias que precisaram de PAF = N\\u00c3O regularizaram no prazo\\r\\n    ROUND((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_fiscalizacao_pct,\\r\\n    CASE \\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'EXCELENTE'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'BOM'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.35 THEN 'REGULAR'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_fiscalizacao_nivel,\\r\\n    \\r\\n    -- 4. INDICADOR DE AUTUA\\u00c7\\u00c3O (quanto menor, melhor - \\u00e9 o mais grave)\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_autuacao_pct,\\r\\n    CASE \\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.05 THEN 'EXCELENTE'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'BOM'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'REGULAR'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_autuacao_nivel,\\r\\n    \\r\\n    -- 5. INDICADOR DE EXCLUS\\u00c3O (quanto menor, melhor - pode indicar problema)\\r\\n    ROUND(qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_exclusao_pct,\\r\\n    CASE \\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'EXCELENTE'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'BOM'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.35 THEN 'REGULAR'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_exclusao_nivel,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- M\\u00c9TRICAS ADICIONAIS IMPORTANTES\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Taxa de convers\\u00e3o: das que foram para fiscaliza\\u00e7\\u00e3o, quantas viraram autua\\u00e7\\u00e3o\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_fiscalizacao_total + qtd_em_fiscalizacao, 0), 2) AS taxa_conversao_fiscalizacao_autuacao,\\r\\n    \\r\\n    -- Taxa de efetividade: resolveram + autuaram (n\\u00e3o foram exclu\\u00eddas indevidamente)\\r\\n    ROUND((qtd_resolucao_autonoma + qtd_autuacoes) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_efetividade_geral,\\r\\n    \\r\\n    -- Taxa de necessidade de fiscaliza\\u00e7\\u00e3o (complemento da autonomia)\\r\\n    ROUND((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_necessidade_fiscalizacao,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- SCORES NUM\\u00c9RICOS (0-100) CORRIGIDOS\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Score de Autonomia (0-100): quanto maior, melhor\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS score_autonomia,\\r\\n    \\r\\n    -- Score de Fiscaliza\\u00e7\\u00e3o (0-100): invertido - quanto MENOS for para fiscaliza\\u00e7\\u00e3o, melhor\\r\\n    ROUND((1 - ((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0))) * 100, 2) AS score_fiscalizacao,\\r\\n    \\r\\n    -- Score de Exclus\\u00e3o (0-100): quanto menor exclus\\u00e3o, melhor\\r\\n    ROUND((1 - (qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0))) * 100, 2) AS score_exclusao,\\r\\n    \\r\\n    -- Score de Autua\\u00e7\\u00e3o (0-100): balanceado - queremos um meio termo\\r\\n    ROUND(\\r\\n        CASE \\r\\n            -- Ideal entre 5-15%: score m\\u00e1ximo (100)\\r\\n            WHEN CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) BETWEEN 0.05 AND 0.15 THEN 100.0\\r\\n            -- Acima de 15%: penaliza progressivamente\\r\\n            WHEN CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) > 0.15 \\r\\n            THEN GREATEST(0.0, 100.0 - ((CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) - 0.15) * 250.0))\\r\\n            -- Abaixo de 5%: penaliza levemente (pode indicar exclus\\u00e3o excessiva)\\r\\n            ELSE (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) * 2000.0)\\r\\n        END\\r\\n    , 2) AS score_autuacao,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- SCORE GERAL PONDERADO CORRIGIDO (0-100)\\r\\n    -- ========================================================================\\r\\n    ROUND(\\r\\n        -- 40% Autonomia (peso maior - \\u00e9 o ideal)\\r\\n        (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n        \\r\\n        -- 30% Baixa necessidade de Fiscaliza\\u00e7\\u00e3o (invertido - quanto MENOS fiscaliza\\u00e7\\u00e3o, melhor)\\r\\n        ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                  NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n        \\r\\n        -- 20% Baixa Autua\\u00e7\\u00e3o (invertido - quanto menos autua\\u00e7\\u00e3o, melhor)\\r\\n        ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n        \\r\\n        -- 10% Baixa Exclus\\u00e3o (invertido - quanto menos exclus\\u00e3o suspeita, melhor)\\r\\n        ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n    , 2) AS score_geral_ponderado,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- CLASSIFICA\\u00c7\\u00c3O GERAL CORRIGIDA\\r\\n    -- ========================================================================\\r\\n    CASE \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 80.0 THEN 'EXCELENTE'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 65.0 THEN 'BOM'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 50.0 THEN 'REGULAR'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 35.0 THEN 'ATENCAO'\\r\\n        \\r\\n        ELSE 'CRITICO'\\r\\n    END AS classificacao_geral,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- FLAGS DE ALERTA CORRIGIDAS\\r\\n    -- ========================================================================\\r\\n    CASE WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 1 ELSE 0 END AS flag_alerta_autonomia_baixa,\\r\\n    CASE WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.40 THEN 1 ELSE 0 END AS flag_alerta_fiscalizacao_alta,\\r\\n    CASE WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.25 THEN 1 ELSE 0 END AS flag_alerta_autuacao_alta,\\r\\n    CASE WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.40 THEN 1 ELSE 0 END AS flag_alerta_exclusao_alta,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM inconsistencias_daf\\r\\nWHERE qtd_total_inconsistencias >= 100;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: AN\\u00c1LISE DE EXCLUS\\u00d5ES E LEGITIMIDADE\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.1. AN\\u00c1LISE DE EXCLUS\\u00d5ES POR AUDITOR/DAF\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_analise_exclusoes_auditores STORED AS PARQUET AS\\r\\nWITH exclusoes_por_tipo AS (\\r\\n    SELECT\\r\\n        eb.id_equipe AS id_equipe_auditor,\\r\\n        id.cd_inconsistencia,\\r\\n        id.nm_inconsistencia,\\r\\n        ben.legitimidade_exclusao AS legitimidade_tipo,\\r\\n        ben.taxa_exclusao_esperada_pct,\\r\\n        \\r\\n        COUNT(*) AS qtd_inconsistencias_tipo,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_tipo,\\r\\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes_tipo\\r\\n    FROM niat.mlh_inconsistencias_detalhadas id\\r\\n    INNER JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\\r\\n    LEFT JOIN niat.mlh_benchmark_tipo_inconsistencia ben ON id.cd_inconsistencia = ben.cd_inconsistencia\\r\\n    WHERE eb.id_equipe IS NOT NULL\\r\\n    GROUP BY eb.id_equipe, id.cd_inconsistencia, id.nm_inconsistencia, \\r\\n             ben.legitimidade_exclusao, ben.taxa_exclusao_esperada_pct\\r\\n)\\r\\nSELECT\\r\\n    id_equipe_auditor,\\r\\n    \\r\\n    -- Totais\\r\\n    SUM(qtd_inconsistencias_tipo) AS qtd_total_inconsistencias,\\r\\n    SUM(qtd_excluidas_tipo) AS qtd_total_excluidas,\\r\\n    SUM(qtd_autuacoes_tipo) AS qtd_total_autuacoes,\\r\\n    \\r\\n    -- Taxa Geral de Exclus\\u00e3o\\r\\n    ROUND(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0), 2) AS taxa_exclusao_geral_pct,\\r\\n    \\r\\n    -- Exclus\\u00f5es por Legitimidade\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_legitimas,\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_suspeitas,\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_MEDIA_ANALISAR' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_analisar,\\r\\n    \\r\\n    -- Taxas Ajustadas\\r\\n    ROUND(SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 100.0 / \\r\\n          NULLIF(SUM(qtd_excluidas_tipo), 0), 2) AS taxa_exclusao_suspeita_pct,\\r\\n    \\r\\n    -- Desvio da Taxa Esperada (m\\u00e9dia ponderada)\\r\\n    ROUND(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n          AVG(taxa_exclusao_esperada_pct), 2) AS desvio_taxa_esperada,\\r\\n    \\r\\n    -- Score de Legitimidade das Exclus\\u00f5es (0-100)\\r\\n    ROUND(\\r\\n        -- 50% baseado em baixa exclus\\u00e3o suspeita\\r\\n        ((1 - (SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n               NULLIF(SUM(qtd_excluidas_tipo), 0))) * 50) +\\r\\n        -- 30% baseado em autua\\u00e7\\u00f5es (se exclui pouco e autua muito, \\u00e9 bom)\\r\\n        (SUM(qtd_autuacoes_tipo) * 30.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0)) +\\r\\n        -- 20% baseado em estar pr\\u00f3ximo da taxa esperada\\r\\n        (CASE \\r\\n            WHEN ABS(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n                     AVG(taxa_exclusao_esperada_pct)) < 10 THEN 20\\r\\n            WHEN ABS(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n                     AVG(taxa_exclusao_esperada_pct)) < 20 THEN 10\\r\\n            ELSE 0\\r\\n         END)\\r\\n    , 2) AS score_legitimidade,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.5 \\r\\n        THEN 'ALTA_SUSPEITA'\\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.3 \\r\\n        THEN 'MEDIA_SUSPEITA'\\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.7 \\r\\n        THEN 'EXCLUSOES_LEGITIMAS'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS classificacao_exclusoes,\\r\\n    \\r\\n    -- Tipos de Inconsist\\u00eancia Distintos\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM exclusoes_por_tipo\\r\\nGROUP BY id_equipe_auditor\\r\\nHAVING SUM(qtd_inconsistencias_tipo) >= 50;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 4: AN\\u00c1LISE TEMPORAL E TEND\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.1. EVOLU\\u00c7\\u00c3O MENSAL DAS MALHAS FISCAIS\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_evolucao_mensal STORED AS PARQUET AS\\r\\nSELECT\\r\\n    nu_per_ref AS periodo,\\r\\n    \\r\\n    -- Contagens\\r\\n    COUNT(DISTINCT nu_cnpj) AS qtd_empresas_periodo,\\r\\n    COUNT(*) AS qtd_inconsistencias_identificadas,\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- Valores\\r\\n    SUM(CASE WHEN flag_tem_valor_fiscal = 1 THEN vl_inconsistencia ELSE 0 END) AS valor_total_identificado,\\r\\n    AVG(CASE WHEN flag_tem_valor_fiscal = 1 THEN vl_inconsistencia END) AS valor_medio_inconsistencia,\\r\\n    \\r\\n    -- Por Canal de Resolu\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n    COUNT(CASE WHEN flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n    COUNT(CASE WHEN flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN nu_os IS NOT NULL THEN 1 END) AS qtd_gerou_os,\\r\\n    COUNT(CASE WHEN flag_gerou_infracao = 1 THEN 1 END) AS qtd_gerou_infracao,\\r\\n    \\r\\n    -- Taxas Principais\\r\\n    ROUND(COUNT(CASE WHEN flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autonomia_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_exclusao_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autuacao_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    AVG(dias_na_malha) AS media_dias_malha,\\r\\n    AVG(CASE WHEN flag_resolucao_autonoma = 1 THEN dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Por Natureza\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'OMISSAO' THEN 1 END) AS qtd_omissao,\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'CREDITO_INDEVIDO' THEN 1 END) AS qtd_credito_indevido,\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'DIVERGENCIA_VALOR_MENOR' THEN 1 END) AS qtd_divergencia,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_inconsistencias_detalhadas\\r\\nWHERE nu_per_ref BETWEEN 202101 AND 202509\\r\\nGROUP BY nu_per_ref\\r\\nORDER BY nu_per_ref;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 5: RANKINGS E DASHBOARDS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 5.1. RANKING DE CONTADORES POR AUTONOMIA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_ranking_contadores_autonomia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY taxa_autonomia_pct DESC, qtd_clientes_total DESC) AS ranking_autonomia,\\r\\n    nu_cpf_cnpj_contador,\\r\\n    nm_contador,\\r\\n    nu_crc_contador,\\r\\n    cd_munic_contador,\\r\\n    cd_uf_contador,\\r\\n    \\r\\n    -- M\\u00e9tricas Chave\\r\\n    qtd_clientes_total,\\r\\n    qtd_empresas_com_incons,\\r\\n    qtd_total_inconsistencias,\\r\\n    valor_total_inconsistencias,\\r\\n    \\r\\n    -- Autonomia (M\\u00c9TRICA PRINCIPAL)\\r\\n    taxa_autonomia_pct,\\r\\n    qtd_resolucao_autonoma_total,\\r\\n    qtd_resolvidas_dde,\\r\\n    \\r\\n    -- Outras Taxas\\r\\n    taxa_pendencia_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    score_performance,\\r\\n    classificacao_performance,\\r\\n    \\r\\n    -- Quartil de Autonomia\\r\\n    NTILE(4) OVER (ORDER BY taxa_autonomia_pct) AS quartil_autonomia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Geral\\r\\n    CASE \\r\\n        WHEN taxa_autonomia_pct >= 70 AND taxa_autuacao_pct < 10 THEN 'TOP_PERFORMER'\\r\\n        WHEN taxa_autonomia_pct >= 50 AND taxa_autuacao_pct < 20 THEN 'BOM_PERFORMER'\\r\\n        WHEN taxa_autonomia_pct >= 30 THEN 'REGULAR'\\r\\n        WHEN taxa_autuacao_pct > 30 THEN 'CRITICO_AUTUACOES'\\r\\n        WHEN taxa_pendencia_pct > 70 THEN 'CRITICO_PENDENCIAS'\\r\\n        ELSE 'NECESSITA_ATENCAO'\\r\\n    END AS classificacao_geral,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_performance_contadores\\r\\nWHERE qtd_empresas_com_incons >= 3\\r\\nORDER BY taxa_autonomia_pct DESC;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 5.2. RANKING DE TIPOS DE INCONSIST\\u00caNCIA POR EFETIVIDADE\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_ranking_tipos_efetividade STORED AS PARQUET AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY score_efetividade_tipo DESC) AS ranking_efetividade,\\r\\n    cd_inconsistencia,\\r\\n    nm_inconsistencia,\\r\\n    natureza_inconsistencia,\\r\\n    gravidade_presumida,\\r\\n    \\r\\n    -- Volumes\\r\\n    qtd_empresas_afetadas,\\r\\n    qtd_ocorrencias_total,\\r\\n    valor_total,\\r\\n    \\r\\n    -- Resolu\\u00e7\\u00e3o\\r\\n    taxa_autonomia_esperada_pct,\\r\\n    taxa_exclusao_esperada_pct,\\r\\n    taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00f5es\\r\\n    facilidade_resolucao,\\r\\n    legitimidade_exclusao,\\r\\n    score_efetividade_tipo,\\r\\n    \\r\\n    -- Tempo\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Geral\\r\\n    CASE \\r\\n        WHEN score_efetividade_tipo >= 70 THEN 'ALTAMENTE_EFETIVO'\\r\\n        WHEN score_efetividade_tipo >= 50 THEN 'EFETIVO'\\r\\n        WHEN score_efetividade_tipo >= 30 THEN 'MODERADAMENTE_EFETIVO'\\r\\n        ELSE 'BAIXA_EFETIVIDADE'\\r\\n    END AS classificacao_efetividade,\\r\\n    \\r\\n    -- Flag de Aten\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN legitimidade_exclusao = 'EXCLUSAO_ALTA_SUSPEITA' THEN 1\\r\\n        WHEN taxa_exclusao_esperada_pct > 70 AND taxa_autuacao_esperada_pct < 5 THEN 1\\r\\n        WHEN facilidade_resolucao = 'DIFICIL_RESOLUCAO' AND taxa_autonomia_esperada_pct < 20 THEN 1\\r\\n        ELSE 0\\r\\n    END AS flag_necessita_revisao,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_benchmark_tipo_inconsistencia\\r\\nORDER BY score_efetividade_tipo DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: TABELA 5.3 - RANKING DE DAFs (CORRIGIDA)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_ranking_dafs;\\r\\n\\r\\nCREATE TABLE niat.mlh_ranking_dafs STORED AS PARQUET AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY score_geral_ponderado DESC) AS ranking_geral,\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    qtd_total_inconsistencias,\\r\\n    ROUND(valor_total_inconsistencias / 1000000, 2) AS valor_incons_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_exclusao_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    taxa_ativas_pct,\\r\\n    taxa_necessidade_fiscalizacao,\\r\\n    \\r\\n    -- Performance\\r\\n    score_geral_ponderado,\\r\\n    classificacao_geral,  -- V\\u00cdRGULA CORRIGIDA!\\r\\n    \\r\\n    -- Quartil\\r\\n    NTILE(4) OVER (ORDER BY score_geral_ponderado) AS quartil_performance,\\r\\n    \\r\\n    -- Tempo\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_performance_dafs\\r\\nORDER BY score_geral_ponderado DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 6: VIEWS PARA DASHBOARDS E AN\\u00c1LISES\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.1. DASHBOARD EXECUTIVO V2.0\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_dashboard_executivo_v2 AS\\r\\nSELECT\\r\\n    -- Resumo Geral\\r\\n    (SELECT COUNT(DISTINCT nu_cnpj) FROM niat.mlh_empresas_base \\r\\n     WHERE flag_atualmente_em_malha = 1) AS empresas_em_malha_ativa,\\r\\n    \\r\\n    (SELECT COUNT(*) FROM niat.mlh_inconsistencias_detalhadas \\r\\n     WHERE canal_resolucao = 'ATIVA') AS inconsistencias_ativas,\\r\\n    \\r\\n    (SELECT SUM(CASE WHEN flag_tem_valor_fiscal = 1 THEN vl_inconsistencia ELSE 0 END) \\r\\n     FROM niat.mlh_inconsistencias_detalhadas \\r\\n     WHERE canal_resolucao = 'ATIVA') AS valor_ativo_malhas,\\r\\n    \\r\\n    -- Taxas de Autonomia (M\\u00c9TRICA CHAVE)\\r\\n    (SELECT ROUND(AVG(taxa_autonomia_pct), 2) \\r\\n     FROM niat.mlh_evolucao_mensal \\r\\n     WHERE periodo >= 202401) AS taxa_autonomia_media_2024,\\r\\n    \\r\\n    (SELECT ROUND(AVG(taxa_exclusao_pct), 2) \\r\\n     FROM niat.mlh_evolucao_mensal \\r\\n     WHERE periodo >= 202401) AS taxa_exclusao_media_2024,\\r\\n    \\r\\n    (SELECT ROUND(AVG(taxa_autuacao_pct), 2) \\r\\n     FROM niat.mlh_evolucao_mensal \\r\\n     WHERE periodo >= 202401) AS taxa_autuacao_media_2024,\\r\\n    \\r\\n    -- Performance de Contadores\\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_contadores_autonomia \\r\\n     WHERE classificacao_geral = 'TOP_PERFORMER') AS contadores_top_performer,\\r\\n    \\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_contadores_autonomia \\r\\n     WHERE classificacao_geral IN ('CRITICO_AUTUACOES', 'CRITICO_PENDENCIAS')) AS contadores_criticos,\\r\\n    \\r\\n    -- Efetividade de Tipos\\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_tipos_efetividade \\r\\n     WHERE flag_necessita_revisao = 1) AS tipos_necessitam_revisao,\\r\\n    \\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_tipos_efetividade \\r\\n     WHERE classificacao_efetividade = 'ALTAMENTE_EFETIVO') AS tipos_altamente_efetivos,\\r\\n    \\r\\n    -- Exclus\\u00f5es\\r\\n    (SELECT COUNT(*) FROM niat.mlh_analise_exclusoes_auditores \\r\\n     WHERE classificacao_exclusoes IN ('ALTA_SUSPEITA', 'MEDIA_SUSPEITA')) AS equipes_exclusoes_suspeitas,\\r\\n    \\r\\n    -- DAFs\\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_dafs \\r\\n     WHERE classificacao_geral = 'EXCELENTE') AS dafs_excelentes,\\r\\n    \\r\\n    -- Timestamp\\r\\n    CURRENT_TIMESTAMP() AS dt_atualizacao;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.2. VIEW DE CONTADORES - FOCO EM AUTONOMIA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_contadores_autonomia AS\\r\\nSELECT\\r\\n    rc.ranking_autonomia,\\r\\n    rc.nu_cpf_cnpj_contador,\\r\\n    rc.nm_contador,\\r\\n    rc.nu_crc_contador,\\r\\n    rc.cd_munic_contador,\\r\\n    rc.cd_uf_contador,\\r\\n    rc.qtd_clientes_total,\\r\\n    rc.qtd_empresas_com_incons,\\r\\n    ROUND(rc.valor_total_inconsistencias / 1000000, 2) AS valor_incons_milhoes,\\r\\n    \\r\\n    -- M\\u00e9tricas de Autonomia\\r\\n    rc.taxa_autonomia_pct,\\r\\n    rc.qtd_resolucao_autonoma_total,\\r\\n    rc.qtd_resolvidas_dde,\\r\\n    pc.qtd_resolvidas_malha_auto,\\r\\n    \\r\\n    -- Outras M\\u00e9tricas\\r\\n    rc.taxa_pendencia_pct,\\r\\n    rc.taxa_autuacao_pct,\\r\\n    rc.taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    rc.score_performance,\\r\\n    rc.classificacao_performance,\\r\\n    rc.classificacao_geral,\\r\\n    rc.quartil_autonomia,\\r\\n    \\r\\n    -- Detalhes\\r\\n    pc.media_dias_resolucao_autonoma,\\r\\n    pc.qtd_tipos_inconsistencia,\\r\\n    pc.qtd_omissao,\\r\\n    pc.qtd_credito_indevido\\r\\n\\r\\nFROM niat.mlh_ranking_contadores_autonomia rc\\r\\nINNER JOIN niat.mlh_performance_contadores pc \\r\\n    ON rc.nu_cpf_cnpj_contador = pc.nu_cpf_cnpj_contador;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.3. VIEW DE TIPOS DE INCONSIST\\u00caNCIA - BENCHMARK\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_tipos_benchmark AS\\r\\nSELECT\\r\\n    rt.ranking_efetividade,\\r\\n    rt.cd_inconsistencia,\\r\\n    rt.nm_inconsistencia,\\r\\n    rt.natureza_inconsistencia,\\r\\n    rt.gravidade_presumida,\\r\\n    rt.qtd_empresas_afetadas,\\r\\n    rt.qtd_ocorrencias_total,\\r\\n    ROUND(rt.valor_total / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- Taxas Benchmark\\r\\n    rt.taxa_autonomia_esperada_pct,\\r\\n    rt.taxa_exclusao_esperada_pct,\\r\\n    rt.taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00f5es\\r\\n    rt.facilidade_resolucao,\\r\\n    rt.legitimidade_exclusao,\\r\\n    rt.classificacao_efetividade,\\r\\n    rt.score_efetividade_tipo,\\r\\n    rt.flag_necessita_revisao,\\r\\n    \\r\\n    -- Tempo\\r\\n    rt.media_dias_malha,\\r\\n    rt.media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Cat\\u00e1logo\\r\\n    cat.flag_tem_valor_fiscal\\r\\n\\r\\nFROM niat.mlh_ranking_tipos_efetividade rt\\r\\nINNER JOIN niat.mlh_catalogo_tipos_inconsistencia cat \\r\\n    ON rt.cd_inconsistencia = cat.cd_inconsistencia;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: VIEW 6.4 - DAFs PERFORMANCE (CORRIGIDA)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_dafs_performance;\\r\\n\\r\\nCREATE VIEW niat.vw_mlh_dafs_performance AS\\r\\nSELECT\\r\\n    rd.ranking_geral,\\r\\n    rd.id_equipe,\\r\\n    rd.qtd_empresas_acompanhadas,\\r\\n    rd.qtd_contadores_acompanhados,\\r\\n    rd.qtd_total_inconsistencias,\\r\\n    rd.valor_incons_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    rd.taxa_autonomia_pct,\\r\\n    rd.taxa_exclusao_pct,\\r\\n    rd.taxa_autuacao_pct,\\r\\n    rd.taxa_ativas_pct,\\r\\n    rd.taxa_necessidade_fiscalizacao,\\r\\n    \\r\\n    -- Performance\\r\\n    rd.score_geral_ponderado,\\r\\n    rd.classificacao_geral,\\r\\n    rd.quartil_performance,\\r\\n    \\r\\n    -- Exclus\\u00f5es\\r\\n    COALESCE(ae.classificacao_exclusoes, 'SEM_ANALISE') AS classificacao_exclusoes,\\r\\n    COALESCE(ae.score_legitimidade, 0) AS score_legitimidade_exclusoes,\\r\\n    COALESCE(ae.qtd_exclusoes_suspeitas, 0) AS qtd_exclusoes_suspeitas,\\r\\n    \\r\\n    -- Tempo\\r\\n    rd.media_dias_malha,\\r\\n    rd.media_dias_resolucao_autonoma\\r\\n\\r\\nFROM niat.mlh_ranking_dafs rd\\r\\nLEFT JOIN niat.mlh_analise_exclusoes_auditores ae \\r\\n    ON rd.id_equipe = ae.id_equipe_auditor;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.5. VIEW DE S\\u00c9RIE TEMPORAL - EVOLU\\u00c7\\u00c3O\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_serie_temporal AS\\r\\nSELECT\\r\\n    periodo,\\r\\n    qtd_empresas_periodo,\\r\\n    qtd_inconsistencias_identificadas,\\r\\n    ROUND(valor_total_identificado / 1000000, 2) AS valor_identificado_milhoes,\\r\\n    \\r\\n    -- Por Canal\\r\\n    qtd_resolvidas_dde,\\r\\n    qtd_resolvidas_malha_auto,\\r\\n    qtd_resolucao_autonoma,\\r\\n    qtd_resolvidas_fiscalizacao,\\r\\n    qtd_excluidas_auditor,\\r\\n    qtd_ativas,\\r\\n    qtd_gerou_infracao,\\r\\n    \\r\\n    -- Taxas\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_exclusao_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Por Natureza\\r\\n    qtd_omissao,\\r\\n    qtd_credito_indevido,\\r\\n    qtd_divergencia\\r\\n\\r\\nFROM niat.mlh_evolucao_mensal\\r\\nORDER BY periodo;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.6. VIEW DE TIPOS DE INCONSIST\\u00caNCIA - AN\\u00c1LISE DETALHADA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_tipos_detalhado AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY ben.score_efetividade_tipo DESC) AS ranking_tipo,\\r\\n    ben.cd_inconsistencia,\\r\\n    ben.nm_inconsistencia,\\r\\n    ben.natureza_inconsistencia,\\r\\n    ben.gravidade_presumida,\\r\\n    ben.qtd_empresas_afetadas,\\r\\n    ben.qtd_ocorrencias_total,\\r\\n    ROUND(ben.valor_total / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    ben.taxa_autonomia_esperada_pct,\\r\\n    ben.taxa_exclusao_esperada_pct,\\r\\n    ben.taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    ben.score_efetividade_tipo,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN ben.score_efetividade_tipo >= 70 THEN 'ALTAMENTE_EFETIVO'\\r\\n        WHEN ben.score_efetividade_tipo >= 50 THEN 'EFETIVO'\\r\\n        WHEN ben.score_efetividade_tipo >= 30 THEN 'MODERADAMENTE_EFETIVO'\\r\\n        ELSE 'BAIXA_EFETIVIDADE'\\r\\n    END AS classificacao_efetividade,\\r\\n    \\r\\n    -- Tempo\\r\\n    ben.media_dias_malha,\\r\\n    ben.media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Status\\r\\n    CASE \\r\\n        WHEN DATEDIFF(CURRENT_DATE(), FROM_UNIXTIME(UNIX_TIMESTAMP(CONCAT(CAST(ben.periodo_ultima_geracao AS STRING), '01'), 'yyyyMMdd'), 'yyyy-MM-dd')) > 90 THEN 'INATIVO'\\r\\n        WHEN DATEDIFF(CURRENT_DATE(), FROM_UNIXTIME(UNIX_TIMESTAMP(CONCAT(CAST(ben.periodo_ultima_geracao AS STRING), '01'), 'yyyyMMdd'), 'yyyy-MM-dd')) > 30 THEN 'POUCO_ATIVO'\\r\\n        ELSE 'ATIVO'\\r\\n    END AS status_atividade\\r\\n\\r\\nFROM niat.mlh_benchmark_tipo_inconsistencia ben;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 7: AN\\u00c1LISES ESPEC\\u00cdFICAS PARA PYTHON/ML\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 7.1. DATASET PARA AN\\u00c1LISE DE PADR\\u00d5ES DE EXCLUS\\u00c3O\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_dataset_exclusoes_ml STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identificadores\\r\\n    id.nu_cnpj,\\r\\n    id.cd_inconsistencia,\\r\\n    id.nu_per_ref,\\r\\n    \\r\\n    -- Features do Tipo de Inconsist\\u00eancia\\r\\n    ben.taxa_exclusao_esperada_pct,\\r\\n    ben.taxa_autuacao_esperada_pct,\\r\\n    ben.taxa_autonomia_esperada_pct,\\r\\n    ben.facilidade_resolucao,\\r\\n    ben.legitimidade_exclusao,\\r\\n    ben.score_efetividade_tipo,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    \\r\\n    -- Features da Empresa\\r\\n    eb.cnae_divisao,\\r\\n    eb.secao_cnae,\\r\\n    eb.cd_reg_apuracao,\\r\\n    eb.cd_enq_empresa,\\r\\n    eb.sn_simples_nacional_rfb,\\r\\n    eb.qtd_tipos_inconsistencia_historico,\\r\\n    \\r\\n    -- Features do Contador\\r\\n    pc.taxa_autonomia_pct AS taxa_autonomia_contador,\\r\\n    pc.taxa_autuacao_pct AS taxa_autuacao_contador,\\r\\n    pc.score_performance AS score_contador,\\r\\n    pc.classificacao_performance AS classificacao_contador,\\r\\n    \\r\\n    -- Features da Inconsist\\u00eancia Espec\\u00edfica\\r\\n    id.vl_inconsistencia,\\r\\n    id.dias_na_malha,\\r\\n    id.dias_ate_resolucao,\\r\\n    \\r\\n    -- Target (o que queremos prever)\\r\\n    id.flag_exclusao_auditor AS target_exclusao,\\r\\n    id.flag_resolucao_autonoma AS target_autonomia,\\r\\n    id.flag_gerou_infracao AS target_infracao,\\r\\n    id.canal_resolucao AS target_canal_resolucao,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_inconsistencias_detalhadas id\\r\\nLEFT JOIN niat.mlh_benchmark_tipo_inconsistencia ben \\r\\n    ON id.cd_inconsistencia = ben.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_catalogo_tipos_inconsistencia cat \\r\\n    ON id.cd_inconsistencia = cat.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_empresas_base eb \\r\\n    ON id.nu_cnpj = eb.nu_cnpj\\r\\nLEFT JOIN niat.mlh_performance_contadores pc \\r\\n    ON eb.nu_cpf_cnpj_contador = pc.nu_cpf_cnpj_contador\\r\\nWHERE id.dt_entrou_malha >= '2023-01-01';\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 7.2. AGREGA\\u00c7\\u00c3O PARA AN\\u00c1LISE DE CLUSTER DE CONTADORES\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_dataset_clusters_contadores STORED AS PARQUET AS\\r\\nSELECT\\r\\n    pc.nu_cpf_cnpj_contador,\\r\\n    pc.nm_contador,\\r\\n    \\r\\n    -- Features de Volume\\r\\n    pc.qtd_clientes_total,\\r\\n    pc.qtd_empresas_com_incons,\\r\\n    pc.qtd_total_inconsistencias,\\r\\n    LN(CAST(pc.valor_total_inconsistencias AS DOUBLE) + 1.0) AS log_valor_total,\\r\\n    \\r\\n    -- Features de Autonomia\\r\\n    pc.taxa_autonomia_pct,\\r\\n    pc.taxa_resolucao_dde_pct,\\r\\n    pc.taxa_pendencia_pct,\\r\\n    pc.taxa_autuacao_pct,\\r\\n    pc.taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Features de Diversidade\\r\\n    pc.qtd_tipos_inconsistencia,\\r\\n    pc.qtd_omissao,\\r\\n    pc.qtd_credito_indevido,\\r\\n    pc.qtd_divergencia,\\r\\n    \\r\\n    -- Features de Tempo\\r\\n    pc.media_dias_malha,\\r\\n    pc.media_dias_resolucao_autonoma,\\r\\n    pc.media_dias_resolucao_fiscal,\\r\\n    \\r\\n    -- Features de Performance\\r\\n    pc.score_performance,\\r\\n    \\r\\n    -- Features Geogr\\u00e1ficas\\r\\n    pc.cd_munic_contador,\\r\\n    pc.cd_uf_contador,\\r\\n    \\r\\n    -- Features de Risco\\r\\n    CASE \\r\\n        WHEN pc.taxa_autuacao_pct > 30 THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS flag_alto_risco_autuacao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN pc.taxa_pendencia_pct > 70 THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS flag_alta_pendencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    pc.classificacao_performance,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_performance_contadores pc\\r\\nWHERE pc.qtd_total_inconsistencias >= 10;\\r\\n\\r\\n-- ============================================================================\\r\\n-- CRIAR TABELA PR\\u00c9-PROCESSADA PARA ML - VERS\\u00c3O FINAL\\r\\n-- ============================================================================\\r\\n\\r\\nCREATE TABLE niat.mlh_dataset_ml_exclusoes STORED AS PARQUET AS\\r\\nSELECT \\r\\n    -- Features do Tipo\\r\\n    COALESCE(ben.taxa_exclusao_esperada_pct, 0) AS taxa_exclusao_esperada_pct,\\r\\n    COALESCE(ben.taxa_autuacao_esperada_pct, 0) AS taxa_autuacao_esperada_pct,\\r\\n    COALESCE(ben.taxa_autonomia_esperada_pct, 0) AS taxa_autonomia_esperada_pct,\\r\\n    COALESCE(ben.score_efetividade_tipo, 50) AS score_efetividade_tipo,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ben.facilidade_resolucao = 'FACIL_RESOLUCAO' THEN 1\\r\\n        WHEN ben.facilidade_resolucao = 'MEDIA_RESOLUCAO' THEN 2\\r\\n        ELSE 3 \\r\\n    END AS facilidade_num,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ben.legitimidade_exclusao = 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA' THEN 0\\r\\n        WHEN ben.legitimidade_exclusao = 'NORMAL' THEN 1\\r\\n        WHEN ben.legitimidade_exclusao = 'EXCLUSAO_MEDIA_ANALISAR' THEN 2\\r\\n        ELSE 3 \\r\\n    END AS legitimidade_num,\\r\\n    \\r\\n    CASE \\r\\n        WHEN cat.natureza_inconsistencia = 'OMISSAO' THEN 1\\r\\n        WHEN cat.natureza_inconsistencia = 'CREDITO_INDEVIDO' THEN 2\\r\\n        WHEN cat.natureza_inconsistencia = 'DIVERGENCIA_VALOR_MENOR' THEN 3\\r\\n        ELSE 0 \\r\\n    END AS natureza_num,\\r\\n    \\r\\n    -- Features da Empresa (CORRIGIDO COM C\\u00d3DIGOS NUM\\u00c9RICOS)\\r\\n    CASE WHEN eb.cd_reg_apuracao = 2 THEN 1 ELSE 0 END AS regime_normal,\\r\\n    CASE WHEN eb.cd_reg_apuracao IN (8, 9) THEN 1 ELSE 0 END AS simples_nacional,\\r\\n    COALESCE(eb.qtd_tipos_inconsistencia_historico, 0) AS qtd_tipos_inconsistencia_historico,\\r\\n    \\r\\n    -- C\\u00f3digo do regime (pode ser \\u00fatil no modelo)\\r\\n    eb.cd_reg_apuracao AS cod_regime_apuracao,\\r\\n    \\r\\n    -- Features do Contador\\r\\n    COALESCE(pc.taxa_autonomia_pct, 50) AS contador_taxa_autonomia,\\r\\n    COALESCE(pc.taxa_autuacao_pct, 10) AS contador_taxa_autuacao,\\r\\n    COALESCE(pc.score_performance, 50) AS contador_score,\\r\\n    \\r\\n    -- Features da Inconsist\\u00eancia\\r\\n    LN(COALESCE(id.vl_inconsistencia, 1) + 1) AS log_valor,\\r\\n    COALESCE(id.dias_na_malha, 0) AS dias_malha,\\r\\n    \\r\\n    -- Target\\r\\n    COALESCE(id.flag_exclusao_auditor, 0) AS target_exclusao,\\r\\n    COALESCE(id.flag_gerou_infracao, 0) AS target_infracao\\r\\n    \\r\\nFROM niat.mlh_inconsistencias_detalhadas id\\r\\nLEFT JOIN niat.mlh_benchmark_tipo_inconsistencia ben \\r\\n    ON id.cd_inconsistencia = ben.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_catalogo_tipos_inconsistencia cat \\r\\n    ON id.cd_inconsistencia = cat.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_empresas_base eb \\r\\n    ON id.nu_cnpj = eb.nu_cnpj\\r\\nLEFT JOIN niat.mlh_performance_contadores pc \\r\\n    ON eb.nu_cpf_cnpj_contador = pc.nu_cpf_cnpj_contador\\r\\nWHERE id.dt_entrou_malha >= '2024-01-01'\\r\\n  AND id.dt_saiu_malha IS NOT NULL;\\r\\n\\r\\n-- ============================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES E ESTAT\\u00cdSTICAS FINAIS\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'SISTEMA DE MALHAS FISCAIS V2.0 - RESUMO EXECUTIVO' AS titulo;\\r\\n\\r\\n-- Contagem de Registros nas Tabelas Principais\\r\\nSELECT 'CONTAGEM DE REGISTROS' AS secao;\\r\\nSELECT \\r\\n    'mlh_empresas_base' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_unicas,\\r\\n    SUM(flag_atualmente_em_malha) AS empresas_em_malha_ativa\\r\\nFROM niat.mlh_empresas_base\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_inconsistencias_detalhadas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_unicas,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'ATIVA' THEN 1 END) AS inconsistencias_ativas\\r\\nFROM niat.mlh_inconsistencias_detalhadas\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_catalogo_tipos_inconsistencia' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS tipos_unicos,\\r\\n    SUM(CASE WHEN flag_tipo_ativo = '1' THEN 1 ELSE 0 END) AS tipos_ativos\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_performance_contadores' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cpf_cnpj_contador) AS contadores_unicos,\\r\\n    NULL AS terceira_metrica\\r\\nFROM niat.mlh_performance_contadores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_performance_dafs' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT id_equipe) AS equipes_unicas,\\r\\n    NULL AS terceira_metrica\\r\\nFROM niat.mlh_performance_dafs\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_benchmark_tipo_inconsistencia' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS tipos_unicos,\\r\\n    NULL AS terceira_metrica\\r\\nFROM niat.mlh_benchmark_tipo_inconsistencia;\\r\\n\\r\\n-- Top 10 Contadores por Autonomia\\r\\nSELECT 'TOP 10 CONTADORES POR TAXA DE AUTONOMIA' AS analise;\\r\\nSELECT \\r\\n    ranking_autonomia,\\r\\n    nm_contador,\\r\\n    nu_crc_contador,\\r\\n    qtd_empresas_com_incons,\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    classificacao_geral\\r\\nFROM niat.mlh_ranking_contadores_autonomia\\r\\nWHERE ranking_autonomia <= 10\\r\\nORDER BY ranking_autonomia;\\r\\n\\r\\n-- Top 10 Tipos de Inconsist\\u00eancia por Efetividade\\r\\nSELECT 'TOP 10 TIPOS DE INCONSIST\\u00caNCIA POR EFETIVIDADE' AS analise;\\r\\nSELECT \\r\\n    ranking_efetividade,\\r\\n    cd_inconsistencia,\\r\\n    nm_inconsistencia,\\r\\n    qtd_ocorrencias_total,\\r\\n    taxa_autonomia_esperada_pct,\\r\\n    taxa_autuacao_esperada_pct,\\r\\n    score_efetividade_tipo,\\r\\n    classificacao_efetividade\\r\\nFROM niat.mlh_ranking_tipos_efetividade\\r\\nWHERE ranking_efetividade <= 10\\r\\nORDER BY ranking_efetividade;\\r\\n\\r\\n-- Performance das DAFs\\r\\nSELECT 'TOP 10 DAFs POR PERFORMANCE' AS analise;\\r\\nSELECT \\r\\n    ranking_geral,\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    score_performance_daf,\\r\\n    classificacao_performance\\r\\nFROM niat.mlh_ranking_dafs\\r\\nWHERE ranking_geral <= 10\\r\\nORDER BY ranking_geral;\\r\\n\\r\\n-- Tipos que Necessitam Revis\\u00e3o\\r\\nSELECT 'TIPOS DE INCONSIST\\u00caNCIA QUE NECESSITAM REVIS\\u00c3O' AS analise;\\r\\nSELECT \\r\\n    cd_inconsistencia,\\r\\n    nm_inconsistencia,\\r\\n    natureza_inconsistencia,\\r\\n    qtd_ocorrencias_total,\\r\\n    taxa_exclusao_esperada_pct,\\r\\n    taxa_autuacao_esperada_pct,\\r\\n    legitimidade_exclusao,\\r\\n    classificacao_efetividade\\r\\nFROM niat.mlh_ranking_tipos_efetividade\\r\\nWHERE flag_necessita_revisao = 1\\r\\nORDER BY qtd_ocorrencias_total DESC;\\r\\n\\r\\n-- Equipes com Exclus\\u00f5es Suspeitas\\r\\nSELECT 'EQUIPES COM PADR\\u00c3O SUSPEITO DE EXCLUS\\u00c3O' AS analise;\\r\\nSELECT \\r\\n    id_equipe_auditor,\\r\\n    qtd_total_inconsistencias,\\r\\n    qtd_total_excluidas,\\r\\n    taxa_exclusao_geral_pct,\\r\\n    qtd_exclusoes_suspeitas,\\r\\n    taxa_exclusao_suspeita_pct,\\r\\n    score_legitimidade,\\r\\n    classificacao_exclusoes\\r\\nFROM niat.mlh_analise_exclusoes_auditores\\r\\nWHERE classificacao_exclusoes IN ('ALTA_SUSPEITA', 'MEDIA_SUSPEITA')\\r\\nORDER BY taxa_exclusao_suspeita_pct DESC;\\r\\n\\r\\n-- Evolu\\u00e7\\u00e3o nos \\u00daltimos 12 Meses\\r\\nSELECT 'EVOLU\\u00c7\\u00c3O \\u00daLTIMOS 12 MESES' AS analise;\\r\\nSELECT \\r\\n    periodo,\\r\\n    qtd_empresas_periodo,\\r\\n    qtd_inconsistencias_identificadas,\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_exclusao_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    media_dias_malha\\r\\nFROM niat.mlh_evolucao_mensal\\r\\nWHERE periodo >= 202401\\r\\nORDER BY periodo;\", \"result\": {\"id\": \"6ff993b3-5f72-5a4d-7e3b-29e52a5521f4\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"OxZt21IOTgqNCNukBU5w+Q==\", \"guid\": \"tDQjU/fgRUgAAAAAWh0bUg==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"6a4e9ebe0f661059:44afe217f2c592ad\", \"session_id\": 22136, \"session_type\": \"impala\", \"statement_id\": 24, \"has_more_statements\": true, \"statements_count\": 39, \"previous_statement_hash\": \"b808b10be221098170c097a41e0210dd6c7000cdea2e9406a3e35a6f\", \"start\": {\"row\": 1535, \"column\": 0}, \"end\": {\"row\": 1539, \"column\": 69}, \"statement\": \"-- ============================================================================\\n-- VALIDA\\u00c7\\u00d5ES E ESTAT\\u00cdSTICAS FINAIS\\n-- ============================================================================\\n\\nSELECT 'SISTEMA DE MALHAS FISCAIS V2.0 - RESUMO EXECUTIVO' AS titulo\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 24, \"statement_range\": {\"start\": {\"row\": 1535, \"column\": 0}, \"end\": {\"row\": 1539, \"column\": 69}}, \"statements_count\": 39, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"titulo\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-10-28T21:17:42.569Z\", \"endTime\": \"2025-10-28T21:17:42.796Z\", \"executionTime\": 227, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 3, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 22270, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"titulo\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": 22367, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1761686262264, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- ============================================================================\\r\\n-- SISTEMA DE MONITORAMENTO E GEST\\u00c3O DE MALHAS FISCAIS - DAFs V2.0\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: TABELAS FUNDAMENTAIS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.1. CAT\\u00c1LOGO DE TIPOS DE INCONSIST\\u00caNCIAS\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_catalogo_tipos_inconsistencia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    t.cd_inconsistencia,\\r\\n    t.nm_inconsistencia,\\r\\n    t.cd_tipo_infracao,\\r\\n    \\r\\n    -- Status e Visibilidade\\r\\n    CAST(t.sn_ativa AS STRING) AS flag_tipo_ativo,\\r\\n    t.cd_visibilidade,\\r\\n    t.cd_forma_regularizacao,\\r\\n    \\r\\n    -- Valores de Corte\\r\\n    t.vl_individual_min AS valor_minimo_malha,\\r\\n    t.vl_mensal_min AS valor_mensal_minimo,\\r\\n    t.nu_per_ini AS periodo_inicio_vigencia,\\r\\n    \\r\\n    -- Impactos\\r\\n    t.sn_regularidade_ttd AS flag_impacta_regularidade,\\r\\n    t.sn_dashboard AS flag_aparece_dashboard,\\r\\n    CAST(t.sn_bloqueada AS STRING) AS flag_tipo_bloqueado,\\r\\n    t.de_bloqueada AS motivo_bloqueio,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o por Natureza da Inconsist\\u00eancia\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o%' OR t.nm_inconsistencia LIKE '%n\\u00e3o escriturada%' \\r\\n        THEN 'OMISSAO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Cr\\u00e9dito indevido%' OR t.nm_inconsistencia LIKE '%Cr\\u00e9dito Indevido%'\\r\\n        THEN 'CREDITO_INDEVIDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%menor que%' OR t.nm_inconsistencia LIKE '%D\\u00e9bito de ICMS declarado na EFD menor%'\\r\\n        THEN 'DIVERGENCIA_VALOR_MENOR'\\r\\n        WHEN t.nm_inconsistencia LIKE '%maior que%'\\r\\n        THEN 'DIVERGENCIA_VALOR_MAIOR'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Saldo%'\\r\\n        THEN 'DIVERGENCIA_SALDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%cancelad%' OR t.nm_inconsistencia LIKE '%inexistente%'\\r\\n        THEN 'DOCUMENTO_INVALIDO'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Estorno%'\\r\\n        THEN 'ESTORNO_IRREGULAR'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS natureza_inconsistencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o por Gravidade Presumida\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%Cr\\u00e9dito indevido%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%n\\u00e3o escriturada%' THEN 'ALTA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%cancelad%' THEN 'MEDIA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%menor que%' THEN 'MEDIA'\\r\\n        WHEN t.nm_inconsistencia LIKE '%maior que%' THEN 'BAIXA'\\r\\n        ELSE 'MEDIA'\\r\\n    END AS gravidade_presumida,\\r\\n    \\r\\n    -- Flag se tem valor monet\\u00e1rio associado\\r\\n    CASE \\r\\n        WHEN t.nm_inconsistencia LIKE '%Omiss\\u00e3o de entrega%' THEN 0\\r\\n        ELSE 1\\r\\n    END AS flag_tem_valor_fiscal,\\r\\n    \\r\\n    -- Metadados\\r\\n    t.dt_publicacao,\\r\\n    t.dt_inclusao,\\r\\n    t.dt_alteracao,\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha_trans.mlh_incons_tipo t;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.2. EMPRESAS NA MALHA FISCAL - BASE CONSOLIDADA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_empresas_base STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    ei.nu_cnpj,\\r\\n    ei.nu_cnpj_grupo,\\r\\n    ei.nu_cpf,\\r\\n    ei.nu_ie,\\r\\n    ei.id_equipe,\\r\\n    \\r\\n    -- Informa\\u00e7\\u00f5es Cadastrais\\r\\n    c.nm_razao_social,\\r\\n    c.nm_fantasia,\\r\\n    c.cd_sit_cadastral,\\r\\n    c.nm_sit_cadastral,\\r\\n    c.cd_reg_apuracao,\\r\\n    c.nm_reg_apuracao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Econ\\u00f4mica\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5) AS cnae_classe,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2) AS cnae_divisao,\\r\\n    c.de_classe AS desc_cnae,\\r\\n    c.cd_secao AS secao_cnae,\\r\\n    c.de_secao AS desc_secao,\\r\\n    \\r\\n    -- Localiza\\u00e7\\u00e3o\\r\\n    c.cd_gerfe,\\r\\n    c.nm_gerfe,\\r\\n    c.cd_ges,\\r\\n    c.nm_ges,\\r\\n    c.cd_munic,\\r\\n    c.nm_munic,\\r\\n    c.cd_uf,\\r\\n    \\r\\n    -- Contador Respons\\u00e1vel\\r\\n    c.nu_cpf_cnpj_contador,\\r\\n    c.nm_contador,\\r\\n    c.nu_crc_contador,\\r\\n    c.dt_ini_relac_contador,\\r\\n    c.cd_munic_contador,\\r\\n    c.cd_uf_contador,\\r\\n    \\r\\n    -- Caracter\\u00edsticas da Empresa\\r\\n    c.cd_tipo_contribuinte,\\r\\n    c.nm_tipo_contribuinte,\\r\\n    c.cd_enq_empresa,\\r\\n    c.nm_enq_empresa,\\r\\n    c.cd_natureza_juridica,\\r\\n    c.nm_natureza_juridica,\\r\\n    c.sn_simples_nacional_rfb,\\r\\n    c.sn_dtec,\\r\\n    c.dt_credenciamento_dtec,\\r\\n    c.sn_suspensao_dfe,\\r\\n    c.dt_suspensao_dfe,\\r\\n    c.sn_matriz,\\r\\n    c.sn_apur_consolidada,\\r\\n    c.sn_estab_consolidado,\\r\\n    c.sn_estab_consolidador,\\r\\n    \\r\\n    -- V\\u00ednculos\\r\\n    c.qt_vinculos,\\r\\n    c.qt_vinculos_ativos,\\r\\n    c.qt_socios,\\r\\n    c.qt_socios_ativos,\\r\\n    \\r\\n    -- Agregados de Inconsist\\u00eancias\\r\\n    COUNT(DISTINCT ei.cd_inconsistencia) AS qtd_tipos_inconsistencia_historico,\\r\\n    SUM(ei.qt_incons_existentes) AS qtd_total_inconsistencias_historico,\\r\\n    SUM(ei.vl_incons_existentes) AS valor_total_inconsistencias_historico,\\r\\n    \\r\\n    -- Status Atual na Malha\\r\\n    MAX(CASE WHEN ei.dt_saiu_malha IS NULL THEN 1 ELSE 0 END) AS flag_atualmente_em_malha,\\r\\n    SUM(CASE WHEN ei.dt_saiu_malha IS NULL THEN ei.qt_incons_existentes ELSE 0 END) AS qtd_inconsistencias_ativas,\\r\\n    SUM(CASE WHEN ei.dt_saiu_malha IS NULL THEN ei.vl_incons_existentes ELSE 0 END) AS valor_inconsistencias_ativas,\\r\\n    \\r\\n    -- Datas\\r\\n    MIN(ei.dt_entrou_malha) AS dt_primeira_entrada_malha,\\r\\n    MAX(ei.dt_entrou_malha) AS dt_ultima_entrada_malha,\\r\\n    MAX(ei.dt_saiu_malha) AS dt_ultima_saida_malha,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha.mlh_empresa_incons ei\\r\\nINNER JOIN usr_sat_ods.vw_ods_contrib c ON ei.nu_cnpj = c.nu_cnpj\\r\\nGROUP BY \\r\\n    ei.nu_cnpj, ei.nu_cnpj_grupo, ei.nu_cpf, ei.nu_ie, ei.id_equipe,\\r\\n    c.nm_razao_social, c.nm_fantasia, c.cd_sit_cadastral, c.nm_sit_cadastral,\\r\\n    c.cd_reg_apuracao, c.nm_reg_apuracao,\\r\\n    SUBSTR(CAST(c.cd_cnae AS STRING), 1, 5), SUBSTR(CAST(c.cd_cnae AS STRING), 1, 2),\\r\\n    c.de_classe, c.cd_secao, c.de_secao,\\r\\n    c.cd_gerfe, c.nm_gerfe, c.cd_ges, c.nm_ges, c.cd_munic, c.nm_munic, c.cd_uf,\\r\\n    c.nu_cpf_cnpj_contador, c.nm_contador, c.nu_crc_contador, c.dt_ini_relac_contador,\\r\\n    c.cd_munic_contador, c.cd_uf_contador,\\r\\n    c.cd_tipo_contribuinte, c.nm_tipo_contribuinte, c.cd_enq_empresa, c.nm_enq_empresa,\\r\\n    c.cd_natureza_juridica, c.nm_natureza_juridica, c.sn_simples_nacional_rfb,\\r\\n    c.sn_dtec, c.dt_credenciamento_dtec, c.sn_suspensao_dfe, c.dt_suspensao_dfe,\\r\\n    c.sn_matriz, c.sn_apur_consolidada, c.sn_estab_consolidado, c.sn_estab_consolidador,\\r\\n    c.qt_vinculos, c.qt_vinculos_ativos, c.qt_socios, c.qt_socios_ativos;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.3. INCONSIST\\u00caNCIAS DETALHADAS - HIST\\u00d3RICO COMPLETO\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_inconsistencias_detalhadas STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    d.nu_cnpj,\\r\\n    d.nu_ie,\\r\\n    d.nu_per_ref,\\r\\n    d.nu_per_ref_identificado,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o da Inconsist\\u00eancia\\r\\n    d.cd_inconsistencia,\\r\\n    t.nm_inconsistencia,\\r\\n    t.natureza_inconsistencia,\\r\\n    t.gravidade_presumida,\\r\\n    t.flag_tem_valor_fiscal,\\r\\n    t.cd_tipo_infracao,\\r\\n    d.tx_chave_inconsistencia,\\r\\n    d.vl_inconsistencia,\\r\\n    \\r\\n    -- Ciclo de Vida\\r\\n    d.cd_situacao,\\r\\n    d.dt_identificada,\\r\\n    d.dt_entrou_malha,\\r\\n    d.dt_saiu_malha,\\r\\n    d.dt_resolvida_malha,\\r\\n    d.dt_em_fiscalizacao,\\r\\n    \\r\\n    -- Canal de Resolu\\u00e7\\u00e3o (PRINCIPAL M\\u00c9TRICA) - CORRIGIDO\\r\\n    CASE \\r\\n        -- 1. Resolvido autonomamente via DDE (melhor cen\\u00e1rio)\\r\\n        WHEN d.id_resolvido_dde IS NOT NULL THEN 'AUTONOMO_DDE'\\r\\n        \\r\\n        -- 2. Resolvido autonomamente via malha (retifica\\u00e7\\u00e3o)\\r\\n        WHEN d.dt_resolvida_malha IS NOT NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL \\r\\n             AND d.id_resolvido_dde IS NULL \\r\\n        THEN 'AUTONOMO_MALHA'\\r\\n        \\r\\n        -- 3. Exclu\\u00eddo por auditor (antes de ir para fiscaliza\\u00e7\\u00e3o)\\r\\n        WHEN d.dt_saiu_malha IS NOT NULL \\r\\n             AND d.dt_resolvida_malha IS NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL \\r\\n             AND d.id_resolvido_dde IS NULL\\r\\n             AND d.dt_em_fiscalizacao IS NULL\\r\\n        THEN 'EXCLUSAO_AUDITOR'\\r\\n        \\r\\n        -- 4. Em fiscaliza\\u00e7\\u00e3o (PAF aberto, mas sem autua\\u00e7\\u00e3o ainda)\\r\\n        WHEN d.dt_em_fiscalizacao IS NOT NULL \\r\\n             AND d.nu_infracao IS NULL\\r\\n             AND d.dt_saiu_malha IS NULL\\r\\n        THEN 'EM_FISCALIZACAO'\\r\\n        \\r\\n        -- 5. Fiscaliza\\u00e7\\u00e3o conclu\\u00edda (passou por PAF, pode ter sido resolvida ou autuada)\\r\\n        WHEN d.cd_motivo_resolvido_fiscal IS NOT NULL \\r\\n             OR d.nu_infracao IS NOT NULL\\r\\n        THEN 'FISCALIZACAO_CONCLUIDA'\\r\\n        \\r\\n        -- 6. Ativa (ainda no prazo de regulariza\\u00e7\\u00e3o - N\\u00c3O \\u00c9 PROBLEMA)\\r\\n        WHEN d.dt_entrou_malha IS NOT NULL \\r\\n             AND d.dt_saiu_malha IS NULL \\r\\n             AND d.dt_em_fiscalizacao IS NULL\\r\\n        THEN 'ATIVA'\\r\\n        \\r\\n        -- 7. Apenas identificada (ainda n\\u00e3o entrou na malha)\\r\\n        ELSE 'IDENTIFICADA'\\r\\n    END AS canal_resolucao,\\r\\n    \\r\\n    -- Subcanal detalhado para fiscaliza\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN d.nu_infracao IS NOT NULL THEN 'FISCALIZACAO_COM_AUTUACAO'\\r\\n        WHEN d.cd_motivo_resolvido_fiscal IS NOT NULL AND d.nu_infracao IS NULL THEN 'FISCALIZACAO_SEM_AUTUACAO'\\r\\n        WHEN d.dt_em_fiscalizacao IS NOT NULL AND d.nu_infracao IS NULL THEN 'FISCALIZACAO_EM_ANDAMENTO'\\r\\n        ELSE NULL\\r\\n    END AS subcanal_fiscalizacao,\\r\\n    \\r\\n    -- Detalhes da Resolu\\u00e7\\u00e3o\\r\\n    d.cd_motivo_resolvido_fiscal,\\r\\n    d.id_resolvido_dde,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    d.id_pacote,\\r\\n    d.nu_os,\\r\\n    d.nu_infracao,\\r\\n    d.nu_notificacao,\\r\\n    d.sn_enviar_fisca,\\r\\n    \\r\\n    -- Processamento\\r\\n    d.id_exec_malha,\\r\\n    d.cd_tipo_execucao,\\r\\n    d.dt_processamento,\\r\\n    \\r\\n    -- Detalhes EFD vs NFe\\r\\n    d.id_efd,\\r\\n    d.nu_chave_efd,\\r\\n    d.vl_total_efd,\\r\\n    d.vl_icms_efd,\\r\\n    d.nu_chave_nfe,\\r\\n    d.vl_total_nfe,\\r\\n    d.vl_icms_nfe,\\r\\n    d.dt_cancelamento_nfe,\\r\\n    \\r\\n    -- Tempos (em dias)\\r\\n    DATEDIFF(COALESCE(d.dt_saiu_malha, CURRENT_DATE()), d.dt_entrou_malha) AS dias_na_malha,\\r\\n    DATEDIFF(d.dt_resolvida_malha, d.dt_identificada) AS dias_ate_resolucao,\\r\\n    DATEDIFF(d.dt_em_fiscalizacao, d.dt_entrou_malha) AS dias_ate_fiscalizacao,\\r\\n    DATEDIFF(COALESCE(d.dt_saiu_malha, CURRENT_DATE()), d.dt_identificada) AS dias_ciclo_total,\\r\\n    \\r\\n    -- Flags de An\\u00e1lise\\r\\n    CASE \\r\\n        WHEN d.id_resolvido_dde IS NOT NULL OR \\r\\n             (d.dt_resolvida_malha IS NOT NULL AND d.cd_motivo_resolvido_fiscal IS NULL) \\r\\n        THEN 1 ELSE 0 \\r\\n    END AS flag_resolucao_autonoma,\\r\\n    \\r\\n    CASE \\r\\n        WHEN d.dt_saiu_malha IS NOT NULL AND d.dt_resolvida_malha IS NULL \\r\\n             AND d.cd_motivo_resolvido_fiscal IS NULL AND d.id_resolvido_dde IS NULL \\r\\n        THEN 1 ELSE 0 \\r\\n    END AS flag_exclusao_auditor,\\r\\n    \\r\\n    CASE WHEN d.nu_infracao IS NOT NULL THEN 1 ELSE 0 END AS flag_gerou_infracao,\\r\\n    \\r\\n    -- Tipo de Inconsist\\u00eancia Categorizado\\r\\n    CASE \\r\\n        WHEN d.nu_chave_nfe IS NOT NULL AND d.nu_chave_efd IS NULL THEN 'OMISSAO_NFE_NA_EFD'\\r\\n        WHEN d.nu_chave_efd IS NOT NULL AND d.nu_chave_nfe IS NULL THEN 'NOTA_FALSA_EFD'\\r\\n        WHEN d.nu_chave_nfe IS NOT NULL AND d.nu_chave_efd IS NOT NULL \\r\\n             AND ABS(d.vl_total_nfe - d.vl_total_efd) > 100 THEN 'DIVERGENCIA_VALOR'\\r\\n        WHEN d.dt_cancelamento_nfe IS NOT NULL THEN 'CANCELAMENTO_NAO_ESTORNADO'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS tipo_detalhado,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_malha.mlh_efd_nfe_incons d\\r\\nLEFT JOIN niat.mlh_catalogo_tipos_inconsistencia t ON d.cd_inconsistencia = t.cd_inconsistencia;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: AN\\u00c1LISE DE PERFORMANCE POR DIMENS\\u00d5ES\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.1. BENCHMARK POR TIPO DE INCONSIST\\u00caNCIA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_benchmark_tipo_inconsistencia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    cat.flag_tem_valor_fiscal,\\r\\n    \\r\\n    -- Contagens\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    COUNT(*) AS qtd_ocorrencias_total,\\r\\n    COUNT(DISTINCT id.nu_per_ref) AS qtd_periodos_geracao,\\r\\n    \\r\\n    -- Valores (quando aplic\\u00e1vel)\\r\\n    SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total,\\r\\n    AVG(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END) AS valor_medio,\\r\\n    STDDEV(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END) AS valor_desvio_padrao,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Canal de Resolu\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n    COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n    COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\\r\\n    \\r\\n    -- Taxas Esperadas (BENCHMARK)\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autonomia_esperada_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_exclusao_esperada_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Desvio Padr\\u00e3o das Taxas (para detectar anomalias)\\r\\n    STDDEV(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1.0 ELSE 0.0 END) AS desvio_taxa_exclusao,\\r\\n    \\r\\n    -- Tempo M\\u00e9dio de Resolu\\u00e7\\u00e3o\\r\\n    AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n    AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n    STDDEV(id.dias_na_malha) AS desvio_dias_malha,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Facilidade de Resolu\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.7 \\r\\n        THEN 'FACIL_RESOLUCAO'\\r\\n        WHEN COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.4 \\r\\n        THEN 'MEDIA_RESOLUCAO'\\r\\n        ELSE 'DIFICIL_RESOLUCAO'\\r\\n    END AS facilidade_resolucao,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Legitimidade de Exclus\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.5 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) < 0.05\\r\\n        THEN 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA'\\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.3 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) < 0.1\\r\\n        THEN 'EXCLUSAO_MEDIA_ANALISAR'\\r\\n        WHEN COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.3 \\r\\n             AND COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) > 0.2\\r\\n        THEN 'EXCLUSAO_ALTA_SUSPEITA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS legitimidade_exclusao,\\r\\n    \\r\\n    -- Score de Efetividade do Tipo (0-100)\\r\\n    ROUND(\\r\\n        -- 40% baseado em autua\\u00e7\\u00f5es (quanto maior, mais efetivo)\\r\\n        (COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 40.0 / NULLIF(COUNT(*), 0)) +\\r\\n        -- 30% baseado em resolu\\u00e7\\u00e3o (autonoma OU fiscal)\\r\\n        ((COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) + \\r\\n          COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END)) * 30.0 / NULLIF(COUNT(*), 0)) +\\r\\n        -- 30% baseado em baixa exclus\\u00e3o injustificada\\r\\n        ((1 - (COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0))) * 30)\\r\\n    , 2) AS score_efetividade_tipo,\\r\\n    \\r\\n    -- Per\\u00edodos de Atividade\\r\\n    MIN(id.nu_per_ref) AS periodo_primeira_geracao,\\r\\n    MAX(id.nu_per_ref) AS periodo_ultima_geracao,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nINNER JOIN niat.mlh_inconsistencias_detalhadas id ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\nGROUP BY \\r\\n    cat.cd_inconsistencia, cat.nm_inconsistencia, cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida, cat.flag_tem_valor_fiscal\\r\\nHAVING COUNT(*) >= 10;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.2. PERFORMANCE DOS CONTADORES (FOCO EM AUTONOMIA)\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_performance_contadores STORED AS PARQUET AS\\r\\nWITH empresas_contador AS (\\r\\n    SELECT DISTINCT\\r\\n        eb.nu_cpf_cnpj_contador,\\r\\n        eb.nm_contador,\\r\\n        eb.nu_crc_contador,\\r\\n        eb.cd_munic_contador,\\r\\n        eb.cd_uf_contador,\\r\\n        eb.nu_cnpj\\r\\n    FROM niat.mlh_empresas_base eb\\r\\n    WHERE eb.nu_cpf_cnpj_contador IS NOT NULL\\r\\n),\\r\\ninconsistencias_contador AS (\\r\\n    SELECT\\r\\n        ec.nu_cpf_cnpj_contador,\\r\\n        ec.nm_contador,\\r\\n        ec.nu_crc_contador,\\r\\n        ec.cd_munic_contador,\\r\\n        ec.cd_uf_contador,\\r\\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_com_incons,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\\r\\n        \\r\\n        -- Por Canal de Resolu\\u00e7\\u00e3o (M\\u00c9TRICA CHAVE)\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma_total,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\\r\\n        \\r\\n        -- Por Natureza de Inconsist\\u00eancia\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'OMISSAO' THEN 1 END) AS qtd_omissao,\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'CREDITO_INDEVIDO' THEN 1 END) AS qtd_credito_indevido,\\r\\n        COUNT(CASE WHEN id.natureza_inconsistencia = 'DIVERGENCIA_VALOR_MENOR' THEN 1 END) AS qtd_divergencia,\\r\\n        \\r\\n        -- Tipos Distintos\\r\\n        COUNT(DISTINCT id.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n        \\r\\n        -- Tempo\\r\\n        AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n        AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n        AVG(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN id.dias_ciclo_total END) AS media_dias_resolucao_fiscal\\r\\n        \\r\\n    FROM empresas_contador ec\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ec.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ec.nu_cpf_cnpj_contador, ec.nm_contador, ec.nu_crc_contador, \\r\\n             ec.cd_munic_contador, ec.cd_uf_contador\\r\\n)\\r\\nSELECT\\r\\n    ic.nu_cpf_cnpj_contador,\\r\\n    ic.nm_contador,\\r\\n    ic.nu_crc_contador,\\r\\n    ic.cd_munic_contador,\\r\\n    ic.cd_uf_contador,\\r\\n    \\r\\n    -- Carteira de Clientes\\r\\n    COUNT(DISTINCT ec.nu_cnpj) AS qtd_clientes_total,\\r\\n    ic.qtd_empresas_com_incons,\\r\\n    ROUND(ic.qtd_empresas_com_incons * 100.0 / NULLIF(COUNT(DISTINCT ec.nu_cnpj), 0), 2) AS taxa_clientes_com_incons_pct,\\r\\n    \\r\\n    -- Inconsist\\u00eancias\\r\\n    ic.qtd_total_inconsistencias,\\r\\n    ic.valor_total_inconsistencias,\\r\\n    ROUND(ic.valor_total_inconsistencias / NULLIF(ic.qtd_empresas_com_incons, 0), 2) AS valor_medio_por_empresa,\\r\\n    \\r\\n    -- Resolu\\u00e7\\u00e3o por Canal (FOCO PRINCIPAL)\\r\\n    ic.qtd_resolvidas_dde,\\r\\n    ic.qtd_resolvidas_malha_auto,\\r\\n    ic.qtd_resolucao_autonoma_total,\\r\\n    ic.qtd_resolvidas_fiscalizacao,\\r\\n    ic.qtd_excluidas_auditor,\\r\\n    ic.qtd_ativas,\\r\\n    ic.qtd_autuacoes,\\r\\n    \\r\\n    -- Taxas de Autonomia (M\\u00c9TRICA CHAVE)\\r\\n    ROUND(ic.qtd_resolucao_autonoma_total * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_autonomia_pct,\\r\\n    ROUND(ic.qtd_resolvidas_dde * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_resolucao_dde_pct,\\r\\n    ROUND(ic.qtd_ativas * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_pendencia_pct,\\r\\n    ROUND(ic.qtd_autuacoes * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_autuacao_pct,\\r\\n    ROUND(ic.qtd_excluidas_auditor * 100.0 / NULLIF(ic.qtd_total_inconsistencias, 0), 2) AS taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Padr\\u00f5es de Inconsist\\u00eancias\\r\\n    ic.qtd_tipos_inconsistencia,\\r\\n    ic.qtd_omissao,\\r\\n    ic.qtd_credito_indevido,\\r\\n    ic.qtd_divergencia,\\r\\n    \\r\\n    -- Performance Temporal\\r\\n    ic.media_dias_malha,\\r\\n    ic.media_dias_resolucao_autonoma,\\r\\n    ic.media_dias_resolucao_fiscal,\\r\\n    \\r\\n    -- Score de Performance do Contador (0-100)\\r\\n    ROUND(\\r\\n        -- 50% baseado em autonomia (quanto mais resolve sozinho, melhor)\\r\\n        (ic.qtd_resolucao_autonoma_total * 50.0 / NULLIF(ic.qtd_total_inconsistencias, 0)) +\\r\\n        -- 30% baseado em baixa pend\\u00eancia (quanto menos pendente, melhor)\\r\\n        ((1 - (ic.qtd_ativas * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0))) * 30) +\\r\\n        -- 20% baseado em baixa autua\\u00e7\\u00e3o (quanto menos autua\\u00e7\\u00e3o, melhor)\\r\\n        ((1 - (ic.qtd_autuacoes * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0))) * 20)\\r\\n    , 2) AS score_performance,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Performance\\r\\n    CASE \\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'EXCELENTE_AUTONOMIA'\\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.5 \\r\\n        THEN 'BOA_AUTONOMIA'\\r\\n        WHEN ic.qtd_resolucao_autonoma_total * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.3 \\r\\n        THEN 'AUTONOMIA_REGULAR'\\r\\n        WHEN ic.qtd_autuacoes * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.3 \\r\\n        THEN 'ALTO_RISCO_AUTUACAO'\\r\\n        WHEN ic.qtd_ativas * 1.0 / NULLIF(ic.qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS classificacao_performance,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM inconsistencias_contador ic\\r\\nLEFT JOIN empresas_contador ec ON ic.nu_cpf_cnpj_contador = ec.nu_cpf_cnpj_contador\\r\\nGROUP BY \\r\\n    ic.nu_cpf_cnpj_contador, ic.nm_contador, ic.nu_crc_contador,\\r\\n    ic.cd_munic_contador, ic.cd_uf_contador,\\r\\n    ic.qtd_empresas_com_incons, ic.qtd_total_inconsistencias, ic.valor_total_inconsistencias,\\r\\n    ic.qtd_resolvidas_dde, ic.qtd_resolvidas_malha_auto, ic.qtd_resolucao_autonoma_total,\\r\\n    ic.qtd_resolvidas_fiscalizacao, ic.qtd_excluidas_auditor, ic.qtd_ativas, ic.qtd_autuacoes,\\r\\n    ic.qtd_tipos_inconsistencia, ic.qtd_omissao, ic.qtd_credito_indevido, ic.qtd_divergencia,\\r\\n    ic.media_dias_malha, ic.media_dias_resolucao_autonoma, ic.media_dias_resolucao_fiscal;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: TABELA 2.3 - PERFORMANCE DE DAFs (CORRIGIDA)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_performance_dafs;\\r\\n\\r\\nCREATE TABLE niat.mlh_performance_dafs STORED AS PARQUET AS\\r\\nWITH empresas_por_daf AS (\\r\\n    SELECT DISTINCT\\r\\n        eb.id_equipe,\\r\\n        eb.nu_cnpj\\r\\n    FROM niat.mlh_empresas_base eb\\r\\n    WHERE eb.id_equipe IS NOT NULL\\r\\n),\\r\\ninconsistencias_daf AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_acompanhadas,\\r\\n        COUNT(DISTINCT eb.nu_cpf_cnpj_contador) AS qtd_contadores_acompanhados,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\\r\\n        \\r\\n        -- Por Canal de Resolu\\u00e7\\u00e3o (CORRIGIDO - foco no que \\u00e9 PROBLEMA)\\r\\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO_CONCLUIDA' THEN 1 END) AS qtd_fiscalizacao_total,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'EM_FISCALIZACAO' THEN 1 END) AS qtd_em_fiscalizacao,\\r\\n        COUNT(CASE WHEN id.subcanal_fiscalizacao = 'FISCALIZACAO_COM_AUTUACAO' THEN 1 END) AS qtd_autuacoes,\\r\\n        COUNT(CASE WHEN id.subcanal_fiscalizacao = 'FISCALIZACAO_SEM_AUTUACAO' THEN 1 END) AS qtd_fiscalizacao_resolvida,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'IDENTIFICADA' THEN 1 END) AS qtd_identificadas,\\r\\n\\r\\n        -- Tipos\\r\\n        COUNT(DISTINCT id.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n        \\r\\n        -- Tempo\\r\\n        AVG(id.dias_na_malha) AS media_dias_malha,\\r\\n        AVG(CASE WHEN id.flag_resolucao_autonoma = 1 THEN id.dias_ate_resolucao END) AS media_dias_resolucao_autonoma\\r\\n        \\r\\n    FROM empresas_por_daf ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    LEFT JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n)\\r\\nSELECT\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    qtd_total_inconsistencias,\\r\\n    valor_total_inconsistencias,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Status (para entendimento do funil)\\r\\n    qtd_identificadas,\\r\\n    qtd_ativas,\\r\\n    qtd_resolucao_autonoma,\\r\\n    qtd_em_fiscalizacao,\\r\\n    qtd_fiscalizacao_total,\\r\\n    qtd_autuacoes,\\r\\n    qtd_excluidas_auditor,\\r\\n    \\r\\n    -- Taxas B\\u00e1sicas\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_autonomia_pct,\\r\\n    ROUND(qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_exclusao_pct,\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_autuacao_pct,\\r\\n    ROUND(qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_ativas_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- INDICADORES CORRIGIDOS - INTERPRETA\\u00c7\\u00c3O ADEQUADA DO FLUXO\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- 1. INDICADOR DE AUTONOMIA (quanto maior, melhor)\\r\\n    -- Empresas que resolvem sozinhas = EXCELENTE\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_autonomia_pct,\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.70 THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.50 THEN 'BOM'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.35 THEN 'REGULAR'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) >= 0.20 THEN 'BAIXO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_autonomia_nivel,\\r\\n    \\r\\n    -- 2. INDICADOR DE ATIVAS (NEUTRO - n\\u00e3o \\u00e9 problema, \\u00e9 prazo normal)\\r\\n    -- Aqui s\\u00f3 monitoramos se est\\u00e1 muito alta (pode indicar lentid\\u00e3o)\\r\\n    ROUND(qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_ativas_pct,\\r\\n    CASE \\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 'NORMAL'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ATENCAO_VOLUME'\\r\\n        ELSE 'ALTO_VOLUME'\\r\\n    END AS ind_ativas_nivel,\\r\\n    \\r\\n    -- 3. INDICADOR DE FISCALIZA\\u00c7\\u00c3O (quanto MAIOR, PIOR - \\u00c9 O PROBLEMA!)\\r\\n    -- Inconsist\\u00eancias que precisaram de PAF = N\\u00c3O regularizaram no prazo\\r\\n    ROUND((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_fiscalizacao_pct,\\r\\n    CASE \\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'EXCELENTE'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'BOM'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.35 THEN 'REGULAR'\\r\\n        WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_fiscalizacao_nivel,\\r\\n    \\r\\n    -- 4. INDICADOR DE AUTUA\\u00c7\\u00c3O (quanto menor, melhor - \\u00e9 o mais grave)\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_autuacao_pct,\\r\\n    CASE \\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.05 THEN 'EXCELENTE'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'BOM'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'REGULAR'\\r\\n        WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_autuacao_nivel,\\r\\n    \\r\\n    -- 5. INDICADOR DE EXCLUS\\u00c3O (quanto menor, melhor - pode indicar problema)\\r\\n    ROUND(qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS ind_exclusao_pct,\\r\\n    CASE \\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.10 THEN 'EXCELENTE'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.20 THEN 'BOM'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.35 THEN 'REGULAR'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.50 THEN 'ALTO'\\r\\n        ELSE 'CRITICO'\\r\\n    END AS ind_exclusao_nivel,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- M\\u00c9TRICAS ADICIONAIS IMPORTANTES\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Taxa de convers\\u00e3o: das que foram para fiscaliza\\u00e7\\u00e3o, quantas viraram autua\\u00e7\\u00e3o\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_fiscalizacao_total + qtd_em_fiscalizacao, 0), 2) AS taxa_conversao_fiscalizacao_autuacao,\\r\\n    \\r\\n    -- Taxa de efetividade: resolveram + autuaram (n\\u00e3o foram exclu\\u00eddas indevidamente)\\r\\n    ROUND((qtd_resolucao_autonoma + qtd_autuacoes) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_efetividade_geral,\\r\\n    \\r\\n    -- Taxa de necessidade de fiscaliza\\u00e7\\u00e3o (complemento da autonomia)\\r\\n    ROUND((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS taxa_necessidade_fiscalizacao,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- SCORES NUM\\u00c9RICOS (0-100) CORRIGIDOS\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Score de Autonomia (0-100): quanto maior, melhor\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS score_autonomia,\\r\\n    \\r\\n    -- Score de Fiscaliza\\u00e7\\u00e3o (0-100): invertido - quanto MENOS for para fiscaliza\\u00e7\\u00e3o, melhor\\r\\n    ROUND((1 - ((qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0))) * 100, 2) AS score_fiscalizacao,\\r\\n    \\r\\n    -- Score de Exclus\\u00e3o (0-100): quanto menor exclus\\u00e3o, melhor\\r\\n    ROUND((1 - (qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0))) * 100, 2) AS score_exclusao,\\r\\n    \\r\\n    -- Score de Autua\\u00e7\\u00e3o (0-100): balanceado - queremos um meio termo\\r\\n    ROUND(\\r\\n        CASE \\r\\n            -- Ideal entre 5-15%: score m\\u00e1ximo (100)\\r\\n            WHEN CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) BETWEEN 0.05 AND 0.15 THEN 100.0\\r\\n            -- Acima de 15%: penaliza progressivamente\\r\\n            WHEN CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) > 0.15 \\r\\n            THEN GREATEST(0.0, 100.0 - ((CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) - 0.15) * 250.0))\\r\\n            -- Abaixo de 5%: penaliza levemente (pode indicar exclus\\u00e3o excessiva)\\r\\n            ELSE (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0) * 2000.0)\\r\\n        END\\r\\n    , 2) AS score_autuacao,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- SCORE GERAL PONDERADO CORRIGIDO (0-100)\\r\\n    -- ========================================================================\\r\\n    ROUND(\\r\\n        -- 40% Autonomia (peso maior - \\u00e9 o ideal)\\r\\n        (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n        \\r\\n        -- 30% Baixa necessidade de Fiscaliza\\u00e7\\u00e3o (invertido - quanto MENOS fiscaliza\\u00e7\\u00e3o, melhor)\\r\\n        ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                  NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n        \\r\\n        -- 20% Baixa Autua\\u00e7\\u00e3o (invertido - quanto menos autua\\u00e7\\u00e3o, melhor)\\r\\n        ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n        \\r\\n        -- 10% Baixa Exclus\\u00e3o (invertido - quanto menos exclus\\u00e3o suspeita, melhor)\\r\\n        ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n    , 2) AS score_geral_ponderado,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- CLASSIFICA\\u00c7\\u00c3O GERAL CORRIGIDA\\r\\n    -- ========================================================================\\r\\n    CASE \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 80.0 THEN 'EXCELENTE'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 65.0 THEN 'BOM'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 50.0 THEN 'REGULAR'\\r\\n        \\r\\n        WHEN (\\r\\n            (CAST(qtd_resolucao_autonoma AS DOUBLE) * 40.0 / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0)) +\\r\\n            ((1.0 - ((CAST(qtd_fiscalizacao_total AS DOUBLE) + CAST(qtd_em_fiscalizacao AS DOUBLE)) / \\r\\n                      NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 30.0) +\\r\\n            ((1.0 - (CAST(qtd_autuacoes AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 20.0) +\\r\\n            ((1.0 - (CAST(qtd_excluidas_auditor AS DOUBLE) / NULLIF(CAST(qtd_total_inconsistencias AS DOUBLE), 0))) * 10.0)\\r\\n        ) >= 35.0 THEN 'ATENCAO'\\r\\n        \\r\\n        ELSE 'CRITICO'\\r\\n    END AS classificacao_geral,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- FLAGS DE ALERTA CORRIGIDAS\\r\\n    -- ========================================================================\\r\\n    CASE WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.30 THEN 1 ELSE 0 END AS flag_alerta_autonomia_baixa,\\r\\n    CASE WHEN (qtd_fiscalizacao_total + qtd_em_fiscalizacao) * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.40 THEN 1 ELSE 0 END AS flag_alerta_fiscalizacao_alta,\\r\\n    CASE WHEN qtd_autuacoes * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.25 THEN 1 ELSE 0 END AS flag_alerta_autuacao_alta,\\r\\n    CASE WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.40 THEN 1 ELSE 0 END AS flag_alerta_exclusao_alta,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM inconsistencias_daf\\r\\nWHERE qtd_total_inconsistencias >= 100;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: AN\\u00c1LISE DE EXCLUS\\u00d5ES E LEGITIMIDADE\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.1. AN\\u00c1LISE DE EXCLUS\\u00d5ES POR AUDITOR/DAF\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_analise_exclusoes_auditores STORED AS PARQUET AS\\r\\nWITH exclusoes_por_tipo AS (\\r\\n    SELECT\\r\\n        eb.id_equipe AS id_equipe_auditor,\\r\\n        id.cd_inconsistencia,\\r\\n        id.nm_inconsistencia,\\r\\n        ben.legitimidade_exclusao AS legitimidade_tipo,\\r\\n        ben.taxa_exclusao_esperada_pct,\\r\\n        \\r\\n        COUNT(*) AS qtd_inconsistencias_tipo,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_tipo,\\r\\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes_tipo\\r\\n    FROM niat.mlh_inconsistencias_detalhadas id\\r\\n    INNER JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\\r\\n    LEFT JOIN niat.mlh_benchmark_tipo_inconsistencia ben ON id.cd_inconsistencia = ben.cd_inconsistencia\\r\\n    WHERE eb.id_equipe IS NOT NULL\\r\\n    GROUP BY eb.id_equipe, id.cd_inconsistencia, id.nm_inconsistencia, \\r\\n             ben.legitimidade_exclusao, ben.taxa_exclusao_esperada_pct\\r\\n)\\r\\nSELECT\\r\\n    id_equipe_auditor,\\r\\n    \\r\\n    -- Totais\\r\\n    SUM(qtd_inconsistencias_tipo) AS qtd_total_inconsistencias,\\r\\n    SUM(qtd_excluidas_tipo) AS qtd_total_excluidas,\\r\\n    SUM(qtd_autuacoes_tipo) AS qtd_total_autuacoes,\\r\\n    \\r\\n    -- Taxa Geral de Exclus\\u00e3o\\r\\n    ROUND(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0), 2) AS taxa_exclusao_geral_pct,\\r\\n    \\r\\n    -- Exclus\\u00f5es por Legitimidade\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_legitimas,\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_suspeitas,\\r\\n    SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_MEDIA_ANALISAR' THEN qtd_excluidas_tipo ELSE 0 END) AS qtd_exclusoes_analisar,\\r\\n    \\r\\n    -- Taxas Ajustadas\\r\\n    ROUND(SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 100.0 / \\r\\n          NULLIF(SUM(qtd_excluidas_tipo), 0), 2) AS taxa_exclusao_suspeita_pct,\\r\\n    \\r\\n    -- Desvio da Taxa Esperada (m\\u00e9dia ponderada)\\r\\n    ROUND(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n          AVG(taxa_exclusao_esperada_pct), 2) AS desvio_taxa_esperada,\\r\\n    \\r\\n    -- Score de Legitimidade das Exclus\\u00f5es (0-100)\\r\\n    ROUND(\\r\\n        -- 50% baseado em baixa exclus\\u00e3o suspeita\\r\\n        ((1 - (SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n               NULLIF(SUM(qtd_excluidas_tipo), 0))) * 50) +\\r\\n        -- 30% baseado em autua\\u00e7\\u00f5es (se exclui pouco e autua muito, \\u00e9 bom)\\r\\n        (SUM(qtd_autuacoes_tipo) * 30.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0)) +\\r\\n        -- 20% baseado em estar pr\\u00f3ximo da taxa esperada\\r\\n        (CASE \\r\\n            WHEN ABS(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n                     AVG(taxa_exclusao_esperada_pct)) < 10 THEN 20\\r\\n            WHEN ABS(SUM(qtd_excluidas_tipo) * 100.0 / NULLIF(SUM(qtd_inconsistencias_tipo), 0) - \\r\\n                     AVG(taxa_exclusao_esperada_pct)) < 20 THEN 10\\r\\n            ELSE 0\\r\\n         END)\\r\\n    , 2) AS score_legitimidade,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.5 \\r\\n        THEN 'ALTA_SUSPEITA'\\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_SUSPEITA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.3 \\r\\n        THEN 'MEDIA_SUSPEITA'\\r\\n        WHEN SUM(CASE WHEN legitimidade_tipo = 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA' THEN qtd_excluidas_tipo ELSE 0 END) * 1.0 / \\r\\n             NULLIF(SUM(qtd_excluidas_tipo), 0) > 0.7 \\r\\n        THEN 'EXCLUSOES_LEGITIMAS'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS classificacao_exclusoes,\\r\\n    \\r\\n    -- Tipos de Inconsist\\u00eancia Distintos\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM exclusoes_por_tipo\\r\\nGROUP BY id_equipe_auditor\\r\\nHAVING SUM(qtd_inconsistencias_tipo) >= 50;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 4: AN\\u00c1LISE TEMPORAL E TEND\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.1. EVOLU\\u00c7\\u00c3O MENSAL DAS MALHAS FISCAIS\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_evolucao_mensal STORED AS PARQUET AS\\r\\nSELECT\\r\\n    nu_per_ref AS periodo,\\r\\n    \\r\\n    -- Contagens\\r\\n    COUNT(DISTINCT nu_cnpj) AS qtd_empresas_periodo,\\r\\n    COUNT(*) AS qtd_inconsistencias_identificadas,\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    \\r\\n    -- Valores\\r\\n    SUM(CASE WHEN flag_tem_valor_fiscal = 1 THEN vl_inconsistencia ELSE 0 END) AS valor_total_identificado,\\r\\n    AVG(CASE WHEN flag_tem_valor_fiscal = 1 THEN vl_inconsistencia END) AS valor_medio_inconsistencia,\\r\\n    \\r\\n    -- Por Canal de Resolu\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN canal_resolucao = 'AUTONOMO_DDE' THEN 1 END) AS qtd_resolvidas_dde,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'AUTONOMO_MALHA' THEN 1 END) AS qtd_resolvidas_malha_auto,\\r\\n    COUNT(CASE WHEN flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n    COUNT(CASE WHEN flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN nu_os IS NOT NULL THEN 1 END) AS qtd_gerou_os,\\r\\n    COUNT(CASE WHEN flag_gerou_infracao = 1 THEN 1 END) AS qtd_gerou_infracao,\\r\\n    \\r\\n    -- Taxas Principais\\r\\n    ROUND(COUNT(CASE WHEN flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autonomia_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_exclusao_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_autuacao_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    AVG(dias_na_malha) AS media_dias_malha,\\r\\n    AVG(CASE WHEN flag_resolucao_autonoma = 1 THEN dias_ate_resolucao END) AS media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Por Natureza\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'OMISSAO' THEN 1 END) AS qtd_omissao,\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'CREDITO_INDEVIDO' THEN 1 END) AS qtd_credito_indevido,\\r\\n    COUNT(CASE WHEN natureza_inconsistencia = 'DIVERGENCIA_VALOR_MENOR' THEN 1 END) AS qtd_divergencia,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_inconsistencias_detalhadas\\r\\nWHERE nu_per_ref BETWEEN 202101 AND 202509\\r\\nGROUP BY nu_per_ref\\r\\nORDER BY nu_per_ref;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 5: RANKINGS E DASHBOARDS\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 5.1. RANKING DE CONTADORES POR AUTONOMIA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_ranking_contadores_autonomia STORED AS PARQUET AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY taxa_autonomia_pct DESC, qtd_clientes_total DESC) AS ranking_autonomia,\\r\\n    nu_cpf_cnpj_contador,\\r\\n    nm_contador,\\r\\n    nu_crc_contador,\\r\\n    cd_munic_contador,\\r\\n    cd_uf_contador,\\r\\n    \\r\\n    -- M\\u00e9tricas Chave\\r\\n    qtd_clientes_total,\\r\\n    qtd_empresas_com_incons,\\r\\n    qtd_total_inconsistencias,\\r\\n    valor_total_inconsistencias,\\r\\n    \\r\\n    -- Autonomia (M\\u00c9TRICA PRINCIPAL)\\r\\n    taxa_autonomia_pct,\\r\\n    qtd_resolucao_autonoma_total,\\r\\n    qtd_resolvidas_dde,\\r\\n    \\r\\n    -- Outras Taxas\\r\\n    taxa_pendencia_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    score_performance,\\r\\n    classificacao_performance,\\r\\n    \\r\\n    -- Quartil de Autonomia\\r\\n    NTILE(4) OVER (ORDER BY taxa_autonomia_pct) AS quartil_autonomia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Geral\\r\\n    CASE \\r\\n        WHEN taxa_autonomia_pct >= 70 AND taxa_autuacao_pct < 10 THEN 'TOP_PERFORMER'\\r\\n        WHEN taxa_autonomia_pct >= 50 AND taxa_autuacao_pct < 20 THEN 'BOM_PERFORMER'\\r\\n        WHEN taxa_autonomia_pct >= 30 THEN 'REGULAR'\\r\\n        WHEN taxa_autuacao_pct > 30 THEN 'CRITICO_AUTUACOES'\\r\\n        WHEN taxa_pendencia_pct > 70 THEN 'CRITICO_PENDENCIAS'\\r\\n        ELSE 'NECESSITA_ATENCAO'\\r\\n    END AS classificacao_geral,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_performance_contadores\\r\\nWHERE qtd_empresas_com_incons >= 3\\r\\nORDER BY taxa_autonomia_pct DESC;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 5.2. RANKING DE TIPOS DE INCONSIST\\u00caNCIA POR EFETIVIDADE\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_ranking_tipos_efetividade STORED AS PARQUET AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY score_efetividade_tipo DESC) AS ranking_efetividade,\\r\\n    cd_inconsistencia,\\r\\n    nm_inconsistencia,\\r\\n    natureza_inconsistencia,\\r\\n    gravidade_presumida,\\r\\n    \\r\\n    -- Volumes\\r\\n    qtd_empresas_afetadas,\\r\\n    qtd_ocorrencias_total,\\r\\n    valor_total,\\r\\n    \\r\\n    -- Resolu\\u00e7\\u00e3o\\r\\n    taxa_autonomia_esperada_pct,\\r\\n    taxa_exclusao_esperada_pct,\\r\\n    taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00f5es\\r\\n    facilidade_resolucao,\\r\\n    legitimidade_exclusao,\\r\\n    score_efetividade_tipo,\\r\\n    \\r\\n    -- Tempo\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Geral\\r\\n    CASE \\r\\n        WHEN score_efetividade_tipo >= 70 THEN 'ALTAMENTE_EFETIVO'\\r\\n        WHEN score_efetividade_tipo >= 50 THEN 'EFETIVO'\\r\\n        WHEN score_efetividade_tipo >= 30 THEN 'MODERADAMENTE_EFETIVO'\\r\\n        ELSE 'BAIXA_EFETIVIDADE'\\r\\n    END AS classificacao_efetividade,\\r\\n    \\r\\n    -- Flag de Aten\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN legitimidade_exclusao = 'EXCLUSAO_ALTA_SUSPEITA' THEN 1\\r\\n        WHEN taxa_exclusao_esperada_pct > 70 AND taxa_autuacao_esperada_pct < 5 THEN 1\\r\\n        WHEN facilidade_resolucao = 'DIFICIL_RESOLUCAO' AND taxa_autonomia_esperada_pct < 20 THEN 1\\r\\n        ELSE 0\\r\\n    END AS flag_necessita_revisao,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_benchmark_tipo_inconsistencia\\r\\nORDER BY score_efetividade_tipo DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: TABELA 5.3 - RANKING DE DAFs (CORRIGIDA)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_ranking_dafs;\\r\\n\\r\\nCREATE TABLE niat.mlh_ranking_dafs STORED AS PARQUET AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY score_geral_ponderado DESC) AS ranking_geral,\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    qtd_total_inconsistencias,\\r\\n    ROUND(valor_total_inconsistencias / 1000000, 2) AS valor_incons_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_exclusao_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    taxa_ativas_pct,\\r\\n    taxa_necessidade_fiscalizacao,\\r\\n    \\r\\n    -- Performance\\r\\n    score_geral_ponderado,\\r\\n    classificacao_geral,  -- V\\u00cdRGULA CORRIGIDA!\\r\\n    \\r\\n    -- Quartil\\r\\n    NTILE(4) OVER (ORDER BY score_geral_ponderado) AS quartil_performance,\\r\\n    \\r\\n    -- Tempo\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_performance_dafs\\r\\nORDER BY score_geral_ponderado DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 6: VIEWS PARA DASHBOARDS E AN\\u00c1LISES\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.1. DASHBOARD EXECUTIVO V2.0\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_dashboard_executivo_v2 AS\\r\\nSELECT\\r\\n    -- Resumo Geral\\r\\n    (SELECT COUNT(DISTINCT nu_cnpj) FROM niat.mlh_empresas_base \\r\\n     WHERE flag_atualmente_em_malha = 1) AS empresas_em_malha_ativa,\\r\\n    \\r\\n    (SELECT COUNT(*) FROM niat.mlh_inconsistencias_detalhadas \\r\\n     WHERE canal_resolucao = 'ATIVA') AS inconsistencias_ativas,\\r\\n    \\r\\n    (SELECT SUM(CASE WHEN flag_tem_valor_fiscal = 1 THEN vl_inconsistencia ELSE 0 END) \\r\\n     FROM niat.mlh_inconsistencias_detalhadas \\r\\n     WHERE canal_resolucao = 'ATIVA') AS valor_ativo_malhas,\\r\\n    \\r\\n    -- Taxas de Autonomia (M\\u00c9TRICA CHAVE)\\r\\n    (SELECT ROUND(AVG(taxa_autonomia_pct), 2) \\r\\n     FROM niat.mlh_evolucao_mensal \\r\\n     WHERE periodo >= 202401) AS taxa_autonomia_media_2024,\\r\\n    \\r\\n    (SELECT ROUND(AVG(taxa_exclusao_pct), 2) \\r\\n     FROM niat.mlh_evolucao_mensal \\r\\n     WHERE periodo >= 202401) AS taxa_exclusao_media_2024,\\r\\n    \\r\\n    (SELECT ROUND(AVG(taxa_autuacao_pct), 2) \\r\\n     FROM niat.mlh_evolucao_mensal \\r\\n     WHERE periodo >= 202401) AS taxa_autuacao_media_2024,\\r\\n    \\r\\n    -- Performance de Contadores\\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_contadores_autonomia \\r\\n     WHERE classificacao_geral = 'TOP_PERFORMER') AS contadores_top_performer,\\r\\n    \\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_contadores_autonomia \\r\\n     WHERE classificacao_geral IN ('CRITICO_AUTUACOES', 'CRITICO_PENDENCIAS')) AS contadores_criticos,\\r\\n    \\r\\n    -- Efetividade de Tipos\\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_tipos_efetividade \\r\\n     WHERE flag_necessita_revisao = 1) AS tipos_necessitam_revisao,\\r\\n    \\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_tipos_efetividade \\r\\n     WHERE classificacao_efetividade = 'ALTAMENTE_EFETIVO') AS tipos_altamente_efetivos,\\r\\n    \\r\\n    -- Exclus\\u00f5es\\r\\n    (SELECT COUNT(*) FROM niat.mlh_analise_exclusoes_auditores \\r\\n     WHERE classificacao_exclusoes IN ('ALTA_SUSPEITA', 'MEDIA_SUSPEITA')) AS equipes_exclusoes_suspeitas,\\r\\n    \\r\\n    -- DAFs\\r\\n    (SELECT COUNT(*) FROM niat.mlh_ranking_dafs \\r\\n     WHERE classificacao_geral = 'EXCELENTE') AS dafs_excelentes,\\r\\n    \\r\\n    -- Timestamp\\r\\n    CURRENT_TIMESTAMP() AS dt_atualizacao;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.2. VIEW DE CONTADORES - FOCO EM AUTONOMIA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_contadores_autonomia AS\\r\\nSELECT\\r\\n    rc.ranking_autonomia,\\r\\n    rc.nu_cpf_cnpj_contador,\\r\\n    rc.nm_contador,\\r\\n    rc.nu_crc_contador,\\r\\n    rc.cd_munic_contador,\\r\\n    rc.cd_uf_contador,\\r\\n    rc.qtd_clientes_total,\\r\\n    rc.qtd_empresas_com_incons,\\r\\n    ROUND(rc.valor_total_inconsistencias / 1000000, 2) AS valor_incons_milhoes,\\r\\n    \\r\\n    -- M\\u00e9tricas de Autonomia\\r\\n    rc.taxa_autonomia_pct,\\r\\n    rc.qtd_resolucao_autonoma_total,\\r\\n    rc.qtd_resolvidas_dde,\\r\\n    pc.qtd_resolvidas_malha_auto,\\r\\n    \\r\\n    -- Outras M\\u00e9tricas\\r\\n    rc.taxa_pendencia_pct,\\r\\n    rc.taxa_autuacao_pct,\\r\\n    rc.taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    rc.score_performance,\\r\\n    rc.classificacao_performance,\\r\\n    rc.classificacao_geral,\\r\\n    rc.quartil_autonomia,\\r\\n    \\r\\n    -- Detalhes\\r\\n    pc.media_dias_resolucao_autonoma,\\r\\n    pc.qtd_tipos_inconsistencia,\\r\\n    pc.qtd_omissao,\\r\\n    pc.qtd_credito_indevido\\r\\n\\r\\nFROM niat.mlh_ranking_contadores_autonomia rc\\r\\nINNER JOIN niat.mlh_performance_contadores pc \\r\\n    ON rc.nu_cpf_cnpj_contador = pc.nu_cpf_cnpj_contador;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.3. VIEW DE TIPOS DE INCONSIST\\u00caNCIA - BENCHMARK\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_tipos_benchmark AS\\r\\nSELECT\\r\\n    rt.ranking_efetividade,\\r\\n    rt.cd_inconsistencia,\\r\\n    rt.nm_inconsistencia,\\r\\n    rt.natureza_inconsistencia,\\r\\n    rt.gravidade_presumida,\\r\\n    rt.qtd_empresas_afetadas,\\r\\n    rt.qtd_ocorrencias_total,\\r\\n    ROUND(rt.valor_total / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- Taxas Benchmark\\r\\n    rt.taxa_autonomia_esperada_pct,\\r\\n    rt.taxa_exclusao_esperada_pct,\\r\\n    rt.taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00f5es\\r\\n    rt.facilidade_resolucao,\\r\\n    rt.legitimidade_exclusao,\\r\\n    rt.classificacao_efetividade,\\r\\n    rt.score_efetividade_tipo,\\r\\n    rt.flag_necessita_revisao,\\r\\n    \\r\\n    -- Tempo\\r\\n    rt.media_dias_malha,\\r\\n    rt.media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Cat\\u00e1logo\\r\\n    cat.flag_tem_valor_fiscal\\r\\n\\r\\nFROM niat.mlh_ranking_tipos_efetividade rt\\r\\nINNER JOIN niat.mlh_catalogo_tipos_inconsistencia cat \\r\\n    ON rt.cd_inconsistencia = cat.cd_inconsistencia;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: VIEW 6.4 - DAFs PERFORMANCE (CORRIGIDA)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_dafs_performance;\\r\\n\\r\\nCREATE VIEW niat.vw_mlh_dafs_performance AS\\r\\nSELECT\\r\\n    rd.ranking_geral,\\r\\n    rd.id_equipe,\\r\\n    rd.qtd_empresas_acompanhadas,\\r\\n    rd.qtd_contadores_acompanhados,\\r\\n    rd.qtd_total_inconsistencias,\\r\\n    rd.valor_incons_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    rd.taxa_autonomia_pct,\\r\\n    rd.taxa_exclusao_pct,\\r\\n    rd.taxa_autuacao_pct,\\r\\n    rd.taxa_ativas_pct,\\r\\n    rd.taxa_necessidade_fiscalizacao,\\r\\n    \\r\\n    -- Performance\\r\\n    rd.score_geral_ponderado,\\r\\n    rd.classificacao_geral,\\r\\n    rd.quartil_performance,\\r\\n    \\r\\n    -- Exclus\\u00f5es\\r\\n    COALESCE(ae.classificacao_exclusoes, 'SEM_ANALISE') AS classificacao_exclusoes,\\r\\n    COALESCE(ae.score_legitimidade, 0) AS score_legitimidade_exclusoes,\\r\\n    COALESCE(ae.qtd_exclusoes_suspeitas, 0) AS qtd_exclusoes_suspeitas,\\r\\n    \\r\\n    -- Tempo\\r\\n    rd.media_dias_malha,\\r\\n    rd.media_dias_resolucao_autonoma\\r\\n\\r\\nFROM niat.mlh_ranking_dafs rd\\r\\nLEFT JOIN niat.mlh_analise_exclusoes_auditores ae \\r\\n    ON rd.id_equipe = ae.id_equipe_auditor;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.5. VIEW DE S\\u00c9RIE TEMPORAL - EVOLU\\u00c7\\u00c3O\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_serie_temporal AS\\r\\nSELECT\\r\\n    periodo,\\r\\n    qtd_empresas_periodo,\\r\\n    qtd_inconsistencias_identificadas,\\r\\n    ROUND(valor_total_identificado / 1000000, 2) AS valor_identificado_milhoes,\\r\\n    \\r\\n    -- Por Canal\\r\\n    qtd_resolvidas_dde,\\r\\n    qtd_resolvidas_malha_auto,\\r\\n    qtd_resolucao_autonoma,\\r\\n    qtd_resolvidas_fiscalizacao,\\r\\n    qtd_excluidas_auditor,\\r\\n    qtd_ativas,\\r\\n    qtd_gerou_infracao,\\r\\n    \\r\\n    -- Taxas\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_exclusao_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    media_dias_malha,\\r\\n    media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Por Natureza\\r\\n    qtd_omissao,\\r\\n    qtd_credito_indevido,\\r\\n    qtd_divergencia\\r\\n\\r\\nFROM niat.mlh_evolucao_mensal\\r\\nORDER BY periodo;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6.6. VIEW DE TIPOS DE INCONSIST\\u00caNCIA - AN\\u00c1LISE DETALHADA\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE VIEW niat.vw_mlh_tipos_detalhado AS\\r\\nSELECT\\r\\n    ROW_NUMBER() OVER (ORDER BY ben.score_efetividade_tipo DESC) AS ranking_tipo,\\r\\n    ben.cd_inconsistencia,\\r\\n    ben.nm_inconsistencia,\\r\\n    ben.natureza_inconsistencia,\\r\\n    ben.gravidade_presumida,\\r\\n    ben.qtd_empresas_afetadas,\\r\\n    ben.qtd_ocorrencias_total,\\r\\n    ROUND(ben.valor_total / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    ben.taxa_autonomia_esperada_pct,\\r\\n    ben.taxa_exclusao_esperada_pct,\\r\\n    ben.taxa_autuacao_esperada_pct,\\r\\n    \\r\\n    -- Performance\\r\\n    ben.score_efetividade_tipo,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN ben.score_efetividade_tipo >= 70 THEN 'ALTAMENTE_EFETIVO'\\r\\n        WHEN ben.score_efetividade_tipo >= 50 THEN 'EFETIVO'\\r\\n        WHEN ben.score_efetividade_tipo >= 30 THEN 'MODERADAMENTE_EFETIVO'\\r\\n        ELSE 'BAIXA_EFETIVIDADE'\\r\\n    END AS classificacao_efetividade,\\r\\n    \\r\\n    -- Tempo\\r\\n    ben.media_dias_malha,\\r\\n    ben.media_dias_resolucao_autonoma,\\r\\n    \\r\\n    -- Status\\r\\n    CASE \\r\\n        WHEN DATEDIFF(CURRENT_DATE(), FROM_UNIXTIME(UNIX_TIMESTAMP(CONCAT(CAST(ben.periodo_ultima_geracao AS STRING), '01'), 'yyyyMMdd'), 'yyyy-MM-dd')) > 90 THEN 'INATIVO'\\r\\n        WHEN DATEDIFF(CURRENT_DATE(), FROM_UNIXTIME(UNIX_TIMESTAMP(CONCAT(CAST(ben.periodo_ultima_geracao AS STRING), '01'), 'yyyyMMdd'), 'yyyy-MM-dd')) > 30 THEN 'POUCO_ATIVO'\\r\\n        ELSE 'ATIVO'\\r\\n    END AS status_atividade\\r\\n\\r\\nFROM niat.mlh_benchmark_tipo_inconsistencia ben;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 7: AN\\u00c1LISES ESPEC\\u00cdFICAS PARA PYTHON/ML\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 7.1. DATASET PARA AN\\u00c1LISE DE PADR\\u00d5ES DE EXCLUS\\u00c3O\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_dataset_exclusoes_ml STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Identificadores\\r\\n    id.nu_cnpj,\\r\\n    id.cd_inconsistencia,\\r\\n    id.nu_per_ref,\\r\\n    \\r\\n    -- Features do Tipo de Inconsist\\u00eancia\\r\\n    ben.taxa_exclusao_esperada_pct,\\r\\n    ben.taxa_autuacao_esperada_pct,\\r\\n    ben.taxa_autonomia_esperada_pct,\\r\\n    ben.facilidade_resolucao,\\r\\n    ben.legitimidade_exclusao,\\r\\n    ben.score_efetividade_tipo,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    \\r\\n    -- Features da Empresa\\r\\n    eb.cnae_divisao,\\r\\n    eb.secao_cnae,\\r\\n    eb.cd_reg_apuracao,\\r\\n    eb.cd_enq_empresa,\\r\\n    eb.sn_simples_nacional_rfb,\\r\\n    eb.qtd_tipos_inconsistencia_historico,\\r\\n    \\r\\n    -- Features do Contador\\r\\n    pc.taxa_autonomia_pct AS taxa_autonomia_contador,\\r\\n    pc.taxa_autuacao_pct AS taxa_autuacao_contador,\\r\\n    pc.score_performance AS score_contador,\\r\\n    pc.classificacao_performance AS classificacao_contador,\\r\\n    \\r\\n    -- Features da Inconsist\\u00eancia Espec\\u00edfica\\r\\n    id.vl_inconsistencia,\\r\\n    id.dias_na_malha,\\r\\n    id.dias_ate_resolucao,\\r\\n    \\r\\n    -- Target (o que queremos prever)\\r\\n    id.flag_exclusao_auditor AS target_exclusao,\\r\\n    id.flag_resolucao_autonoma AS target_autonomia,\\r\\n    id.flag_gerou_infracao AS target_infracao,\\r\\n    id.canal_resolucao AS target_canal_resolucao,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_inconsistencias_detalhadas id\\r\\nLEFT JOIN niat.mlh_benchmark_tipo_inconsistencia ben \\r\\n    ON id.cd_inconsistencia = ben.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_catalogo_tipos_inconsistencia cat \\r\\n    ON id.cd_inconsistencia = cat.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_empresas_base eb \\r\\n    ON id.nu_cnpj = eb.nu_cnpj\\r\\nLEFT JOIN niat.mlh_performance_contadores pc \\r\\n    ON eb.nu_cpf_cnpj_contador = pc.nu_cpf_cnpj_contador\\r\\nWHERE id.dt_entrou_malha >= '2023-01-01';\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 7.2. AGREGA\\u00c7\\u00c3O PARA AN\\u00c1LISE DE CLUSTER DE CONTADORES\\r\\n-- ----------------------------------------------------------------------------\\r\\nCREATE TABLE niat.mlh_dataset_clusters_contadores STORED AS PARQUET AS\\r\\nSELECT\\r\\n    pc.nu_cpf_cnpj_contador,\\r\\n    pc.nm_contador,\\r\\n    \\r\\n    -- Features de Volume\\r\\n    pc.qtd_clientes_total,\\r\\n    pc.qtd_empresas_com_incons,\\r\\n    pc.qtd_total_inconsistencias,\\r\\n    LN(CAST(pc.valor_total_inconsistencias AS DOUBLE) + 1.0) AS log_valor_total,\\r\\n    \\r\\n    -- Features de Autonomia\\r\\n    pc.taxa_autonomia_pct,\\r\\n    pc.taxa_resolucao_dde_pct,\\r\\n    pc.taxa_pendencia_pct,\\r\\n    pc.taxa_autuacao_pct,\\r\\n    pc.taxa_exclusao_auditor_pct,\\r\\n    \\r\\n    -- Features de Diversidade\\r\\n    pc.qtd_tipos_inconsistencia,\\r\\n    pc.qtd_omissao,\\r\\n    pc.qtd_credito_indevido,\\r\\n    pc.qtd_divergencia,\\r\\n    \\r\\n    -- Features de Tempo\\r\\n    pc.media_dias_malha,\\r\\n    pc.media_dias_resolucao_autonoma,\\r\\n    pc.media_dias_resolucao_fiscal,\\r\\n    \\r\\n    -- Features de Performance\\r\\n    pc.score_performance,\\r\\n    \\r\\n    -- Features Geogr\\u00e1ficas\\r\\n    pc.cd_munic_contador,\\r\\n    pc.cd_uf_contador,\\r\\n    \\r\\n    -- Features de Risco\\r\\n    CASE \\r\\n        WHEN pc.taxa_autuacao_pct > 30 THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS flag_alto_risco_autuacao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN pc.taxa_pendencia_pct > 70 THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS flag_alta_pendencia,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    pc.classificacao_performance,\\r\\n    \\r\\n    -- Metadados\\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM niat.mlh_performance_contadores pc\\r\\nWHERE pc.qtd_total_inconsistencias >= 10;\\r\\n\\r\\n-- ============================================================================\\r\\n-- CRIAR TABELA PR\\u00c9-PROCESSADA PARA ML - VERS\\u00c3O FINAL\\r\\n-- ============================================================================\\r\\n\\r\\nCREATE TABLE niat.mlh_dataset_ml_exclusoes STORED AS PARQUET AS\\r\\nSELECT \\r\\n    -- Features do Tipo\\r\\n    COALESCE(ben.taxa_exclusao_esperada_pct, 0) AS taxa_exclusao_esperada_pct,\\r\\n    COALESCE(ben.taxa_autuacao_esperada_pct, 0) AS taxa_autuacao_esperada_pct,\\r\\n    COALESCE(ben.taxa_autonomia_esperada_pct, 0) AS taxa_autonomia_esperada_pct,\\r\\n    COALESCE(ben.score_efetividade_tipo, 50) AS score_efetividade_tipo,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ben.facilidade_resolucao = 'FACIL_RESOLUCAO' THEN 1\\r\\n        WHEN ben.facilidade_resolucao = 'MEDIA_RESOLUCAO' THEN 2\\r\\n        ELSE 3 \\r\\n    END AS facilidade_num,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ben.legitimidade_exclusao = 'EXCLUSAO_ALTA_PROVAVEL_LEGITIMA' THEN 0\\r\\n        WHEN ben.legitimidade_exclusao = 'NORMAL' THEN 1\\r\\n        WHEN ben.legitimidade_exclusao = 'EXCLUSAO_MEDIA_ANALISAR' THEN 2\\r\\n        ELSE 3 \\r\\n    END AS legitimidade_num,\\r\\n    \\r\\n    CASE \\r\\n        WHEN cat.natureza_inconsistencia = 'OMISSAO' THEN 1\\r\\n        WHEN cat.natureza_inconsistencia = 'CREDITO_INDEVIDO' THEN 2\\r\\n        WHEN cat.natureza_inconsistencia = 'DIVERGENCIA_VALOR_MENOR' THEN 3\\r\\n        ELSE 0 \\r\\n    END AS natureza_num,\\r\\n    \\r\\n    -- Features da Empresa (CORRIGIDO COM C\\u00d3DIGOS NUM\\u00c9RICOS)\\r\\n    CASE WHEN eb.cd_reg_apuracao = 2 THEN 1 ELSE 0 END AS regime_normal,\\r\\n    CASE WHEN eb.cd_reg_apuracao IN (8, 9) THEN 1 ELSE 0 END AS simples_nacional,\\r\\n    COALESCE(eb.qtd_tipos_inconsistencia_historico, 0) AS qtd_tipos_inconsistencia_historico,\\r\\n    \\r\\n    -- C\\u00f3digo do regime (pode ser \\u00fatil no modelo)\\r\\n    eb.cd_reg_apuracao AS cod_regime_apuracao,\\r\\n    \\r\\n    -- Features do Contador\\r\\n    COALESCE(pc.taxa_autonomia_pct, 50) AS contador_taxa_autonomia,\\r\\n    COALESCE(pc.taxa_autuacao_pct, 10) AS contador_taxa_autuacao,\\r\\n    COALESCE(pc.score_performance, 50) AS contador_score,\\r\\n    \\r\\n    -- Features da Inconsist\\u00eancia\\r\\n    LN(COALESCE(id.vl_inconsistencia, 1) + 1) AS log_valor,\\r\\n    COALESCE(id.dias_na_malha, 0) AS dias_malha,\\r\\n    \\r\\n    -- Target\\r\\n    COALESCE(id.flag_exclusao_auditor, 0) AS target_exclusao,\\r\\n    COALESCE(id.flag_gerou_infracao, 0) AS target_infracao\\r\\n    \\r\\nFROM niat.mlh_inconsistencias_detalhadas id\\r\\nLEFT JOIN niat.mlh_benchmark_tipo_inconsistencia ben \\r\\n    ON id.cd_inconsistencia = ben.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_catalogo_tipos_inconsistencia cat \\r\\n    ON id.cd_inconsistencia = cat.cd_inconsistencia\\r\\nLEFT JOIN niat.mlh_empresas_base eb \\r\\n    ON id.nu_cnpj = eb.nu_cnpj\\r\\nLEFT JOIN niat.mlh_performance_contadores pc \\r\\n    ON eb.nu_cpf_cnpj_contador = pc.nu_cpf_cnpj_contador\\r\\nWHERE id.dt_entrou_malha >= '2024-01-01'\\r\\n  AND id.dt_saiu_malha IS NOT NULL;\\r\\n\\r\\n-- ============================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES E ESTAT\\u00cdSTICAS FINAIS\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'SISTEMA DE MALHAS FISCAIS V2.0 - RESUMO EXECUTIVO' AS titulo;\\r\\n\\r\\n-- Contagem de Registros nas Tabelas Principais\\r\\nSELECT 'CONTAGEM DE REGISTROS' AS secao;\\r\\nSELECT \\r\\n    'mlh_empresas_base' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_unicas,\\r\\n    SUM(flag_atualmente_em_malha) AS empresas_em_malha_ativa\\r\\nFROM niat.mlh_empresas_base\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_inconsistencias_detalhadas' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cnpj) AS empresas_unicas,\\r\\n    COUNT(CASE WHEN canal_resolucao = 'ATIVA' THEN 1 END) AS inconsistencias_ativas\\r\\nFROM niat.mlh_inconsistencias_detalhadas\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_catalogo_tipos_inconsistencia' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS tipos_unicos,\\r\\n    SUM(CASE WHEN flag_tipo_ativo = '1' THEN 1 ELSE 0 END) AS tipos_ativos\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_performance_contadores' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT nu_cpf_cnpj_contador) AS contadores_unicos,\\r\\n    NULL AS terceira_metrica\\r\\nFROM niat.mlh_performance_contadores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_performance_dafs' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT id_equipe) AS equipes_unicas,\\r\\n    NULL AS terceira_metrica\\r\\nFROM niat.mlh_performance_dafs\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'mlh_benchmark_tipo_inconsistencia' AS tabela,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT cd_inconsistencia) AS tipos_unicos,\\r\\n    NULL AS terceira_metrica\\r\\nFROM niat.mlh_benchmark_tipo_inconsistencia;\\r\\n\\r\\n-- Top 10 Contadores por Autonomia\\r\\nSELECT 'TOP 10 CONTADORES POR TAXA DE AUTONOMIA' AS analise;\\r\\nSELECT \\r\\n    ranking_autonomia,\\r\\n    nm_contador,\\r\\n    nu_crc_contador,\\r\\n    qtd_empresas_com_incons,\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    classificacao_geral\\r\\nFROM niat.mlh_ranking_contadores_autonomia\\r\\nWHERE ranking_autonomia <= 10\\r\\nORDER BY ranking_autonomia;\\r\\n\\r\\n-- Top 10 Tipos de Inconsist\\u00eancia por Efetividade\\r\\nSELECT 'TOP 10 TIPOS DE INCONSIST\\u00caNCIA POR EFETIVIDADE' AS analise;\\r\\nSELECT \\r\\n    ranking_efetividade,\\r\\n    cd_inconsistencia,\\r\\n    nm_inconsistencia,\\r\\n    qtd_ocorrencias_total,\\r\\n    taxa_autonomia_esperada_pct,\\r\\n    taxa_autuacao_esperada_pct,\\r\\n    score_efetividade_tipo,\\r\\n    classificacao_efetividade\\r\\nFROM niat.mlh_ranking_tipos_efetividade\\r\\nWHERE ranking_efetividade <= 10\\r\\nORDER BY ranking_efetividade;\\r\\n\\r\\n-- Performance das DAFs\\r\\nSELECT 'TOP 10 DAFs POR PERFORMANCE' AS analise;\\r\\nSELECT \\r\\n    ranking_geral,\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    score_performance_daf,\\r\\n    classificacao_performance\\r\\nFROM niat.mlh_ranking_dafs\\r\\nWHERE ranking_geral <= 10\\r\\nORDER BY ranking_geral;\\r\\n\\r\\n-- Tipos que Necessitam Revis\\u00e3o\\r\\nSELECT 'TIPOS DE INCONSIST\\u00caNCIA QUE NECESSITAM REVIS\\u00c3O' AS analise;\\r\\nSELECT \\r\\n    cd_inconsistencia,\\r\\n    nm_inconsistencia,\\r\\n    natureza_inconsistencia,\\r\\n    qtd_ocorrencias_total,\\r\\n    taxa_exclusao_esperada_pct,\\r\\n    taxa_autuacao_esperada_pct,\\r\\n    legitimidade_exclusao,\\r\\n    classificacao_efetividade\\r\\nFROM niat.mlh_ranking_tipos_efetividade\\r\\nWHERE flag_necessita_revisao = 1\\r\\nORDER BY qtd_ocorrencias_total DESC;\\r\\n\\r\\n-- Equipes com Exclus\\u00f5es Suspeitas\\r\\nSELECT 'EQUIPES COM PADR\\u00c3O SUSPEITO DE EXCLUS\\u00c3O' AS analise;\\r\\nSELECT \\r\\n    id_equipe_auditor,\\r\\n    qtd_total_inconsistencias,\\r\\n    qtd_total_excluidas,\\r\\n    taxa_exclusao_geral_pct,\\r\\n    qtd_exclusoes_suspeitas,\\r\\n    taxa_exclusao_suspeita_pct,\\r\\n    score_legitimidade,\\r\\n    classificacao_exclusoes\\r\\nFROM niat.mlh_analise_exclusoes_auditores\\r\\nWHERE classificacao_exclusoes IN ('ALTA_SUSPEITA', 'MEDIA_SUSPEITA')\\r\\nORDER BY taxa_exclusao_suspeita_pct DESC;\\r\\n\\r\\n-- Evolu\\u00e7\\u00e3o nos \\u00daltimos 12 Meses\\r\\nSELECT 'EVOLU\\u00c7\\u00c3O \\u00daLTIMOS 12 MESES' AS analise;\\r\\nSELECT \\r\\n    periodo,\\r\\n    qtd_empresas_periodo,\\r\\n    qtd_inconsistencias_identificadas,\\r\\n    taxa_autonomia_pct,\\r\\n    taxa_exclusao_pct,\\r\\n    taxa_autuacao_pct,\\r\\n    media_dias_malha\\r\\nFROM niat.mlh_evolucao_mensal\\r\\nWHERE periodo >= 202401\\r\\nORDER BY periodo;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 1681, \"column\": 17}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 4845e0f7532334b4:521b1d5a00000000 100% Complete (0 out of 0)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"4845e0f7532334b4:521b1d5a00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=4845e0f7532334b4:521b1d5a00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 4845e0f7532334b4:521b1d5a00000000 100% Complete (0 out of 0)\", \"progress\": 100, \"jobs\": [{\"name\": \"4845e0f7532334b4:521b1d5a00000000\", \"url\": \"/hue/jobbrowser#!id=4845e0f7532334b4:521b1d5a00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 17247, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 166, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- SISTEMA DE MONITORAMENTO E GESTÃO DE MALHAS FISCAIS - DAFs V2.0\r\n-- ============================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- ============================================================================\r\n-- PARTE 1: TABELAS FUNDAMENTAIS\r\n-- ============================================================================\r\n\r\n-- ----------------------------------------------------------------------------\r\n-- 1.1. CATÁLOGO DE TIPOS DE INCONSISTÊNCIAS\r\n-- ----------------------------------------------------------------------------\r\nCREATE TABLE niat.mlh_catalogo_tipos_inconsistencia STORED AS PARQUET AS\r\nSELECT\r\n    -- Identificação\r\n    t.cd_inconsistencia,\r\n    t.nm_inconsistencia,\r\n    t.cd_tipo_infracao,\r\n    \r\n    -- Status e Visibilidade\r\n    CAST(t.sn_ativa AS STRING) AS flag_tipo_ativo,\r\n    t.cd_visibilidade,\r\n    t.cd_forma_regularizacao,\r\n    \r\n    -- Valores de Corte\r\n    t.vl_individual_min AS valor_minimo_malha,\r\n    t.vl_mensal_min AS valor_mensal_minimo,\r\n    t.nu_per_ini AS periodo_inicio_vigencia,\r\n    \r\n    -- Impactos\r\n    t.sn_regularidade_ttd AS flag_impacta_regularidade,\r\n    t.sn_dashboard AS flag_aparece_dashboard,\r\n    CAST(t.sn_bloqueada AS STRING) AS flag_tipo_bloqueado,\r\n    t.de_bloqueada AS motivo_bloqueio,\r\n    \r\n    -- Classificação por Natureza da Inconsistência\r\n    CASE \r\n        WHEN t.nm_inconsistencia LIKE '%Omissão%' OR t.nm_inconsistencia LIKE '%não escriturada%' \r\n        THEN 'OMISSAO'\r\n        WHEN t.nm_inconsistencia LIKE '%Crédito indevido%' OR t.nm_inconsistencia LIKE '%Crédito Indevido%'\r\n        THEN 'CREDITO_INDEVIDO'\r\n        WHEN t.nm_inconsistencia LIKE '%menor que%' OR t.nm_inconsistencia LIKE '%Débito de ICMS declarado na EFD menor%'\r\n        THEN 'DIVERGENCIA_VALOR_MENOR'\r\n        WHEN t.nm_inconsistencia LIKE '%maior que%'\r\n        THEN 'DIVERGENCIA_VALOR_MAIOR'\r\n        WHEN t.nm",
    "last_modified": "2025-10-28T19:22:00.282",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a1edcfdb-36e1-4f4d-bc6d-d99e2481e8a0",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 163285,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "MLH: 1 Dropar as Tbls",
    "description": "",
    "uuid": "9dff3191-bcdf-654e-aeae-d255119a6fa0",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 163285, \"uuid\": \"9dff3191-bcdf-654e-aeae-d255119a6fa0\", \"name\": \"MLH: 1 Dropar as Tbls\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"9dff3191-bcdf-654e-aeae-d255119a6fa0\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"2af31c70-ea87-1fba-5743-a5356f04e131\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 47, \"column\": 50}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- SCRIPT DE LIMPEZA - SISTEMA DE MALHAS FISCAIS V2.0\\r\\n-- Receita Estadual de Santa Catarina\\r\\n-- ============================================================================\\r\\n-- Execute este script ANTES do script principal para garantir ambiente limpo\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ============================================================================\\r\\n-- PASSO 1: REMOVER VIEWS (DEVEM SER REMOVIDAS ANTES DAS TABELAS)\\r\\n-- ============================================================================\\r\\n\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_dashboard_executivo_v2;\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_contadores_autonomia;\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_tipos_benchmark;\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_dafs_performance;\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_serie_temporal;\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_tipos_detalhado;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PASSO 2: REMOVER TABELAS DE AN\\u00c1LISE E RANKINGS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_ranking_contadores_autonomia;\\r\\nDROP TABLE IF EXISTS niat.mlh_ranking_tipos_efetividade;\\r\\nDROP TABLE IF EXISTS niat.mlh_ranking_dafs;\\r\\nDROP TABLE IF EXISTS niat.mlh_dataset_exclusoes_ml;\\r\\nDROP TABLE IF EXISTS niat.mlh_dataset_clusters_contadores;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PASSO 3: REMOVER TABELAS DE PERFORMANCE E AN\\u00c1LISE TEMPORAL\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_performance_contadores;\\r\\nDROP TABLE IF EXISTS niat.mlh_performance_dafs;\\r\\nDROP TABLE IF EXISTS niat.mlh_analise_exclusoes_auditores;\\r\\nDROP TABLE IF EXISTS niat.mlh_evolucao_mensal;\\r\\nDROP TABLE IF EXISTS niat.mlh_benchmark_tipo_inconsistencia;\\r\\n\\r\\n-- ============================================================================\\r\\n-- PASSO 4: REMOVER TABELAS FUNDAMENTAIS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_inconsistencias_detalhadas;\\r\\nDROP TABLE IF EXISTS niat.mlh_empresas_base;\\r\\nDROP TABLE IF EXISTS niat.mlh_catalogo_tipos_inconsistencia;\\r\\nDROP TABLE IF EXISTS niat.mlh_dataset_ml_exclusoes;\", \"statementsList\": [\"\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_contadores_autonomia;\", \"\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_tipos_benchmark;\", \"\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_dafs_performance;\", \"\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_serie_temporal;\", \"\\r\\nDROP VIEW IF EXISTS niat.vw_mlh_tipos_detalhado;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PASSO 2: REMOVER TABELAS DE AN\\u00c1LISE E RANKINGS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_ranking_contadores_autonomia;\", \"\\r\\nDROP TABLE IF EXISTS niat.mlh_ranking_tipos_efetividade;\", \"\\r\\nDROP TABLE IF EXISTS niat.mlh_ranking_dafs;\", \"\\r\\nDROP TABLE IF EXISTS niat.mlh_dataset_exclusoes_ml;\", \"\\r\\nDROP TABLE IF EXISTS niat.mlh_dataset_clusters_contadores;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PASSO 3: REMOVER TABELAS DE PERFORMANCE E AN\\u00c1LISE TEMPORAL\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_performance_contadores;\", \"\\r\\nDROP TABLE IF EXISTS niat.mlh_performance_dafs;\", \"\\r\\nDROP TABLE IF EXISTS niat.mlh_analise_exclusoes_auditores;\", \"\\r\\nDROP TABLE IF EXISTS niat.mlh_evolucao_mensal;\", \"\\r\\nDROP TABLE IF EXISTS niat.mlh_benchmark_tipo_inconsistencia;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PASSO 4: REMOVER TABELAS FUNDAMENTAIS\\r\\n-- ============================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS niat.mlh_inconsistencias_detalhadas;\", \"\\r\\nDROP TABLE IF EXISTS niat.mlh_empresas_base;\", \"\\r\\nDROP TABLE IF EXISTS niat.mlh_catalogo_tipos_inconsistencia;\", \"\\r\\nDROP TABLE IF EXISTS niat.mlh_dataset_ml_exclusoes;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"niat.mlh_dataset_ml_exclusoes\", \"result\": {\"id\": \"89e09c52-4352-f007-b4bb-f04d722e74b7\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"DvI84R5zTA+Q4r0jyJ9DMw==\", \"guid\": \"Zagn6goRRAIAAAAA7p8e/Q==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"7d4cc4def6e4229d:86eff4d03845ffb5\", \"session_id\": 21461, \"session_type\": \"impala\", \"statement_id\": 19, \"has_more_statements\": false, \"statements_count\": 20, \"previous_statement_hash\": \"cf800d9e2c7cf286b0cc988d9dd7b9e36a0f5d1ff7726c33f8fa1cb2\", \"start\": {\"row\": 46, \"column\": 0}, \"end\": {\"row\": 46, \"column\": 59}, \"statement\": \"DROP TABLE IF EXISTS niat.mlh_catalogo_tipos_inconsistencia\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 19, \"statement_range\": {\"start\": {\"row\": 46, \"column\": 0}, \"end\": {\"row\": 46, \"column\": 59}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-10-12T19:31:15.483Z\", \"endTime\": \"2025-10-12T19:31:15.652Z\", \"executionTime\": 169, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760297475137, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 136, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- SCRIPT DE LIMPEZA - SISTEMA DE MALHAS FISCAIS V2.0\r\n-- Receita Estadual de Santa Catarina\r\n-- ============================================================================\r\n-- Execute este script ANTES do script principal para garantir ambiente limpo\r\n-- ============================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- ============================================================================\r\n-- PASSO 1: REMOVER VIEWS (DEVEM SER REMOVIDAS ANTES DAS TABELAS)\r\n-- ============================================================================\r\n\r\nDROP VIEW IF EXISTS niat.vw_mlh_dashboard_executivo_v2;\r\nDROP VIEW IF EXISTS niat.vw_mlh_contadores_autonomia;\r\nDROP VIEW IF EXISTS niat.vw_mlh_tipos_benchmark;\r\nDROP VIEW IF EXISTS niat.vw_mlh_dafs_performance;\r\nDROP VIEW IF EXISTS niat.vw_mlh_serie_temporal;\r\nDROP VIEW IF EXISTS niat.vw_mlh_tipos_detalhado;\r\n\r\n-- ============================================================================\r\n-- PASSO 2: REMOVER TABELAS DE ANÁLISE E RANKINGS\r\n-- ============================================================================\r\n\r\nDROP TABLE IF EXISTS niat.mlh_ranking_contadores_autonomia;\r\nDROP TABLE IF EXISTS niat.mlh_ranking_tipos_efetividade;\r\nDROP TABLE IF EXISTS niat.mlh_ranking_dafs;\r\nDROP TABLE IF EXISTS niat.mlh_dataset_exclusoes_ml;\r\nDROP TABLE IF EXISTS niat.mlh_dataset_clusters_contadores;\r\n\r\n-- ============================================================================\r\n-- PASSO 3: REMOVER TABELAS DE PERFORMANCE E ANÁLISE TEMPORAL\r\n-- ============================================================================\r\n\r\nDROP TABLE IF EXISTS niat.mlh_performance_contadores;\r\nDROP TABLE IF EXISTS niat.mlh_performance_dafs;\r\nDROP TABLE IF EXISTS niat.mlh_analise_exclusoes_auditores;\r\nDROP TABLE IF EXISTS niat.mlh_evolucao_mensal;\r\nDROP TABLE IF EXISTS niat.mlh_benchmark_tipo_inconsistencia;\r\n\r\n-- =====",
    "last_modified": "2025-10-12T17:16:38.921",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a1edcfdb-36e1-4f4d-bc6d-d99e2481e8a0",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 163466,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "MLH: 3 Tipos de Inconsistências",
    "description": "",
    "uuid": "728904b0-87f0-2c86-a38e-c75795500554",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 163466, \"uuid\": \"728904b0-87f0-2c86-a38e-c75795500554\", \"name\": \"MLH: 3 Tipos de Inconsist\\u00eancias\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"499661b5-ad76-27f5-90a7-7c7026c13bd6\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 132, \"column\": 39}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"niat\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- AN\\u00c1LISE DE TIPOS DE INCONSIST\\u00caNCIA\\r\\n-- Quantidade de empresas e inconsist\\u00eancias por tipo\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- An\\u00e1lise completa por tipo de inconsist\\u00eancia\\r\\nSELECT\\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    cat.flag_tipo_ativo,\\r\\n    cat.flag_tem_valor_fiscal,\\r\\n    \\r\\n    -- Contagem de empresas afetadas\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    \\r\\n    -- Contagem de inconsist\\u00eancias\\r\\n    COUNT(id.nu_cnpj) AS qtd_total_inconsistencias,\\r\\n    \\r\\n    -- Inconsist\\u00eancias ativas (ainda n\\u00e3o resolvidas)\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_inconsistencias_ativas,\\r\\n    \\r\\n    -- Inconsist\\u00eancias resolvidas autonomamente\\r\\n    COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolvidas_autonomamente,\\r\\n    \\r\\n    -- Inconsist\\u00eancias que geraram autua\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_gerou_autuacao,\\r\\n    \\r\\n    -- Inconsist\\u00eancias exclu\\u00eddas por auditor\\r\\n    COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n    \\r\\n    -- Valor total (quando aplic\\u00e1vel)\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- Valor m\\u00e9dio por inconsist\\u00eancia\\r\\n    ROUND(AVG(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END), 2) AS valor_medio_inconsistencia,\\r\\n    \\r\\n    -- Taxas percentuais\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_resolucao_autonoma_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_exclusao_pct,\\r\\n    \\r\\n    -- Per\\u00edodo de atividade\\r\\n    MIN(id.nu_per_ref) AS periodo_primeira_ocorrencia,\\r\\n    MAX(id.nu_per_ref) AS periodo_ultima_ocorrencia,\\r\\n    \\r\\n    -- Status de atividade recente\\r\\n    CASE \\r\\n        WHEN MAX(id.nu_per_ref) >= 202409 THEN 'ATIVO_RECENTE'\\r\\n        WHEN MAX(id.nu_per_ref) >= 202407 THEN 'ATIVO'\\r\\n        WHEN MAX(id.nu_per_ref) >= 202401 THEN 'POUCO_ATIVO'\\r\\n        ELSE 'INATIVO'\\r\\n    END AS status_atividade\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nLEFT JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY \\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    cat.flag_tipo_ativo,\\r\\n    cat.flag_tem_valor_fiscal\\r\\n\\r\\nORDER BY \\r\\n    qtd_total_inconsistencias DESC,\\r\\n    qtd_empresas_afetadas DESC;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- RESUMO GERAL POR NATUREZA DE INCONSIST\\u00caNCIA\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'RESUMO POR NATUREZA DE INCONSIST\\u00caNCIA' AS titulo;\\r\\n\\r\\nSELECT\\r\\n    cat.natureza_inconsistencia,\\r\\n    COUNT(DISTINCT cat.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    COUNT(id.nu_cnpj) AS qtd_total_inconsistencias,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_total_milhoes,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autonomia_pct\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nLEFT JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY cat.natureza_inconsistencia\\r\\nORDER BY qtd_total_inconsistencias DESC;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- RESUMO GERAL POR GRAVIDADE PRESUMIDA\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'RESUMO POR GRAVIDADE PRESUMIDA' AS titulo;\\r\\n\\r\\nSELECT\\r\\n    cat.gravidade_presumida,\\r\\n    COUNT(DISTINCT cat.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    COUNT(id.nu_cnpj) AS qtd_total_inconsistencias,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_total_milhoes,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nLEFT JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY cat.gravidade_presumida\\r\\nORDER BY \\r\\n    CASE cat.gravidade_presumida\\r\\n        WHEN 'ALTA' THEN 1\\r\\n        WHEN 'MEDIA' THEN 2\\r\\n        WHEN 'BAIXA' THEN 3\\r\\n    END;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- TOP 20 TIPOS COM MAIS INCONSIST\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'TOP 20 TIPOS COM MAIS INCONSIST\\u00caNCIAS' AS titulo;\\r\\n\\r\\nSELECT\\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas,\\r\\n    COUNT(id.nu_cnpj) AS qtd_inconsistencias,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_milhoes,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autonomia_pct,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nINNER JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY \\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia\\r\\n\\r\\nORDER BY qtd_inconsistencias DESC;\", \"statementsList\": [\"-- ============================================================================\\r\\n-- AN\\u00c1LISE DE TIPOS DE INCONSIST\\u00caNCIA\\r\\n-- Quantidade de empresas e inconsist\\u00eancias por tipo\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\n-- An\\u00e1lise completa por tipo de inconsist\\u00eancia\\r\\nSELECT\\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    cat.flag_tipo_ativo,\\r\\n    cat.flag_tem_valor_fiscal,\\r\\n    \\r\\n    -- Contagem de empresas afetadas\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    \\r\\n    -- Contagem de inconsist\\u00eancias\\r\\n    COUNT(id.nu_cnpj) AS qtd_total_inconsistencias,\\r\\n    \\r\\n    -- Inconsist\\u00eancias ativas (ainda n\\u00e3o resolvidas)\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_inconsistencias_ativas,\\r\\n    \\r\\n    -- Inconsist\\u00eancias resolvidas autonomamente\\r\\n    COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolvidas_autonomamente,\\r\\n    \\r\\n    -- Inconsist\\u00eancias que geraram autua\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_gerou_autuacao,\\r\\n    \\r\\n    -- Inconsist\\u00eancias exclu\\u00eddas por auditor\\r\\n    COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n    \\r\\n    -- Valor total (quando aplic\\u00e1vel)\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- Valor m\\u00e9dio por inconsist\\u00eancia\\r\\n    ROUND(AVG(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END), 2) AS valor_medio_inconsistencia,\\r\\n    \\r\\n    -- Taxas percentuais\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_resolucao_autonoma_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_exclusao_pct,\\r\\n    \\r\\n    -- Per\\u00edodo de atividade\\r\\n    MIN(id.nu_per_ref) AS periodo_primeira_ocorrencia,\\r\\n    MAX(id.nu_per_ref) AS periodo_ultima_ocorrencia,\\r\\n    \\r\\n    -- Status de atividade recente\\r\\n    CASE \\r\\n        WHEN MAX(id.nu_per_ref) >= 202409 THEN 'ATIVO_RECENTE'\\r\\n        WHEN MAX(id.nu_per_ref) >= 202407 THEN 'ATIVO'\\r\\n        WHEN MAX(id.nu_per_ref) >= 202401 THEN 'POUCO_ATIVO'\\r\\n        ELSE 'INATIVO'\\r\\n    END AS status_atividade\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nLEFT JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY \\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    cat.flag_tipo_ativo,\\r\\n    cat.flag_tem_valor_fiscal\\r\\n\\r\\nORDER BY \\r\\n    qtd_total_inconsistencias DESC,\\r\\n    qtd_empresas_afetadas DESC;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- RESUMO GERAL POR NATUREZA DE INCONSIST\\u00caNCIA\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'RESUMO POR NATUREZA DE INCONSIST\\u00caNCIA' AS titulo;\", \"\\r\\n\\r\\nSELECT\\r\\n    cat.natureza_inconsistencia,\\r\\n    COUNT(DISTINCT cat.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    COUNT(id.nu_cnpj) AS qtd_total_inconsistencias,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_total_milhoes,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autonomia_pct\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nLEFT JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY cat.natureza_inconsistencia\\r\\nORDER BY qtd_total_inconsistencias DESC;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- RESUMO GERAL POR GRAVIDADE PRESUMIDA\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'RESUMO POR GRAVIDADE PRESUMIDA' AS titulo;\", \"\\r\\n\\r\\nSELECT\\r\\n    cat.gravidade_presumida,\\r\\n    COUNT(DISTINCT cat.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    COUNT(id.nu_cnpj) AS qtd_total_inconsistencias,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_total_milhoes,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nLEFT JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY cat.gravidade_presumida\\r\\nORDER BY \\r\\n    CASE cat.gravidade_presumida\\r\\n        WHEN 'ALTA' THEN 1\\r\\n        WHEN 'MEDIA' THEN 2\\r\\n        WHEN 'BAIXA' THEN 3\\r\\n    END;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- TOP 20 TIPOS COM MAIS INCONSIST\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'TOP 20 TIPOS COM MAIS INCONSIST\\u00caNCIAS' AS titulo;\", \"\\r\\n\\r\\nSELECT\\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas,\\r\\n    COUNT(id.nu_cnpj) AS qtd_inconsistencias,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_milhoes,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autonomia_pct,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nINNER JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY \\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia\\r\\n\\r\\nORDER BY qtd_inconsistencias DESC;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\nSELECT\\r\\n    cat.gravidade_presumida,\\r\\n    COUNT(DISTINCT cat.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    COUNT(id.nu_cnpj) AS qtd_total_inconsistencias,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_total_milhoes,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nLEFT JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY cat.gravidade_presumida\\r\\nORDER BY \\r\\n    CASE cat.gravidade_presumida\\r\\n        WHEN 'ALTA' THEN 1\\r\\n        WHEN 'MEDIA' THEN 2\\r\\n        WHEN 'BAIXA' THEN 3\\r\\n    END;\", \"result\": {\"id\": \"a5cd2c8b-986e-3063-1b20-b40ccbc3cd50\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"LX7DbBNISaqUV+qLjiUohg==\", \"guid\": \"T4BON5cFTC0AAAAACxA4VA==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"1640d063bfcd5533:a9abe4e009ee6e90\", \"session_id\": 21466, \"session_type\": \"impala\", \"statement_id\": 7, \"has_more_statements\": false, \"statements_count\": 8, \"previous_statement_hash\": \"94f7b6a384e74aedae0deba2951ef121effb30d3c024fbfeaed891bf\", \"start\": {\"row\": 138, \"column\": 0}, \"end\": {\"row\": 160, \"column\": 33}, \"statement\": \"SELECT\\n    cat.cd_inconsistencia,\\n    cat.nm_inconsistencia,\\n    cat.natureza_inconsistencia,\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas,\\n    COUNT(id.nu_cnpj) AS qtd_inconsistencias,\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_milhoes,\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autonomia_pct,\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct\\n\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\nINNER JOIN niat.mlh_inconsistencias_detalhadas id \\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\n\\nGROUP BY \\n    cat.cd_inconsistencia,\\n    cat.nm_inconsistencia,\\n    cat.natureza_inconsistencia\\n\\nORDER BY qtd_inconsistencias DESC\"}, \"meta\": [], \"rows\": 13, \"hasMore\": false, \"statement_id\": 7, \"statement_range\": {\"start\": {\"row\": 138, \"column\": 0}, \"end\": {\"row\": 160, \"column\": 33}}, \"statements_count\": 8, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 9, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"cd_inconsistencia\", \"type\": \"smallint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"nm_inconsistencia\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 2}, {\"name\": \"natureza_inconsistencia\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 3}, {\"name\": \"qtd_empresas\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 4}, {\"name\": \"qtd_inconsistencias\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 5}, {\"name\": \"qtd_ativas\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 6}, {\"name\": \"valor_milhoes\", \"type\": \"decimal\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 7}, {\"name\": \"taxa_autonomia_pct\", \"type\": \"decimal\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 8}, {\"name\": \"taxa_autuacao_pct\", \"type\": \"decimal\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 9}], \"fetchedOnce\": false, \"startTime\": \"2025-10-12T22:51:26.326Z\", \"endTime\": \"2025-10-12T22:51:28.837Z\", \"executionTime\": 2511, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 4, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 8892, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"nm_inconsistencia\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"qtd_empresas\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"titulo\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 12456, \"getLogsTimeout\": 12514, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760309486109, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- ============================================================================\\r\\n-- AN\\u00c1LISE DE TIPOS DE INCONSIST\\u00caNCIA\\r\\n-- Quantidade de empresas e inconsist\\u00eancias por tipo\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- An\\u00e1lise completa por tipo de inconsist\\u00eancia\\r\\nSELECT\\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    cat.flag_tipo_ativo,\\r\\n    cat.flag_tem_valor_fiscal,\\r\\n    \\r\\n    -- Contagem de empresas afetadas\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    \\r\\n    -- Contagem de inconsist\\u00eancias\\r\\n    COUNT(id.nu_cnpj) AS qtd_total_inconsistencias,\\r\\n    \\r\\n    -- Inconsist\\u00eancias ativas (ainda n\\u00e3o resolvidas)\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_inconsistencias_ativas,\\r\\n    \\r\\n    -- Inconsist\\u00eancias resolvidas autonomamente\\r\\n    COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolvidas_autonomamente,\\r\\n    \\r\\n    -- Inconsist\\u00eancias que geraram autua\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_gerou_autuacao,\\r\\n    \\r\\n    -- Inconsist\\u00eancias exclu\\u00eddas por auditor\\r\\n    COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n    \\r\\n    -- Valor total (quando aplic\\u00e1vel)\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- Valor m\\u00e9dio por inconsist\\u00eancia\\r\\n    ROUND(AVG(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END), 2) AS valor_medio_inconsistencia,\\r\\n    \\r\\n    -- Taxas percentuais\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_resolucao_autonoma_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct,\\r\\n    \\r\\n    ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_exclusao_pct,\\r\\n    \\r\\n    -- Per\\u00edodo de atividade\\r\\n    MIN(id.nu_per_ref) AS periodo_primeira_ocorrencia,\\r\\n    MAX(id.nu_per_ref) AS periodo_ultima_ocorrencia,\\r\\n    \\r\\n    -- Status de atividade recente\\r\\n    CASE \\r\\n        WHEN MAX(id.nu_per_ref) >= 202409 THEN 'ATIVO_RECENTE'\\r\\n        WHEN MAX(id.nu_per_ref) >= 202407 THEN 'ATIVO'\\r\\n        WHEN MAX(id.nu_per_ref) >= 202401 THEN 'POUCO_ATIVO'\\r\\n        ELSE 'INATIVO'\\r\\n    END AS status_atividade\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nLEFT JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY \\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    cat.gravidade_presumida,\\r\\n    cat.flag_tipo_ativo,\\r\\n    cat.flag_tem_valor_fiscal\\r\\n\\r\\nORDER BY \\r\\n    qtd_total_inconsistencias DESC,\\r\\n    qtd_empresas_afetadas DESC;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- RESUMO GERAL POR NATUREZA DE INCONSIST\\u00caNCIA\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'RESUMO POR NATUREZA DE INCONSIST\\u00caNCIA' AS titulo;\\r\\n\\r\\nSELECT\\r\\n    cat.natureza_inconsistencia,\\r\\n    COUNT(DISTINCT cat.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    COUNT(id.nu_cnpj) AS qtd_total_inconsistencias,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_total_milhoes,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autonomia_pct\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nLEFT JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY cat.natureza_inconsistencia\\r\\nORDER BY qtd_total_inconsistencias DESC;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- RESUMO GERAL POR GRAVIDADE PRESUMIDA\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'RESUMO POR GRAVIDADE PRESUMIDA' AS titulo;\\r\\n\\r\\nSELECT\\r\\n    cat.gravidade_presumida,\\r\\n    COUNT(DISTINCT cat.cd_inconsistencia) AS qtd_tipos_inconsistencia,\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\\r\\n    COUNT(id.nu_cnpj) AS qtd_total_inconsistencias,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_total_milhoes,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nLEFT JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY cat.gravidade_presumida\\r\\nORDER BY \\r\\n    CASE cat.gravidade_presumida\\r\\n        WHEN 'ALTA' THEN 1\\r\\n        WHEN 'MEDIA' THEN 2\\r\\n        WHEN 'BAIXA' THEN 3\\r\\n    END;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- TOP 20 TIPOS COM MAIS INCONSIST\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'TOP 20 TIPOS COM MAIS INCONSIST\\u00caNCIAS' AS titulo;\\r\\n\\r\\nSELECT\\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia,\\r\\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas,\\r\\n    COUNT(id.nu_cnpj) AS qtd_inconsistencias,\\r\\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_milhoes,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autonomia_pct,\\r\\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct\\r\\n\\r\\nFROM niat.mlh_catalogo_tipos_inconsistencia cat\\r\\nINNER JOIN niat.mlh_inconsistencias_detalhadas id \\r\\n    ON cat.cd_inconsistencia = id.cd_inconsistencia\\r\\n\\r\\nGROUP BY \\r\\n    cat.cd_inconsistencia,\\r\\n    cat.nm_inconsistencia,\\r\\n    cat.natureza_inconsistencia\\r\\n\\r\\nORDER BY qtd_inconsistencias DESC;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 160, \"column\": 34}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 2d4c0597374e804f:5438100b00000000 100% Complete (36 out of 36)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"2d4c0597374e804f:5438100b00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=2d4c0597374e804f:5438100b00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 2d4c0597374e804f:5438100b00000000 100% Complete (36 out of 36)\", \"progress\": 100, \"jobs\": [{\"name\": \"2d4c0597374e804f:5438100b00000000\", \"url\": \"/hue/jobbrowser#!id=2d4c0597374e804f:5438100b00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 15715, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 136, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": null, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- ANÁLISE DE TIPOS DE INCONSISTÊNCIA\r\n-- Quantidade de empresas e inconsistências por tipo\r\n-- ============================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- Análise completa por tipo de inconsistência\r\nSELECT\r\n    cat.cd_inconsistencia,\r\n    cat.nm_inconsistencia,\r\n    cat.natureza_inconsistencia,\r\n    cat.gravidade_presumida,\r\n    cat.flag_tipo_ativo,\r\n    cat.flag_tem_valor_fiscal,\r\n    \r\n    -- Contagem de empresas afetadas\r\n    COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_afetadas,\r\n    \r\n    -- Contagem de inconsistências\r\n    COUNT(id.nu_cnpj) AS qtd_total_inconsistencias,\r\n    \r\n    -- Inconsistências ativas (ainda não resolvidas)\r\n    COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_inconsistencias_ativas,\r\n    \r\n    -- Inconsistências resolvidas autonomamente\r\n    COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolvidas_autonomamente,\r\n    \r\n    -- Inconsistências que geraram autuação\r\n    COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_gerou_autuacao,\r\n    \r\n    -- Inconsistências excluídas por auditor\r\n    COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\r\n    \r\n    -- Valor total (quando aplicável)\r\n    ROUND(SUM(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) / 1000000, 2) AS valor_total_milhoes,\r\n    \r\n    -- Valor médio por inconsistência\r\n    ROUND(AVG(CASE WHEN cat.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia END), 2) AS valor_medio_inconsistencia,\r\n    \r\n    -- Taxas percentuais\r\n    ROUND(COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) * 100.0 / \r\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_resolucao_autonoma_pct,\r\n    \r\n    ROUND(COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) * 100.0 / \r\n          NULLIF(COUNT(id.nu_cnpj), 0), 2) AS taxa_autuacao_pct,\r\n    \r\n    ROUND(COUNT",
    "last_modified": "2025-10-12T19:56:50.379",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a1edcfdb-36e1-4f4d-bc6d-d99e2481e8a0",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 163480,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "MLH: 5 Análise DAFs",
    "description": "",
    "uuid": "9dff3950-5eb3-edbe-6693-cc87a95d2d8c",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 163480, \"uuid\": \"dbe263d2-66c1-43a2-80fc-8b320a3cc8a4\", \"name\": \"MLH: 5 An\\u00e1lise DAFs\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"9dff3950-5eb3-edbe-6693-cc87a95d2d8c\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"0272509f-d425-9a57-3e0e-6a9b2ee54080\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 269, \"column\": 14}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- AN\\u00c1LISE DETALHADA DE DAFs COM ALTA EXCLUS\\u00c3O\\r\\n-- Detalhamento de scores para ajustar threshold de classifica\\u00e7\\u00e3o\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: AN\\u00c1LISE COMPLETA COM TODOS OS SCORES E PERCENTUAIS\\r\\n-- ============================================================================\\r\\n\\r\\nWITH dafs_detalhado AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_acompanhadas,\\r\\n        COUNT(DISTINCT eb.nu_cpf_cnpj_contador) AS qtd_contadores_acompanhados,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\\r\\n        \\r\\n        -- Por Canal de Resolu\\u00e7\\u00e3o\\r\\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\\r\\n        \\r\\n        -- Tempo\\r\\n        AVG(id.dias_na_malha) AS media_dias_malha\\r\\n        \\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    LEFT JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n)\\r\\nSELECT\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    qtd_total_inconsistencias,\\r\\n    ROUND(valor_total_inconsistencias / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- DETALHAMENTO POR CANAL DE RESOLU\\u00c7\\u00c3O (QUANTIDADE)\\r\\n    -- ========================================================================\\r\\n    qtd_resolucao_autonoma,\\r\\n    qtd_resolvidas_fiscalizacao,\\r\\n    qtd_excluidas_auditor,\\r\\n    qtd_ativas,\\r\\n    qtd_autuacoes,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- PERCENTUAIS POR CANAL (SCORES DETALHADOS)\\r\\n    -- ========================================================================\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_resolucao_autonoma,\\r\\n    ROUND(qtd_resolvidas_fiscalizacao * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_resolvidas_fiscalizacao,\\r\\n    ROUND(qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_excluidas_auditor,\\r\\n    ROUND(qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_ativas,\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_autuacoes,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- SCORES COMBINADOS PARA AN\\u00c1LISE\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Score de Efetividade (Autonomia + Autua\\u00e7\\u00f5es)\\r\\n    ROUND(\\r\\n        (qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0)) +\\r\\n        (qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0))\\r\\n    , 2) AS score_efetividade,\\r\\n    \\r\\n    -- Score de Problema (Exclus\\u00f5es + Pend\\u00eancias)\\r\\n    ROUND(\\r\\n        (qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0)) +\\r\\n        (qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0))\\r\\n    , 2) AS score_problema,\\r\\n    \\r\\n    -- Raz\\u00e3o Exclus\\u00e3o/Autua\\u00e7\\u00e3o (quanto maior, mais suspeito)\\r\\n    ROUND(\\r\\n        qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0)\\r\\n    , 2) AS razao_exclusao_autuacao,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- CLASSIFICA\\u00c7\\u00c3O ATUAL E PROPOSTA\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Atual (threshold 0.5 = 50%)\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.6 \\r\\n             AND qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.3 \\r\\n        THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'BOA'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.5 \\r\\n        THEN 'ALTA_EXCLUSAO'\\r\\n        ELSE 'REGULAR'\\r\\n    END AS classificacao_atual_threshold_50,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Proposta (threshold 0.3 = 30%)\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.6 \\r\\n             AND qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.3 \\r\\n        THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'BOA'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.3 \\r\\n        THEN 'ALTA_EXCLUSAO'\\r\\n        ELSE 'REGULAR'\\r\\n    END AS classificacao_proposta_threshold_30,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Proposta (threshold 0.4 = 40%)\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.6 \\r\\n             AND qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.3 \\r\\n        THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'BOA'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'ALTA_EXCLUSAO'\\r\\n        ELSE 'REGULAR'\\r\\n    END AS classificacao_proposta_threshold_40,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- INDICADORES DE ALERTA\\r\\n    -- ========================================================================\\r\\n    \\r\\n    CASE \\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0) > 5 THEN 'ALERTA_CRITICO'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0) > 3 THEN 'ALERTA_ALTO'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0) > 2 THEN 'ALERTA_MEDIO'\\r\\n        ELSE 'OK'\\r\\n    END AS alerta_razao_exclusao_autuacao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 60 THEN 'EXCLUSAO_MUITO_ALTA'\\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 50 THEN 'EXCLUSAO_ALTA'\\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 40 THEN 'EXCLUSAO_MODERADA_ALTA'\\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 30 THEN 'EXCLUSAO_MODERADA'\\r\\n        ELSE 'EXCLUSAO_NORMAL'\\r\\n    END AS nivel_exclusao,\\r\\n    \\r\\n    -- Tempo m\\u00e9dio\\r\\n    ROUND(media_dias_malha, 2) AS media_dias_malha\\r\\n\\r\\nFROM dafs_detalhado\\r\\n\\r\\n-- Ordenar pelos mais problem\\u00e1ticos (maior % de exclus\\u00e3o)\\r\\nORDER BY pct_excluidas_auditor DESC, qtd_excluidas_auditor DESC;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: DISTRIBUI\\u00c7\\u00c3O DOS PERCENTUAIS DE EXCLUS\\u00c3O\\r\\n-- Estat\\u00edsticas descritivas para definir threshold ideal\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'DISTRIBUI\\u00c7\\u00c3O DE PERCENTUAIS DE EXCLUS\\u00c3O' AS analise;\\r\\n\\r\\nWITH dafs_pct AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / NULLIF(COUNT(*), 0), 2) AS pct_exclusao\\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n    HAVING COUNT(*) >= 100\\r\\n),\\r\\npercentis AS (\\r\\n    SELECT\\r\\n        pct_exclusao,\\r\\n        ROW_NUMBER() OVER (ORDER BY pct_exclusao) AS row_num,\\r\\n        COUNT(*) OVER () AS total_rows\\r\\n    FROM dafs_pct\\r\\n)\\r\\nSELECT\\r\\n    (SELECT COUNT(*) FROM dafs_pct) AS total_dafs,\\r\\n    \\r\\n    -- Estat\\u00edsticas descritivas do % de exclus\\u00e3o\\r\\n    ROUND(MIN(pct_exclusao), 2) AS pct_exclusao_minimo,\\r\\n    ROUND(MAX(pct_exclusao), 2) AS pct_exclusao_maximo,\\r\\n    ROUND(AVG(pct_exclusao), 2) AS pct_exclusao_media,\\r\\n    ROUND(STDDEV(pct_exclusao), 2) AS pct_exclusao_desvio_padrao,\\r\\n    \\r\\n    -- Percentis calculados manualmente\\r\\n    ROUND((SELECT pct_exclusao FROM percentis WHERE row_num = CAST(total_rows * 0.25 AS INT) LIMIT 1), 2) AS pct_exclusao_p25,\\r\\n    ROUND((SELECT pct_exclusao FROM percentis WHERE row_num = CAST(total_rows * 0.50 AS INT) LIMIT 1), 2) AS pct_exclusao_mediana,\\r\\n    ROUND((SELECT pct_exclusao FROM percentis WHERE row_num = CAST(total_rows * 0.75 AS INT) LIMIT 1), 2) AS pct_exclusao_p75,\\r\\n    ROUND((SELECT pct_exclusao FROM percentis WHERE row_num = CAST(total_rows * 0.90 AS INT) LIMIT 1), 2) AS pct_exclusao_p90,\\r\\n    \\r\\n    -- Contagem por faixas\\r\\n    COUNT(CASE WHEN pct_exclusao > 50 THEN 1 END) AS dafs_acima_50pct,\\r\\n    COUNT(CASE WHEN pct_exclusao > 40 THEN 1 END) AS dafs_acima_40pct,\\r\\n    COUNT(CASE WHEN pct_exclusao > 30 THEN 1 END) AS dafs_acima_30pct,\\r\\n    COUNT(CASE WHEN pct_exclusao > 20 THEN 1 END) AS dafs_acima_20pct\\r\\n\\r\\nFROM dafs_pct;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: COMPARA\\u00c7\\u00c3O DE CLASSIFICA\\u00c7\\u00d5ES POR DIFERENTES THRESHOLDS\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'COMPARA\\u00c7\\u00c3O DE THRESHOLDS' AS analise;\\r\\n\\r\\nWITH dafs_pct AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) AS pct_exclusao\\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n    HAVING COUNT(*) >= 100\\r\\n)\\r\\nSELECT\\r\\n    'Threshold 50%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.5 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.5 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 40%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.4 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.4 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 30%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.3 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.3 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 25%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.25 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.25 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 4: RECOMENDA\\u00c7\\u00c3O DE THRESHOLD IDEAL\\r\\n-- Baseado em an\\u00e1lise estat\\u00edstica (m\\u00e9dia + 1 desvio padr\\u00e3o)\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'RECOMENDA\\u00c7\\u00c3O DE THRESHOLD' AS analise;\\r\\n\\r\\nWITH dafs_pct AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / NULLIF(COUNT(*), 0), 2) AS pct_exclusao\\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n    HAVING COUNT(*) >= 100\\r\\n)\\r\\nSELECT\\r\\n    ROUND(AVG(pct_exclusao), 2) AS media_pct_exclusao,\\r\\n    ROUND(STDDEV(pct_exclusao), 2) AS desvio_padrao,\\r\\n    ROUND(AVG(pct_exclusao) + STDDEV(pct_exclusao), 2) AS threshold_recomendado_1_desvio,\\r\\n    ROUND(AVG(pct_exclusao) + 0.5 * STDDEV(pct_exclusao), 2) AS threshold_recomendado_meio_desvio,\\r\\n    'Use o threshold_recomendado_1_desvio para capturar outliers (10-15% das DAFs)' AS observacao\\r\\n\\r\\nFROM dafs_pct;\", \"statementsList\": [\"-- ============================================================================\\r\\n-- AN\\u00c1LISE DETALHADA DE DAFs COM ALTA EXCLUS\\u00c3O\\r\\n-- Detalhamento de scores para ajustar threshold de classifica\\u00e7\\u00e3o\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: AN\\u00c1LISE COMPLETA COM TODOS OS SCORES E PERCENTUAIS\\r\\n-- ============================================================================\\r\\n\\r\\nWITH dafs_detalhado AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_acompanhadas,\\r\\n        COUNT(DISTINCT eb.nu_cpf_cnpj_contador) AS qtd_contadores_acompanhados,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\\r\\n        \\r\\n        -- Por Canal de Resolu\\u00e7\\u00e3o\\r\\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\\r\\n        \\r\\n        -- Tempo\\r\\n        AVG(id.dias_na_malha) AS media_dias_malha\\r\\n        \\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    LEFT JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n)\\r\\nSELECT\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    qtd_total_inconsistencias,\\r\\n    ROUND(valor_total_inconsistencias / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- DETALHAMENTO POR CANAL DE RESOLU\\u00c7\\u00c3O (QUANTIDADE)\\r\\n    -- ========================================================================\\r\\n    qtd_resolucao_autonoma,\\r\\n    qtd_resolvidas_fiscalizacao,\\r\\n    qtd_excluidas_auditor,\\r\\n    qtd_ativas,\\r\\n    qtd_autuacoes,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- PERCENTUAIS POR CANAL (SCORES DETALHADOS)\\r\\n    -- ========================================================================\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_resolucao_autonoma,\\r\\n    ROUND(qtd_resolvidas_fiscalizacao * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_resolvidas_fiscalizacao,\\r\\n    ROUND(qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_excluidas_auditor,\\r\\n    ROUND(qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_ativas,\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_autuacoes,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- SCORES COMBINADOS PARA AN\\u00c1LISE\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Score de Efetividade (Autonomia + Autua\\u00e7\\u00f5es)\\r\\n    ROUND(\\r\\n        (qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0)) +\\r\\n        (qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0))\\r\\n    , 2) AS score_efetividade,\\r\\n    \\r\\n    -- Score de Problema (Exclus\\u00f5es + Pend\\u00eancias)\\r\\n    ROUND(\\r\\n        (qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0)) +\\r\\n        (qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0))\\r\\n    , 2) AS score_problema,\\r\\n    \\r\\n    -- Raz\\u00e3o Exclus\\u00e3o/Autua\\u00e7\\u00e3o (quanto maior, mais suspeito)\\r\\n    ROUND(\\r\\n        qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0)\\r\\n    , 2) AS razao_exclusao_autuacao,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- CLASSIFICA\\u00c7\\u00c3O ATUAL E PROPOSTA\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Atual (threshold 0.5 = 50%)\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.6 \\r\\n             AND qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.3 \\r\\n        THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'BOA'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.5 \\r\\n        THEN 'ALTA_EXCLUSAO'\\r\\n        ELSE 'REGULAR'\\r\\n    END AS classificacao_atual_threshold_50,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Proposta (threshold 0.3 = 30%)\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.6 \\r\\n             AND qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.3 \\r\\n        THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'BOA'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.3 \\r\\n        THEN 'ALTA_EXCLUSAO'\\r\\n        ELSE 'REGULAR'\\r\\n    END AS classificacao_proposta_threshold_30,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Proposta (threshold 0.4 = 40%)\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.6 \\r\\n             AND qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.3 \\r\\n        THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'BOA'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'ALTA_EXCLUSAO'\\r\\n        ELSE 'REGULAR'\\r\\n    END AS classificacao_proposta_threshold_40,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- INDICADORES DE ALERTA\\r\\n    -- ========================================================================\\r\\n    \\r\\n    CASE \\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0) > 5 THEN 'ALERTA_CRITICO'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0) > 3 THEN 'ALERTA_ALTO'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0) > 2 THEN 'ALERTA_MEDIO'\\r\\n        ELSE 'OK'\\r\\n    END AS alerta_razao_exclusao_autuacao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 60 THEN 'EXCLUSAO_MUITO_ALTA'\\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 50 THEN 'EXCLUSAO_ALTA'\\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 40 THEN 'EXCLUSAO_MODERADA_ALTA'\\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 30 THEN 'EXCLUSAO_MODERADA'\\r\\n        ELSE 'EXCLUSAO_NORMAL'\\r\\n    END AS nivel_exclusao,\\r\\n    \\r\\n    -- Tempo m\\u00e9dio\\r\\n    ROUND(media_dias_malha, 2) AS media_dias_malha\\r\\n\\r\\nFROM dafs_detalhado\\r\\n\\r\\n-- Ordenar pelos mais problem\\u00e1ticos (maior % de exclus\\u00e3o)\\r\\nORDER BY pct_excluidas_auditor DESC, qtd_excluidas_auditor DESC;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: DISTRIBUI\\u00c7\\u00c3O DOS PERCENTUAIS DE EXCLUS\\u00c3O\\r\\n-- Estat\\u00edsticas descritivas para definir threshold ideal\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'DISTRIBUI\\u00c7\\u00c3O DE PERCENTUAIS DE EXCLUS\\u00c3O' AS analise;\", \"\\r\\n\\r\\nWITH dafs_pct AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / NULLIF(COUNT(*), 0), 2) AS pct_exclusao\\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n    HAVING COUNT(*) >= 100\\r\\n),\\r\\npercentis AS (\\r\\n    SELECT\\r\\n        pct_exclusao,\\r\\n        ROW_NUMBER() OVER (ORDER BY pct_exclusao) AS row_num,\\r\\n        COUNT(*) OVER () AS total_rows\\r\\n    FROM dafs_pct\\r\\n)\\r\\nSELECT\\r\\n    (SELECT COUNT(*) FROM dafs_pct) AS total_dafs,\\r\\n    \\r\\n    -- Estat\\u00edsticas descritivas do % de exclus\\u00e3o\\r\\n    ROUND(MIN(pct_exclusao), 2) AS pct_exclusao_minimo,\\r\\n    ROUND(MAX(pct_exclusao), 2) AS pct_exclusao_maximo,\\r\\n    ROUND(AVG(pct_exclusao), 2) AS pct_exclusao_media,\\r\\n    ROUND(STDDEV(pct_exclusao), 2) AS pct_exclusao_desvio_padrao,\\r\\n    \\r\\n    -- Percentis calculados manualmente\\r\\n    ROUND((SELECT pct_exclusao FROM percentis WHERE row_num = CAST(total_rows * 0.25 AS INT) LIMIT 1), 2) AS pct_exclusao_p25,\\r\\n    ROUND((SELECT pct_exclusao FROM percentis WHERE row_num = CAST(total_rows * 0.50 AS INT) LIMIT 1), 2) AS pct_exclusao_mediana,\\r\\n    ROUND((SELECT pct_exclusao FROM percentis WHERE row_num = CAST(total_rows * 0.75 AS INT) LIMIT 1), 2) AS pct_exclusao_p75,\\r\\n    ROUND((SELECT pct_exclusao FROM percentis WHERE row_num = CAST(total_rows * 0.90 AS INT) LIMIT 1), 2) AS pct_exclusao_p90,\\r\\n    \\r\\n    -- Contagem por faixas\\r\\n    COUNT(CASE WHEN pct_exclusao > 50 THEN 1 END) AS dafs_acima_50pct,\\r\\n    COUNT(CASE WHEN pct_exclusao > 40 THEN 1 END) AS dafs_acima_40pct,\\r\\n    COUNT(CASE WHEN pct_exclusao > 30 THEN 1 END) AS dafs_acima_30pct,\\r\\n    COUNT(CASE WHEN pct_exclusao > 20 THEN 1 END) AS dafs_acima_20pct\\r\\n\\r\\nFROM dafs_pct;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: COMPARA\\u00c7\\u00c3O DE CLASSIFICA\\u00c7\\u00d5ES POR DIFERENTES THRESHOLDS\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'COMPARA\\u00c7\\u00c3O DE THRESHOLDS' AS analise;\", \"\\r\\n\\r\\nWITH dafs_pct AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) AS pct_exclusao\\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n    HAVING COUNT(*) >= 100\\r\\n)\\r\\nSELECT\\r\\n    'Threshold 50%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.5 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.5 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 40%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.4 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.4 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 30%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.3 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.3 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 25%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.25 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.25 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 4: RECOMENDA\\u00c7\\u00c3O DE THRESHOLD IDEAL\\r\\n-- Baseado em an\\u00e1lise estat\\u00edstica (m\\u00e9dia + 1 desvio padr\\u00e3o)\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'RECOMENDA\\u00c7\\u00c3O DE THRESHOLD' AS analise;\", \"\\r\\n\\r\\nWITH dafs_pct AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / NULLIF(COUNT(*), 0), 2) AS pct_exclusao\\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n    HAVING COUNT(*) >= 100\\r\\n)\\r\\nSELECT\\r\\n    ROUND(AVG(pct_exclusao), 2) AS media_pct_exclusao,\\r\\n    ROUND(STDDEV(pct_exclusao), 2) AS desvio_padrao,\\r\\n    ROUND(AVG(pct_exclusao) + STDDEV(pct_exclusao), 2) AS threshold_recomendado_1_desvio,\\r\\n    ROUND(AVG(pct_exclusao) + 0.5 * STDDEV(pct_exclusao), 2) AS threshold_recomendado_meio_desvio,\\r\\n    'Use o threshold_recomendado_1_desvio para capturar outliers (10-15% das DAFs)' AS observacao\\r\\n\\r\\nFROM dafs_pct;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\nWITH dafs_pct AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) AS pct_exclusao\\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n    HAVING COUNT(*) >= 100\\r\\n)\\r\\nSELECT\\r\\n    'Threshold 50%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.5 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.5 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 40%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.4 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.4 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 30%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.3 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.3 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 25%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.25 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.25 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct;\", \"result\": {\"id\": \"79183269-4501-fd18-1df3-938a4c0f5739\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"SGcMh19ZS96IZjoAeq2/nA==\", \"guid\": \"IW3cRTKASmUAAAAAqbzA8g==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"514585997d37d034:743b68738d4d8280\", \"session_id\": 21467, \"session_type\": \"impala\", \"statement_id\": 2, \"has_more_statements\": true, \"statements_count\": 8, \"previous_statement_hash\": \"559221d7c143c61d0e563d8b59f78f17d80886aa4d2365a5dd1bd883\", \"start\": {\"row\": 154, \"column\": 0}, \"end\": {\"row\": 159, \"column\": 60}, \"statement\": \"-- ============================================================================\\n-- PARTE 2: DISTRIBUI\\u00c7\\u00c3O DOS PERCENTUAIS DE EXCLUS\\u00c3O\\n-- Estat\\u00edsticas descritivas para definir threshold ideal\\n-- ============================================================================\\n\\nSELECT 'DISTRIBUI\\u00c7\\u00c3O DE PERCENTUAIS DE EXCLUS\\u00c3O' AS analise\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 2, \"statement_range\": {\"start\": {\"row\": 154, \"column\": 0}, \"end\": {\"row\": 159, \"column\": 60}}, \"statements_count\": 8, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"analise\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-10-13T00:12:22.485Z\", \"endTime\": \"2025-10-13T00:12:22.682Z\", \"executionTime\": 197, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 2, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 6247, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"analise\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"classificacao_atual_threshold_50\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"qtd_empresas_acompanhadas\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": 6304, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760314342269, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- ============================================================================\\r\\n-- AN\\u00c1LISE DETALHADA DE DAFs COM ALTA EXCLUS\\u00c3O\\r\\n-- Detalhamento de scores para ajustar threshold de classifica\\u00e7\\u00e3o\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 1: AN\\u00c1LISE COMPLETA COM TODOS OS SCORES E PERCENTUAIS\\r\\n-- ============================================================================\\r\\n\\r\\nWITH dafs_detalhado AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_acompanhadas,\\r\\n        COUNT(DISTINCT eb.nu_cpf_cnpj_contador) AS qtd_contadores_acompanhados,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\\r\\n        \\r\\n        -- Por Canal de Resolu\\u00e7\\u00e3o\\r\\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\\r\\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\\r\\n        \\r\\n        -- Tempo\\r\\n        AVG(id.dias_na_malha) AS media_dias_malha\\r\\n        \\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    LEFT JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n)\\r\\nSELECT\\r\\n    id_equipe,\\r\\n    qtd_empresas_acompanhadas,\\r\\n    qtd_contadores_acompanhados,\\r\\n    qtd_total_inconsistencias,\\r\\n    ROUND(valor_total_inconsistencias / 1000000, 2) AS valor_total_milhoes,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- DETALHAMENTO POR CANAL DE RESOLU\\u00c7\\u00c3O (QUANTIDADE)\\r\\n    -- ========================================================================\\r\\n    qtd_resolucao_autonoma,\\r\\n    qtd_resolvidas_fiscalizacao,\\r\\n    qtd_excluidas_auditor,\\r\\n    qtd_ativas,\\r\\n    qtd_autuacoes,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- PERCENTUAIS POR CANAL (SCORES DETALHADOS)\\r\\n    -- ========================================================================\\r\\n    ROUND(qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_resolucao_autonoma,\\r\\n    ROUND(qtd_resolvidas_fiscalizacao * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_resolvidas_fiscalizacao,\\r\\n    ROUND(qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_excluidas_auditor,\\r\\n    ROUND(qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_ativas,\\r\\n    ROUND(qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0), 2) AS pct_autuacoes,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- SCORES COMBINADOS PARA AN\\u00c1LISE\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Score de Efetividade (Autonomia + Autua\\u00e7\\u00f5es)\\r\\n    ROUND(\\r\\n        (qtd_resolucao_autonoma * 100.0 / NULLIF(qtd_total_inconsistencias, 0)) +\\r\\n        (qtd_autuacoes * 100.0 / NULLIF(qtd_total_inconsistencias, 0))\\r\\n    , 2) AS score_efetividade,\\r\\n    \\r\\n    -- Score de Problema (Exclus\\u00f5es + Pend\\u00eancias)\\r\\n    ROUND(\\r\\n        (qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0)) +\\r\\n        (qtd_ativas * 100.0 / NULLIF(qtd_total_inconsistencias, 0))\\r\\n    , 2) AS score_problema,\\r\\n    \\r\\n    -- Raz\\u00e3o Exclus\\u00e3o/Autua\\u00e7\\u00e3o (quanto maior, mais suspeito)\\r\\n    ROUND(\\r\\n        qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0)\\r\\n    , 2) AS razao_exclusao_autuacao,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- CLASSIFICA\\u00c7\\u00c3O ATUAL E PROPOSTA\\r\\n    -- ========================================================================\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Atual (threshold 0.5 = 50%)\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.6 \\r\\n             AND qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.3 \\r\\n        THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'BOA'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.5 \\r\\n        THEN 'ALTA_EXCLUSAO'\\r\\n        ELSE 'REGULAR'\\r\\n    END AS classificacao_atual_threshold_50,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Proposta (threshold 0.3 = 30%)\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.6 \\r\\n             AND qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.3 \\r\\n        THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'BOA'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.3 \\r\\n        THEN 'ALTA_EXCLUSAO'\\r\\n        ELSE 'REGULAR'\\r\\n    END AS classificacao_proposta_threshold_30,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Proposta (threshold 0.4 = 40%)\\r\\n    CASE \\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.6 \\r\\n             AND qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) < 0.3 \\r\\n        THEN 'EXCELENTE'\\r\\n        WHEN qtd_resolucao_autonoma * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'BOA'\\r\\n        WHEN qtd_ativas * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.7 \\r\\n        THEN 'ALTA_PENDENCIA'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_total_inconsistencias, 0) > 0.4 \\r\\n        THEN 'ALTA_EXCLUSAO'\\r\\n        ELSE 'REGULAR'\\r\\n    END AS classificacao_proposta_threshold_40,\\r\\n    \\r\\n    -- ========================================================================\\r\\n    -- INDICADORES DE ALERTA\\r\\n    -- ========================================================================\\r\\n    \\r\\n    CASE \\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0) > 5 THEN 'ALERTA_CRITICO'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0) > 3 THEN 'ALERTA_ALTO'\\r\\n        WHEN qtd_excluidas_auditor * 1.0 / NULLIF(qtd_autuacoes, 0) > 2 THEN 'ALERTA_MEDIO'\\r\\n        ELSE 'OK'\\r\\n    END AS alerta_razao_exclusao_autuacao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 60 THEN 'EXCLUSAO_MUITO_ALTA'\\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 50 THEN 'EXCLUSAO_ALTA'\\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 40 THEN 'EXCLUSAO_MODERADA_ALTA'\\r\\n        WHEN qtd_excluidas_auditor * 100.0 / NULLIF(qtd_total_inconsistencias, 0) > 30 THEN 'EXCLUSAO_MODERADA'\\r\\n        ELSE 'EXCLUSAO_NORMAL'\\r\\n    END AS nivel_exclusao,\\r\\n    \\r\\n    -- Tempo m\\u00e9dio\\r\\n    ROUND(media_dias_malha, 2) AS media_dias_malha\\r\\n\\r\\nFROM dafs_detalhado\\r\\n\\r\\n-- Ordenar pelos mais problem\\u00e1ticos (maior % de exclus\\u00e3o)\\r\\nORDER BY pct_excluidas_auditor DESC, qtd_excluidas_auditor DESC;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 2: DISTRIBUI\\u00c7\\u00c3O DOS PERCENTUAIS DE EXCLUS\\u00c3O\\r\\n-- Estat\\u00edsticas descritivas para definir threshold ideal\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'DISTRIBUI\\u00c7\\u00c3O DE PERCENTUAIS DE EXCLUS\\u00c3O' AS analise;\\r\\n\\r\\nWITH dafs_pct AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / NULLIF(COUNT(*), 0), 2) AS pct_exclusao\\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n    HAVING COUNT(*) >= 100\\r\\n)\\r\\nSELECT\\r\\n    COUNT(*) AS total_dafs,\\r\\n    \\r\\n    -- Estat\\u00edsticas descritivas do % de exclus\\u00e3o\\r\\n    ROUND(MIN(pct_exclusao), 2) AS pct_exclusao_minimo,\\r\\n    ROUND(MAX(pct_exclusao), 2) AS pct_exclusao_maximo,\\r\\n    ROUND(AVG(pct_exclusao), 2) AS pct_exclusao_media,\\r\\n    ROUND(STDDEV(pct_exclusao), 2) AS pct_exclusao_desvio_padrao,\\r\\n    \\r\\n    -- Percentis\\r\\n    ROUND(PERCENTILE(pct_exclusao, 0.25), 2) AS pct_exclusao_p25,\\r\\n    ROUND(PERCENTILE(pct_exclusao, 0.50), 2) AS pct_exclusao_mediana,\\r\\n    ROUND(PERCENTILE(pct_exclusao, 0.75), 2) AS pct_exclusao_p75,\\r\\n    ROUND(PERCENTILE(pct_exclusao, 0.90), 2) AS pct_exclusao_p90,\\r\\n    \\r\\n    -- Contagem por faixas\\r\\n    COUNT(CASE WHEN pct_exclusao > 50 THEN 1 END) AS dafs_acima_50pct,\\r\\n    COUNT(CASE WHEN pct_exclusao > 40 THEN 1 END) AS dafs_acima_40pct,\\r\\n    COUNT(CASE WHEN pct_exclusao > 30 THEN 1 END) AS dafs_acima_30pct,\\r\\n    COUNT(CASE WHEN pct_exclusao > 20 THEN 1 END) AS dafs_acima_20pct\\r\\n\\r\\nFROM dafs_pct;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 3: COMPARA\\u00c7\\u00c3O DE CLASSIFICA\\u00c7\\u00d5ES POR DIFERENTES THRESHOLDS\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'COMPARA\\u00c7\\u00c3O DE THRESHOLDS' AS analise;\\r\\n\\r\\nWITH dafs_pct AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 1.0 / NULLIF(COUNT(*), 0) AS pct_exclusao\\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n    HAVING COUNT(*) >= 100\\r\\n)\\r\\nSELECT\\r\\n    'Threshold 50%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.5 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.5 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 40%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.4 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.4 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 30%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.3 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.3 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'Threshold 25%' AS threshold,\\r\\n    COUNT(CASE WHEN pct_exclusao > 0.25 THEN 1 END) AS qtd_classificadas_alta_exclusao,\\r\\n    ROUND(COUNT(CASE WHEN pct_exclusao > 0.25 THEN 1 END) * 100.0 / COUNT(*), 2) AS pct_total_dafs\\r\\nFROM dafs_pct;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- PARTE 4: RECOMENDA\\u00c7\\u00c3O DE THRESHOLD IDEAL\\r\\n-- Baseado em an\\u00e1lise estat\\u00edstica (m\\u00e9dia + 1 desvio padr\\u00e3o)\\r\\n-- ============================================================================\\r\\n\\r\\nSELECT 'RECOMENDA\\u00c7\\u00c3O DE THRESHOLD' AS analise;\\r\\n\\r\\nWITH dafs_pct AS (\\r\\n    SELECT\\r\\n        ed.id_equipe,\\r\\n        COUNT(*) AS qtd_total_inconsistencias,\\r\\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\\r\\n        ROUND(COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) * 100.0 / NULLIF(COUNT(*), 0), 2) AS pct_exclusao\\r\\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\\r\\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\\r\\n    GROUP BY ed.id_equipe\\r\\n    HAVING COUNT(*) >= 100\\r\\n)\\r\\nSELECT\\r\\n    ROUND(AVG(pct_exclusao), 2) AS media_pct_exclusao,\\r\\n    ROUND(STDDEV(pct_exclusao), 2) AS desvio_padrao,\\r\\n    ROUND(AVG(pct_exclusao) + STDDEV(pct_exclusao), 2) AS threshold_recomendado_1_desvio,\\r\\n    ROUND(AVG(pct_exclusao) + 0.5 * STDDEV(pct_exclusao), 2) AS threshold_recomendado_meio_desvio,\\r\\n    'Use o threshold_recomendado_1_desvio para capturar outliers (10-15% das DAFs)' AS observacao\\r\\n\\r\\nFROM dafs_pct;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 269, \"column\": 14}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 654a803245dc6d21:f2c0bca900000000 100% Complete (0 out of 0)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"654a803245dc6d21:f2c0bca900000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=654a803245dc6d21:f2c0bca900000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 654a803245dc6d21:f2c0bca900000000 100% Complete (0 out of 0)\", \"progress\": 100, \"jobs\": [{\"name\": \"654a803245dc6d21:f2c0bca900000000\", \"url\": \"/hue/jobbrowser#!id=654a803245dc6d21:f2c0bca900000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 14117, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 136, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- ANÁLISE DETALHADA DE DAFs COM ALTA EXCLUSÃO\r\n-- Detalhamento de scores para ajustar threshold de classificação\r\n-- ============================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- ============================================================================\r\n-- PARTE 1: ANÁLISE COMPLETA COM TODOS OS SCORES E PERCENTUAIS\r\n-- ============================================================================\r\n\r\nWITH dafs_detalhado AS (\r\n    SELECT\r\n        ed.id_equipe,\r\n        COUNT(DISTINCT id.nu_cnpj) AS qtd_empresas_acompanhadas,\r\n        COUNT(DISTINCT eb.nu_cpf_cnpj_contador) AS qtd_contadores_acompanhados,\r\n        COUNT(*) AS qtd_total_inconsistencias,\r\n        SUM(CASE WHEN id.flag_tem_valor_fiscal = 1 THEN id.vl_inconsistencia ELSE 0 END) AS valor_total_inconsistencias,\r\n        \r\n        -- Por Canal de Resolução\r\n        COUNT(CASE WHEN id.flag_resolucao_autonoma = 1 THEN 1 END) AS qtd_resolucao_autonoma,\r\n        COUNT(CASE WHEN id.canal_resolucao = 'FISCALIZACAO' THEN 1 END) AS qtd_resolvidas_fiscalizacao,\r\n        COUNT(CASE WHEN id.flag_exclusao_auditor = 1 THEN 1 END) AS qtd_excluidas_auditor,\r\n        COUNT(CASE WHEN id.canal_resolucao = 'ATIVA' THEN 1 END) AS qtd_ativas,\r\n        COUNT(CASE WHEN id.flag_gerou_infracao = 1 THEN 1 END) AS qtd_autuacoes,\r\n        \r\n        -- Tempo\r\n        AVG(id.dias_na_malha) AS media_dias_malha\r\n        \r\n    FROM (SELECT DISTINCT id_equipe, nu_cnpj FROM niat.mlh_empresas_base WHERE id_equipe IS NOT NULL) ed\r\n    INNER JOIN niat.mlh_inconsistencias_detalhadas id ON ed.nu_cnpj = id.nu_cnpj\r\n    LEFT JOIN niat.mlh_empresas_base eb ON id.nu_cnpj = eb.nu_cnpj\r\n    GROUP BY ed.id_equipe\r\n)\r\nSELECT\r\n    id_equipe,\r\n    qtd_empresas_acompanhadas,\r\n    qtd_contadores_acompanhados,\r\n    qtd_total_inconsistencias,\r\n    ROUND(valor_total_inconsistencias / 1000000, 2) AS valor_total_milhoes,\r\n    \r\n   ",
    "last_modified": "2025-10-12T21:12:36.003",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a1edcfdb-36e1-4f4d-bc6d-d99e2481e8a0",
      1,
      false
    ],
    "dependencies": []
  }
}
]
